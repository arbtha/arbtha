<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>مرابط</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }
        
        html, body {
            height: 100%;
        }
        
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* شاشة البداية */
        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: url('mainbg.jpg') center/cover no-repeat;
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* خلفيات مخصصة لأجهزة الكمبيوتر وسطح المكتب */
        @media (min-width: 1024px) {
            .start-screen {
                background: url('mainbgpc.jpg') center/cover no-repeat;
            }
        }
        
        .start-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            z-index: 1;
        }
        
        .start-screen > * {
            position: relative;
            z-index: 2;
        }
        
        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .name-input {
            width: 100%;
            max-width: 250px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
            background: rgba(255,255,255,0.9);
        }
        
        .name-input:focus {
            border-color: #667eea;
            background: white;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #218838, #1ea080);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        /* شاشة اللعبة */
        .game-screen {
            display: none;
            height: 100%;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
            padding: 10px;
            box-sizing: border-box;
            /* إضافة خاصية العرض المرن لتسهيل إعادة ترتيب العناصر */
            display: flex;
        }
        
        .game-screen.red-turn {
            background-image: url('redteamturn.jpg');
        }
        
        .game-screen.blue-turn {
            background-image: url('blueteamturn.jpg');
        }
        
        /* خلفيات الفرق المخصصة لأجهزة الكمبيوتر وسطح المكتب */
        @media (min-width: 1024px) {
            .game-screen.red-turn {
                background-image: url('redteamturnpc.jpg');
            }
            
            .game-screen.blue-turn {
                background-image: url('blueteamturnpc.jpg');
            }
        }
        
        /* شريط الأدوات العلوي */
        .toolbar {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0; /* يمنع الشريط من الانكماش */
        }
        
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        
        .toolbar-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .toolbar-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .toolbar-btn:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }
        
        .toolbar-btn.secondary {
            background: #ffc107;
            color: #333;
            border-color: #ffc107;
        }
        
        .toolbar-btn.secondary:hover {
            background: #e0a800;
            border-color: #e0a800;
        }
        
        .toolbar-btn.info {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }
        
        .toolbar-btn.info:hover {
            background: #138496;
            border-color: #138496;
        }
        
        .player-name-btn {
            background: #f8f9fa;
            border: 2px solid #28a745;
            color: #333;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .player-name-btn:hover {
            background: #e8f5e8;
            transform: translateY(-1px);
        }
        
        /* منطقة اللعب الرئيسية */
        /* تم إزالة .game-area لأن .game-screen هو الحاوي الرئيسي الآن */
        
        /* حاوي البطاقات */
        .cards-container {
            flex: 1; /* يسمح للحاوية بالنمو لملء المساحة المتبقية */
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        
        /* شبكة البطاقات */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            height: 100%;
            width: 100%;
            padding: 0;
            overflow: hidden;
            aspect-ratio: 5/3.33; /* نسبة تتناسب مع أبعاد الصور 600×400 */
        }
        
        .card {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: clamp(0.4rem, 1.5vw, 0.8rem);
            font-weight: bold;
            text-align: center;
            padding: 2px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            color: #000000;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            aspect-ratio: 3/2; /* نسبة 600:400 = 3:2 لكل بطاقة */
        }
        
        /* تحسينات لسطح المكتب */
        @media (min-width: 1024px) {
            .container {
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                height: 100vh;
                padding: 8px;
                overflow: hidden;
            }
            
            .toolbar {
                padding: 8px;
                margin-bottom: 8px;
                font-size: 0.85rem;
            }
            
            .cards-container {
                flex: 1;
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                padding: 10px;
                margin-bottom: 10px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .cards-grid {
                height: 100%;
                width: 100%;
                padding: 0;
                gap: 4px;
                overflow: hidden;
            }
            
            .card {
                font-size: clamp(0.5rem, 1.2vw, 0.9rem);
                padding: 2px;
            }
            
            /* تم تحديث المنطقة السفلية لاستيعاب الفرق فقط */
            .teams-bottom-area {
                height: 140px;
                flex-shrink: 0;
            }
            
            .team-panel, .log-panel {
                padding: 8px;
                font-size: 0.85rem;
            }
            
            .hint-display-area {
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .hint-area {
                padding: 6px;
            }
            
            .end-turn-area {
                padding: 6px;
                margin-bottom: 6px;
            }
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .card.revealed {
            color: white;
        }
        
        .card.red {
            background: #dc3545;
        }
        
        .card.blue {
            background: #007bff;
        }
        
        .card.black {
            background: #343a40;
        }
        
        .card.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view {
            color: white;
            font-weight: bold;
        }
        
        .card.spy-view.red {
            background: url('REDSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.blue {
            background: url('BLUESPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.black {
            background: url('BLACKSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.neutral {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
        }
        
        .card.revealed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            z-index: 10;
        }
        
        .revealed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            z-index: 10;
        }
        
        .hand-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }
        
        .card.can-select .hand-btn {
            display: block;
        }
        
        .voters {
            font-size: 0.6rem;
            margin-top: 2px;
            align-self: stretch;
            text-align: center;
        }
        
        .voter {
            display: inline-block;
            margin: 2px;
            padding: 2px 5px;
            border-radius: 5px;
            color: white;
        }
        
        .voter.red {
            background: #dc3545;
        }
        
        .voter.blue {
            background: #007bff;
        }
        
        /* منطقة الفرق */
        /* تم استبدال .bottom-area بـ .teams-bottom-area ليضم الفرق فقط */
        .teams-bottom-area {
            display: flex;
            gap: 5px;
            height: 180px; /* لتقليل الارتفاع في الشاشات الصغيرة */
            flex-shrink: 0;
        }
        
        @media (min-width: 1024px) {
            .teams-bottom-area {
                height: 140px;
            }
        }

        /* تنسيق الألواح */
        .team-panel {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .team-panel.red {
            border-top: 4px solid #dc3545;
        }
        
        .team-panel.blue {
            border-top: 4px solid #007bff;
        }
        
        .team-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .team-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }
        
        .player-item {
            background: #f8f9fa;
            padding: 5px 8px;
            margin: 3px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            width: fit-content;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .player-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        /* سجل الأحداث - تم تعديله ليصبح في صف خاص */
        .log-panel {
            flex-shrink: 0;
            background: rgba(240,240,240,0.95);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 8px; /* إضافة هامش لفصلها عن الفرق */
        }

        .log-panel #gameLog {
            max-height: 80px; /* تحديد ارتفاع أقصى للسجل على الهواتف */
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
             .log-panel #gameLog {
                max-height: 100px; /* زيادة الارتفاع على الشاشات الكبيرة */
            }
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .log-entry {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 4px solid #ddd;
        }
        
        .log-entry.red {
            border-left-color: #dc3545;
        }
        
        .log-entry.blue {
            border-left-color: #007bff;
        }
        
        /* منطقة التلميح */
        .hint-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: none;
            flex-shrink: 0;
        }
        
        .hint-area.active {
            display: block;
        }
        
        .hint-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .hint-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .number-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background: white;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .number-select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .send-hint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .end-turn-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 6px;
            font-size: 0.9rem;
        }

        .end-turn-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* منطقة عرض التلميح الجديدة */
        .hint-display-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        .hint-display-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .hint-box, .number-box {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 80px;
        }
        
        .hint-label, .number-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .hint-text, .number-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }
        
        /* حالة اللعبة */
        .game-status {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .current-hint {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* القوائم المنسدلة */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: white;
            min-width: 280px;
            max-width: 90vw;
            width: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 10px;
            border: 2px solid #ddd;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .dropdown-content {
                min-width: 260px;
                max-width: 95vw;
                max-height: 60vh;
                font-size: 0.9rem;
            }
            
            .dropdown-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .dropdown-info {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .dropdown-link {
                font-size: 0.7rem;
                word-break: break-all;
            }
            
            .hint-display-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .hint-box, .number-box {
                min-width: 100px;
            }

            /* تقليل ارتفاع منطقة الفرق في شاشات الجوال */
            .teams-bottom-area {
                height: 160px;
                flex-shrink: 0;
            }
        }
        
        .dropdown-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #333;
            text-align: center;
        }
        
        .dropdown-section {
            margin-bottom: 15px;
        }
        
        .dropdown-section-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }
        
        .dropdown-item.red {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .dropdown-item.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .dropdown-item.no-team {
            background: #fff3e0;
            border-color: #ffcc02;
        }
        
        .dropdown-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 3px;
            transition: background 0.2s;
        }
        
        .dropdown-button:hover {
            background: #0056b3;
        }
        
        .dropdown-button.danger {
            background: #dc3545;
        }
        
        .dropdown-button.danger:hover {
            background: #c82333;
        }
        
        .dropdown-button.success {
            background: #28a745;
        }
        
        .dropdown-button.success:hover {
            background: #218838;
        }
        
        .dropdown-button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .dropdown-button.warning:hover {
            background: #e0a800;
        }
        
        .dropdown-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .dropdown-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            word-break: break-all;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .player-role {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            margin-right: 5px;
        }
        
        .player-role.spy {
            background: #ffc107;
            color: #333;
        }
        
        .player-role.creator {
            background: #17a2b8;
        }
        
        /* نافذة تأكيد الطرد */
        .kick-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .kick-dialog.show {
            display: flex;
        }
        
        .kick-dialog-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .kick-dialog-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }
        
        .kick-dialog-message {
            font-size: 1rem;
            margin-bottom: 25px;
            color: #666;
            line-height: 1.5;
        }
        
        .kick-dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .kick-dialog-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .kick-dialog-btn.confirm {
            background: #dc3545;
            color: white;
        }
        
        .kick-dialog-btn.confirm:hover {
            background: #c82333;
        }
        
        .kick-dialog-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .kick-dialog-btn.cancel:hover {
            background: #5a6268;
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .cards-container {
                flex: 1;
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .cards-grid {
                gap: 2px;
                height: 100%;
                width: 100%;
                overflow: hidden;
            }
            
            .card {
                font-size: clamp(0.3rem, 2.5vw, 0.6rem);
                padding: 1px;
            }
            
            .toolbar {
                font-size: 0.75rem;
                padding: 6px;
            }
            
            .dropdown-content {
                min-width: 280px;
                max-width: 90vw;
                left: 0;
                right: auto;
            }
            
            .container {
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                padding: 4px;
                height: 100vh;
                overflow: hidden;
            }
            
            .team-panel, .log-panel {
                padding: 6px;
                font-size: 0.8rem;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* تأثيرات اختيار الفريق */
        .team-choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .team-choice:active {
            transform: translateY(-1px);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><div class="start-screen" id="startScreen"><input type="text" class="name-input" id="playerName" placeholder="أدخل اسمك" maxlength="20"> <button class="start-btn" id="startGameButton" onclick="startGame()">إنشاء غرفة</button>
   </div><div class="game-screen" id="gameScreen"><div class="toolbar">
     <div class="dropdown">
      <div class="player-name-btn" id="playerNameBtn" onclick="togglePlayerDropdown()"><span id="currentPlayerName"></span>
      </div>
      <div class="dropdown-content" id="playerDropdown">
       <div class="dropdown-header">
        خيارات اللاعب
       </div>
       <div id="playerDropdownContent"></div>
      </div>
     </div>
     <div class="dropdown"><button class="toolbar-btn" onclick="toggleResetDropdown()">إعادة تشغيل</button>
      <div class="dropdown-content" id="resetDropdown">
       <div class="dropdown-header">
        إعادة تشغيل اللعبة
       </div>
       <div id="resetDropdownContent"></div>
      </div>
     </div>
     <button class="toolbar-btn info" onclick="copyRoomLink()">نسخ الرابط</button>
     
     <button class="toolbar-btn success" onclick="startGamePlay()" id="startGameBtn" style="display: none;">بدء اللعبة</button>
     <div class="dropdown">
      <div class="toolbar-item" id="playersCount" onclick="togglePlayersDropdown()">
       👥 <span id="playerCountNum">0</span>
      </div>
      <div class="dropdown-content" id="playersDropdown">
       <div class="dropdown-header">
        إدارة اللاعبين
       </div>
       <div id="playersDropdownContent"></div>
      </div>
     </div>
    </div>
    
    <div class="current-hint hidden" id="currentHint"></div>
    
    <div class="hint-display-area" id="hintDisplayArea" style="display: none;">
     <div class="hint-display-container">
      <div class="hint-box">
       <div class="hint-label">
        التلميح:
       </div>
       <div class="hint-text" id="displayHintText">
        -
       </div>
      </div>
      <div class="number-box">
       <div class="number-label">
        العدد:
       </div>
       <div class="number-text" id="displayHintNumber">
        -
       </div>
      </div>
     </div>
    </div>
    
    <div class="hint-area" id="hintArea"><input type="text" class="hint-input" id="hintInput" placeholder="اكتب تلميحك هنا...">
     <div class="hint-controls"><span>عدد الكلمات:</span> <select id="numberSelect" class="number-select"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> </select> <button class="send-hint-btn" onclick="sendHint()">إرسال التلميح</button>
     </div>
    </div>
    
    <div class="end-turn-area" id="endTurnArea" style="display: none;"><button class="end-turn-btn" onclick="endTurn()">إنهاء الدور</button>
    </div>

    <div class="cards-container">
     <div class="cards-grid" id="cardsGrid"></div>
    </div>
    
    <div class="log-panel" id="logPanel" style="flex-shrink: 0; margin-bottom: 8px;">
        <div class="log-title"> سجل الأحداث </div>
        <div id="gameLog"></div>
    </div>

    <div class="teams-bottom-area" style="display: flex; gap: 5px; height: 160px; flex-shrink: 0;">
        <div class="team-panel red" style="flex: 1;">
         <div class="team-title" style="color: #dc3545;"> الفريق الأحمر <span id="redScore">9</span>
         </div>
         <div class="team-section">
          <div class="section-title"> اللاعبين: </div>
          <div id="redPlayers"></div>
         </div>
         <div class="team-section">
          <div class="section-title"> السباي: </div>
          <div id="redSpies"></div>
         </div>
        </div>
        <div class="team-panel blue" style="flex: 1;">
         <div class="team-title" style="color: #007bff;"> الفريق الأزرق <span id="blueScore">8</span>
         </div>
         <div class="team-section">
          <div class="section-title"> اللاعبين: </div>
          <div id="bluePlayers"></div>
         </div>
         <div class="team-section">
          <div class="section-title"> السباي: </div>
          <div id="blueSpies"></div>
         </div>
        </div>
    </div>
    
   </div><div class="kick-dialog" id="kickDialog">
    <div class="kick-dialog-content">
     <div class="kick-dialog-title">
      ⚠️ تأكيد الطرد
     </div>
     <div class="kick-dialog-message" id="kickDialogMessage"></div>
     <div class="kick-dialog-buttons"><button class="kick-dialog-btn confirm" onclick="confirmKick()">طرد</button> <button class="kick-dialog-btn cancel" onclick="cancelKick()">إلغاء</button>
     </div>
    </div>
   </div>
  </div>
  <script>
 // إعداد Firebase
 const firebaseConfig = {
  apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
  authDomain: "game-303eb.firebaseapp.com",
  databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
  projectId: "game-303eb",
  storageBucket: "game-303eb.firebasestorage.app",
  messagingSenderId: "22261863844",
  appId: "1:22261863844:web:66f8541079b9025ec69d31",
  measurementId: "G-RKN2F3HVHS"
 };

 // متغيرات عامة
 let database;
 let isFirebaseReady = false;
 let connectionAttempts = 0;
 const maxConnectionAttempts = 3;
 let showingColors = false;
 let roomCleanupInterval;

 // إظهار حالة الاتصال للمستخدم
 function showConnectionStatus(message, isError = false) {
  // إظهار رسائل الخطأ فقط
  if (isError) {
   const startBtn = document.querySelector('.start-btn');
   if (startBtn) {
    startBtn.textContent = message;
    startBtn.style.background = '#dc3545';
   }
  }
 }

 // تهيئة Firebase مع تشخيص مفصل
 function initializeFirebase() {
  console.log('🔄 بدء تهيئة Firebase...');
  try {
   if (typeof firebase === 'undefined') {
    throw new Error('Firebase SDK غير محمل');
   }
   if (!firebase.apps.length) {
    console.log('📱 تهيئة تطبيق Firebase...');
    firebase.initializeApp(firebaseConfig);
   } else {
    console.log('📱 Firebase مهيأ مسبقاً');
   }
   database = firebase.database();
   console.log('💾 تم الحصول على مرجع قاعدة البيانات');
   console.log('🔍 اختبار الاتصال...');
   const testRef = database.ref('test');
   const testData = {
    timestamp: Date.now(),
    test: true
   };
   testRef.set(testData).then(() => {
    console.log('✅ اختبار الكتابة نجح');
    return testRef.once('value');
   }).then((snapshot) => {
    console.log('✅ اختبار القراءة نجح:', snapshot.val());
    testRef.remove();
    isFirebaseReady = true;
    console.log('🎉 Firebase جاهز للاستخدام!');
    setupConnectionMonitoring();
    startRoomCleanup();
   }).catch((error) => {
    console.error('❌ فشل اختبار Firebase:', error);
    handleConnectionError(error);
   });
  } catch (error) {
   console.error('❌ خطأ في تهيئة Firebase:', error);
   handleConnectionError(error);
  }
 }

 // إعداد مراقبة الاتصال
 function setupConnectionMonitoring() {
  const connectedRef = database.ref('.info/connected');
  connectedRef.on('value', (snapshot) => {
   if (snapshot.val() === true) {
    console.log('🟢 متصل بـ Firebase');
    isFirebaseReady = true;
    updatePlayerOnlineStatus(true);
   } else {
    console.log('🔴 منقطع عن Firebase');
    isFirebaseReady = false;
   }
  });
 }

 // تحديث حالة اللاعب عند تغيير الاتصال
 function updatePlayerOnlineStatus(isOnline) {
  if (database && roomId && currentPlayer) {
   database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(isOnline);
  }
 }

 // بدء تنظيف الغرف غير النشطة
 function startRoomCleanup() {
  if (roomCleanupInterval) {
   clearInterval(roomCleanupInterval);
  }
  roomCleanupInterval = setInterval(() => {
   cleanupInactiveRooms();
  }, 10 * 60 * 1000); // كل 10 دقائق
 }

 // تنظيف الغرف غير النشطة
 function cleanupInactiveRooms() {
  if (!database) return;
  const roomsRef = database.ref('rooms');
  roomsRef.once('value', (snapshot) => {
   if (!snapshot.exists()) return;
   const rooms = snapshot.val();
   const now = Date.now();
   const oneHour = 60 * 60 * 1000;
   Object.keys(rooms).forEach(roomId => {
    const room = rooms[roomId];
    if (!room.players) {
     // حذف الغرف بدون لاعبين
     database.ref(`rooms/${roomId}`).remove();
     return;
    }
    const players = Object.values(room.players);
    const hasOnlinePlayers = players.some(p => p.online);
    if (!hasOnlinePlayers) {
     // التحقق من آخر نشاط
     const lastActivity = room.lastActivity || 0;
     if (now - lastActivity > oneHour) {
      console.log(`🗑️ حذف الغرفة غير النشطة: ${roomId}`);
      database.ref(`rooms/${roomId}`).remove();
     }
    } else {
     // تحديث آخر نشاط للغرف النشطة
     database.ref(`rooms/${roomId}/lastActivity`).set(now);
    }
   });
  });
 }

 // معالجة أخطاء الاتصال
 function handleConnectionError(error) {
  console.error('تفاصيل الخطأ:', {
   code: error.code,
   message: error.message,
   stack: error.stack
  });
  let errorMessage = 'خطأ في الاتصال';
  if (error.code === 'PERMISSION_DENIED') {
   errorMessage = 'ليس لديك صلاحية';
   console.error('🚫 مشكلة في الصلاحيات - تحقق من قواعد Firebase');
  } else if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
   errorMessage = 'مشكلة في الشبكة';
   console.error('🌐 مشكلة في الشبكة');
  } else if (error.message.includes('Firebase SDK')) {
   errorMessage = 'مشكلة في التحميل';
   console.error('📦 مشكلة في تحميل Firebase SDK');
  }
  showConnectionStatus(errorMessage, true);
  isFirebaseReady = false;
  if (connectionAttempts < maxConnectionAttempts) {
   connectionAttempts++;
   console.log(`🔄 محاولة إعادة الاتصال ${connectionAttempts}/${maxConnectionAttempts}`);
   setTimeout(() => {
    initializeFirebase();
   }, 3000 * connectionAttempts);
  } else {
   console.error('❌ فشل في جميع محاولات الاتصال');
   showConnectionStatus('فشل الاتصال نهائياً', true);
  }
 }

 // بدء تهيئة Firebase عند تحميل الصفحة
 document.addEventListener('DOMContentLoaded', () => {
  console.log('📄 تم تحميل الصفحة، بدء تهيئة Firebase...');
  initializeFirebase();
 });

 // متغيرات اللعبة
 let currentPlayer = null;
 let roomId = null;
 let gameState = null;
 let cardsVisible = false;

 // كلمات اللعبة مع خلط متقدم
 const gameWords = [
  'شمس', 'قمر', 'نجم', 'بحر', 'جبل', 'شجر', 'زهر', 'طير', 'سمك', 'أسد', 'فيل', 'حصان', 'كتاب', 'قلم', 'ورق', 'باب', 'نافذة', 'كرسي', 'طاولة', 'سرير', 'ماء', 'نار', 'هواء', 'تراب', 'ذهب', 'فضة', 'حديد', 'خشب', 'حجر', 'زجاج', 'سيارة', 'طائرة', 'قطار', 'سفينة', 'دراجة', 'حاسوب', 'هاتف', 'تلفاز', 'راديو', 'ساعة', 'مدرسة', 'بيت', 'مستشفى', 'مطعم', 'حديقة', 'شارع', 'مدينة', 'قرية', 'صحراء', 'غابة', 'عين', 'أذن', 'فم', 'يد', 'قدم', 'رأس', 'قلب', 'عقل', 'روح', 'جسم', 'أب', 'أم', 'ابن', 'بنت', 'أخ', 'أخت', 'جد', 'جدة', 'عم', 'خال', 'صديق', 'معلم', 'طبيب', 'مهندس', 'فنان', 'كاتب', 'شاعر', 'مغني', 'راقص', 'لاعب'
 ];

 // خلط متقدم للكلمات لضمان عدم التكرار
 function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
   const j = Math.floor(Math.random() * (i + 1));
   [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
 }

 // بدء اللعبة
 function startGame() {
  const name = document.getElementById('playerName').value.trim();
  if (!name) {
   alert('يرجى إدخال اسمك');
   return;
  }
  console.log('🎮 محاولة بدء اللعبة...');
  console.log('📊 حالة Firebase:', {
   isFirebaseReady,
   database: !!database
  });
  const startBtn = document.querySelector('.start-btn');
  if (!isFirebaseReady || !database) {
   console.log('⏳ Firebase غير جاهز، محاولة إعادة الاتصال...');
   initializeFirebase();
   let attempts = 0;
   const maxAttempts = 15;
   const checkConnection = setInterval(() => {
    attempts++;
    console.log(`🔄 فحص الاتصال ${attempts}/${maxAttempts}`);
    if (isFirebaseReady && database) {
     clearInterval(checkConnection);
     console.log('✅ Firebase جاهز، بدء اللعبة...');
     proceedWithGame(name);
    } else if (attempts >= maxAttempts) {
     clearInterval(checkConnection);
     console.error('❌ انتهت مهلة الانتظار');
     showConnectionStatus('فشل الاتصال', true);
     const errorDetails = ` حدثت مشكلة في الاتصال: 🔍 تشخيص المشكلة: - Firebase SDK: ${typeof firebase !== 'undefined' ? '✅ محمل' : '❌ غير محمل'} - قاعدة البيانات: ${database ? '✅ متاحة' : '❌ غير متاحة'} - حالة الاتصال: ${isFirebaseReady ? '✅ متصل' : '❌ غير متصل'} 💡 الحلول المقترحة: 1. تحقق من اتصالك بالإنترنت 2. أعد تحميل الصفحة 3. جرب متصفح آخر 4. تأكد من أن Firebase مُعد بشكل صحيح `;
     alert(errorDetails);
    }
   }, 1000);
   return;
  }
  console.log('✅ Firebase جاهز، بدء اللعبة مباشرة...');
  proceedWithGame(name);
 }

 // متابعة بدء اللعبة بعد التأكد من الاتصال
 function proceedWithGame(name) {
  localStorage.setItem('playerName', name);
  currentPlayer = {
   id: generateId(),
   name: name,
   online: true,
   team: null,
   role: 'player'
  };
  const roomFromUrl = getRoomIdFromUrl();
  if (roomFromUrl) {
   // الخروج من الغرف القديمة عند دخول رابط جديد
   leaveOldRoomsBeforeJoining();
   roomId = roomFromUrl;
   console.log('Joining existing room from URL:', roomId);
   joinExistingRoomDirectly();
  } else {
   roomId = generateRoomId();
   console.log('Creating new room:', roomId);
   joinRoom();
  }
  savePlayerState();
  console.log('Starting game with room ID:', roomId);
  console.log('Player:', currentPlayer);
  console.log('Database ready:', !!database);
  console.log('Firebase ready:', isFirebaseReady);
 }

 // الخروج من الغرف القديمة قبل الانضمام لغرفة جديدة
 function leaveOldRoomsBeforeJoining() {
  const savedState = loadPlayerState();
  if (savedState && savedState.roomId && savedState.roomId !== roomId) {
   console.log('🚪 الخروج من الغرفة القديمة:', savedState.roomId);
   database.ref(`rooms/${savedState.roomId}/players/${savedState.player.id}`).remove();
   localStorage.removeItem('gameState');
  }
 }

 // إنشاء معرف فريد
 function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
 }

 // إنشاء معرف الغرفة
 function generateRoomId() {
  return Math.random().toString(36).substr(2, 8);
 }

 // الحصول على معرف الغرفة من الرابط
 function getRoomIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('room');
 }

 // تحديث نص زر البداية حسب الحالة
 function updateStartButtonText() {
  const startButton = document.getElementById('startGameButton');
  const roomFromUrl = getRoomIdFromUrl();
  if (roomFromUrl) {
   startButton.textContent = 'الدخول للغرفة';
  } else {
   startButton.textContent = 'إنشاء غرفة';
  }
 }

 // الانضمام للغرفة
 function joinRoom() {
  console.log('Joining room:', roomId);
  if (!database) {
   console.error('Database not initialized');
   alert('قاعدة البيانات غير جاهزة، يرجى إعادة المحاولة');
   return;
  }
  const roomRef = database.ref(`rooms/${roomId}`);
  const timeoutId = setTimeout(() => {
   console.error('Room join timeout');
   alert('انتهت مهلة الاتصال. يرجى المحاولة مرة أخرى.');
  }, 15000);
  roomRef.once('value', (snapshot) => {
   clearTimeout(timeoutId);
   console.log('Room snapshot exists:', snapshot.exists());
   console.log('Room data:', snapshot.val());
   if (!snapshot.exists()) {
    console.log('Creating new room');
    createNewRoom();
   } else {
    console.log('Joining existing room');
    joinExistingRoom();
   }
  }).catch((error) => {
   clearTimeout(timeoutId);
   console.error('Error joining room:', error);
   console.error('Error details:', {
    code: error.code,
    message: error.message,
    details: error.details
   });
   if (error.code === 'PERMISSION_DENIED') {
    alert('ليس لديك صلاحية للوصول إلى قاعدة البيانات. يرجى التحقق من إعدادات Firebase.');
   } else if (error.code === 'NETWORK_ERROR') {
    alert('خطأ في الشبكة. يرجى التحقق من الاتصال بالإنترنت.');
   } else {
    alert('حدث خطأ في الاتصال بقاعدة البيانات: ' + error.message);
   }
  });
 }

 // إنشاء غرفة جديدة
 function createNewRoom() {
  console.log('Creating new room with ID:', roomId);
  const shuffledWords = shuffleArray(gameWords);
  const cards = generateCards(shuffledWords);
  const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
  const initialState = {
   cards: cards,
   players: {},
   state: 'setup', // setup, playing, ended
   turn: firstTurn,
   score: {
    red: 8,
    blue: 8
   }, // 8 for blue, 9 for red or vice versa depending on who starts
   hint: {
    word: '',
    number: 0,
    team: '',
    guesses: 0
   },
   log: [],
   createdAt: Date.now(),
   lastActivity: Date.now(),
   winner: null,
   creatorId: currentPlayer.id,
   currentTurnAttempts: 0
  };
  if (firstTurn === 'red') {
   initialState.score.red = 9;
   initialState.score.blue = 8;
  } else {
   initialState.score.red = 8;
   initialState.score.blue = 9;
  }
  database.ref(`rooms/${roomId}`).set(initialState).then(() => {
   console.log('✅ Room created successfully');
   addPlayerToRoom(true);
   setupRoomListeners();
   window.history.pushState({}, '', `?room=${roomId}`);
  }).catch(error => {
   console.error('❌ Error creating room:', error);
   alert('فشل إنشاء الغرفة: ' + error.message);
  });
 }

 // الانضمام إلى غرفة موجودة
 function joinExistingRoom() {
  console.log('Joining existing room');
  database.ref(`rooms/${roomId}`).once('value').then(snapshot => {
   if (!snapshot.exists()) {
    alert('الغرفة غير موجودة');
    window.location.href = window.location.origin + window.location.pathname;
    return;
   }
   const roomData = snapshot.val();
   if (roomData.state === 'playing') {
    // يمكن الانضمام للعبة جارية ولكن كـ spectator مبدئياً
    addPlayerToRoom(false);
   } else {
    addPlayerToRoom(false);
   }
   setupRoomListeners();
  }).catch(error => {
   console.error('Error joining existing room:', error);
   alert('فشل الانضمام للغرفة: ' + error.message);
  });
 }

 // الانضمام لغرفة موجودة مباشرة من الرابط
 function joinExistingRoomDirectly() {
  console.log('Attempting to join existing room directly');
  database.ref(`rooms/${roomId}`).once('value').then(snapshot => {
   if (!snapshot.exists()) {
    alert('الغرفة غير موجودة. سيتم إنشاء غرفة جديدة.');
    // إعادة تعيين معرف الغرفة لإنشاء غرفة جديدة
    roomId = generateRoomId();
    window.history.pushState({}, '', window.location.pathname);
    createNewRoom();
    return;
   }
   addPlayerToRoom(false);
   setupRoomListeners();
  }).catch(error => {
   console.error('Error joining existing room directly:', error);
   alert('فشل الانضمام للغرفة: ' + error.message);
   window.history.pushState({}, '', window.location.pathname);
  });
 }

 // إضافة اللاعب للغرفة
 function addPlayerToRoom(isCreator) {
  if (isCreator) {
   currentPlayer.role = 'creator';
  } else {
   // محاولة استعادة الحالة السابقة
   const savedState = loadPlayerState();
   if (savedState && savedState.roomId === roomId && savedState.player.role) {
    currentPlayer.role = savedState.player.role;
    currentPlayer.team = savedState.player.team;
   }
  }

  // إضافة اللاعب إلى قاعدة البيانات
  const playerRef = database.ref(`rooms/${roomId}/players/${currentPlayer.id}`);
  playerRef.set(currentPlayer).then(() => {
   console.log('✅ Player added to room');
   // عند انقطاع الاتصال، قم بتعيين حالة online إلى false
   playerRef.onDisconnect().update({
    online: false
   });
  }).catch(error => {
   console.error('❌ Error adding player:', error);
  });
 }

 // حذف اللاعب من الغرفة
 function removePlayerFromRoom(playerId) {
  if (!database || !roomId) return;
  database.ref(`rooms/${roomId}/players/${playerId}`).remove().then(() => {
   console.log(`✅ Player ${playerId} removed`);
  }).catch(error => {
   console.error('❌ Error removing player:', error);
  });
 }

 // إنشاء البطاقات
 function generateCards(shuffledWords) {
  const numRed = 9;
  const numBlue = 8;
  const numBlack = 1;
  const numNeutral = 7;
  const totalCards = 25;

  const cards = [];
  let index = 0;

  // تعيين الألوان
  for (let i = 0; i < numRed; i++) cards.push({
   word: shuffledWords[index++],
   color: 'red',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numBlue; i++) cards.push({
   word: shuffledWords[index++],
   color: 'blue',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numBlack; i++) cards.push({
   word: shuffledWords[index++],
   color: 'black',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numNeutral; i++) cards.push({
   word: shuffledWords[index++],
   color: 'neutral',
   revealed: false,
   voters: {}
  });

  // خلط البطاقات
  shuffleArray(cards);

  // إضافة فهرس
  return cards.map((card, idx) => ({ ...card,
   id: idx
  }));
 }

 // إعداد المستمعين للغرفة
 function setupRoomListeners() {
  console.log('Setting up room listeners for room:', roomId);
  const roomRef = database.ref(`rooms/${roomId}`);

  roomRef.on('value', (snapshot) => {
   const data = snapshot.val();
   if (data) {
    gameState = data;
    renderGame();
   } else {
    // الغرفة لم تعد موجودة
    alert('الغرفة لم تعد موجودة');
    window.location.href = window.location.origin + window.location.pathname;
   }
  }, (error) => {
   console.error('Error listening to room:', error);
  });
 }

 // حفظ حالة اللاعب في الذاكرة المحلية
 function savePlayerState() {
  const state = {
   roomId: roomId,
   player: currentPlayer
  };
  localStorage.setItem('gameState', JSON.stringify(state));
 }

 // تحميل حالة اللاعب من الذاكرة المحلية
 function loadPlayerState() {
  const state = localStorage.getItem('gameState');
  return state ? JSON.parse(state) : null;
 }

 // عرض اللعبة
 function renderGame() {
  // تحديث حالة الشاشة
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'flex';
  
  // تحديث حالة اللاعب الحالي
  const players = Object.values(gameState.players || {});
  const self = players.find(p => p.id === currentPlayer.id);
  if (self) {
   currentPlayer = self;
   savePlayerState(); // تحديث الحالة المحلية
  } else {
   // إذا لم يعد اللاعب موجوداً في الغرفة (تم طرده أو حذف الغرفة)
   if (gameState.players && !gameState.players[currentPlayer.id]) {
        alert('لقد تم طردك من الغرفة أو انتهت صلاحية الغرفة.');
        window.location.href = window.location.origin + window.location.pathname;
        return;
   }
  }

  // تحديث اسم اللاعب في شريط الأدوات
  document.getElementById('currentPlayerName').textContent = currentPlayer.name;

  // تحديث حالة اللعبة (درو اللاعبين)
  updatePlayersPanel();

  // تحديث شريط الأدوات بناءً على الدور
  updateToolbar();

  // تحديث شبكة البطاقات
  updateCardsGrid();
  
  // تحديث السجل
  updateGameLog();

  // تحديث النقاط
  updateScores();
  
  // تحديث التلميح
  updateHintArea();
  
  // التحقق من نهاية اللعبة
  checkGameEnd();
 }

 // تحديث لوحة اللاعبين
 function updatePlayersPanel() {
    const players = Object.values(gameState.players || {});
    const redPlayersDiv = document.getElementById('redPlayers');
    const bluePlayersDiv = document.getElementById('bluePlayers');
    const noTeamPlayersDiv = document.getElementById('playersDropdownContent');
    const redSpiesDiv = document.getElementById('redSpies');
    const blueSpiesDiv = document.getElementById('blueSpies');
    
    // تنظيف الأقسام
    redPlayersDiv.innerHTML = '';
    bluePlayersDiv.innerHTML = '';
    noTeamPlayersDiv.innerHTML = '';
    redSpiesDiv.innerHTML = '';
    blueSpiesDiv.innerHTML = '';
    
    let allPlayersList = '';
    
    // تجميع اللاعبين
    const redPlayers = players.filter(p => p.team === 'red' && p.role !== 'spy');
    const bluePlayers = players.filter(p => p.team === 'blue' && p.role !== 'spy');
    const redSpies = players.filter(p => p.team === 'red' && p.role === 'spy');
    const blueSpies = players.filter(p => p.team === 'blue' && p.role === 'spy');
    const noTeamPlayers = players.filter(p => !p.team);
    
    // عرض قائمة اللاعبين في الفرق
    [...redPlayers, ...redSpies].forEach(p => {
        const item = createPlayerItem(p, redPlayersDiv);
        redPlayersDiv.appendChild(item);
    });
    
    [...bluePlayers, ...blueSpies].forEach(p => {
        const item = createPlayerItem(p, bluePlayersDiv);
        bluePlayersDiv.appendChild(item);
    });

    // عرض قائمة السباي في أقسام مخصصة
    redSpies.forEach(p => {
        const item = createPlayerItem(p, redSpiesDiv);
        redSpiesDiv.appendChild(item);
    });

    blueSpies.forEach(p => {
        const item = createPlayerItem(p, blueSpiesDiv);
        blueSpiesDiv.appendChild(item);
    });

    // عرض قائمة اللاعبين بدون فريق في القائمة المنسدلة
    players.forEach(p => {
        allPlayersList += createDropdownPlayerItem(p);
    });
    noTeamPlayersDiv.innerHTML = allPlayersList;
    
    // تحديث عدد اللاعبين
    document.getElementById('playerCountNum').textContent = players.length;
 }

 // إنشاء عنصر لاعب
 function createPlayerItem(player, parentDiv) {
     const playerEl = document.createElement('div');
     playerEl.className = `player-item ${player.online ? 'online' : 'offline'} ${player.team || 'no-team'}`;
     
     let roleText = '';
     if (player.role === 'creator') {
         roleText = '<span class="player-role creator">المنشئ</span>';
     } else if (player.role === 'spy') {
         roleText = '<span class="player-role spy">السباي</span>';
     }
     
     let kickButton = '';
     if (currentPlayer.role === 'creator' && player.id !== currentPlayer.id) {
         kickButton = `<button class="kick-btn" onclick="showKickDialog('${player.id}', '${player.name}')">طرد</button>`;
     }
     
     playerEl.innerHTML = `
         <div style="display: flex; align-items: center;">
             ${player.name}
             ${roleText}
             <span class="status-indicator ${player.online ? 'online' : 'offline'}" title="${player.online ? 'متصل' : 'غير متصل'}"></span>
         </div>
         ${kickButton}
     `;

     return playerEl;
 }

 // إنشاء عنصر لاعب في القائمة المنسدلة لإدارة اللاعبين
 function createDropdownPlayerItem(player) {
    const isSelf = player.id === currentPlayer.id;
    const isCreator = currentPlayer.role === 'creator';
    
    let teamButtons = '';
    if (isCreator && !isSelf) {
        teamButtons = `
            ${player.team !== 'red' ? `<button class="dropdown-button danger" onclick="setPlayerTeam('${player.id}', 'red')">فريق أحمر</button>` : ''}
            ${player.team !== 'blue' ? `<button class="dropdown-button" onclick="setPlayerTeam('${player.id}', 'blue')">فريق أزرق</button>` : ''}
            ${player.role !== 'spy' ? `<button class="dropdown-button warning" onclick="setPlayerRole('${player.id}', 'spy')">تعيين كجاسوس</button>` : ''}
            ${player.role === 'spy' ? `<button class="dropdown-button success" onclick="setPlayerRole('${player.id}', 'player')">تعيين كلاعب</button>` : ''}
            <button class="dropdown-button danger" onclick="showKickDialog('${player.id}', '${player.name}')">طرد</button>
        `;
    } else if (gameState.state === 'setup' && !player.team && !isSelf) {
        teamButtons = `
            <button class="dropdown-button danger" onclick="setPlayerTeam('${player.id}', 'red')">انضم أحمر</button>
            <button class="dropdown-button" onclick="setPlayerTeam('${player.id}', 'blue')">انضم أزرق</button>
        `;
    }

    const roleText = player.role === 'spy' ? '<span class="player-role spy">جاسوس</span>' : (player.role === 'creator' ? '<span class="player-role creator">منشئ</span>' : '<span class="player-role">لاعب</span>');
    const teamClass = player.team || 'no-team';

    return `
        <div class="dropdown-item ${teamClass}">
            <div style="display: flex; align-items: center; flex-direction: column; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">
                    ${player.name} ${isSelf ? '(أنت)' : ''}
                    <span class="status-indicator ${player.online ? 'online' : 'offline'}" title="${player.online ? 'متصل' : 'غير متصل'}"></span>
                </div>
                <div>
                    ${roleText} 
                    <span class="player-role" style="background: #333; color: white;">الفريق: ${player.team === 'red' ? 'أحمر' : (player.team === 'blue' ? 'أزرق' : 'لا يوجد')}</span>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; justify-content: flex-end;">
                ${teamButtons}
            </div>
        </div>
    `;
 }

 // تعيين دور اللاعب
 function setPlayerRole(playerId, role) {
    if (currentPlayer.role !== 'creator') return;
    database.ref(`rooms/${roomId}/players/${playerId}/role`).set(role).then(() => {
        logEvent(currentPlayer.team, `${currentPlayer.name} عين اللاعب ${gameState.players[playerId].name} كـ ${role === 'spy' ? 'جاسوس' : 'لاعب عادي'}`);
    });
 }

 // تعيين فريق اللاعب
 function setPlayerTeam(playerId, team) {
    // إذا كان منشئ الغرفة، يمكنه تعيين أي شخص لأي فريق
    if (currentPlayer.role === 'creator') {
        database.ref(`rooms/${roomId}/players/${playerId}/team`).set(team).then(() => {
            logEvent(team, `${currentPlayer.name} حوّل اللاعب ${gameState.players[playerId].name} إلى الفريق ${team === 'red' ? 'الأحمر' : 'الأزرق'}`);
        });
        database.ref(`rooms/${roomId}/players/${playerId}/role`).set('player'); // إعادة الدور إلى لاعب عند تغيير الفريق
        return;
    }
    
    // إذا كان اللاعب نفسه، يمكنه الانضمام قبل بدء اللعب
    if (playerId === currentPlayer.id && gameState.state === 'setup') {
        database.ref(`rooms/${roomId}/players/${playerId}/team`).set(team).then(() => {
            logEvent(team, `${currentPlayer.name} انضم إلى الفريق ${team === 'red' ? 'الأحمر' : 'الأزرق'}`);
            // محاولة تعيين كجاسوس إذا كان هناك نقص
            assignSpyRole(team);
        });
    }
 }

 // محاولة تعيين دور الجاسوس
 function assignSpyRole(team) {
     const playersInTeam = Object.values(gameState.players || {}).filter(p => p.team === team && p.role !== 'spy');
     const spiesInTeam = Object.values(gameState.players || {}).filter(p => p.team === team && p.role === 'spy');
     const requiredSpies = Math.max(1, Math.floor((playersInTeam.length + spiesInTeam.length) / 3)); // قاعدة تقريبية
     
     // إذا كان عدد الجواسيس أقل من المطلوب، عين اللاعب كجاسوس بشكل عشوائي أو إذا كان هو الوحيد
     if (spiesInTeam.length < requiredSpies) {
         if (playersInTeam.length > 0) {
             const playerToMakeSpy = playersInTeam[Math.floor(Math.random() * playersInTeam.length)];
             database.ref(`rooms/${roomId}/players/${playerToMakeSpy.id}/role`).set('spy').then(() => {
                 logEvent(team, `تم تعيين ${playerToMakeSpy.name} كجاسوس`);
             });
         }
     }
 }

 // تحديث شريط الأدوات
 function updateToolbar() {
     const startGameBtn = document.getElementById('startGameBtn');
     const players = Object.values(gameState.players || {});
     
     if (currentPlayer.role === 'creator' && gameState.state === 'setup') {
         // تأكد من وجود جاسوس واحد على الأقل لكل فريق ووجود ما يكفي من اللاعبين
         const redPlayers = players.filter(p => p.team === 'red');
         const bluePlayers = players.filter(p => p.team === 'blue');
         const hasSpies = redPlayers.some(p => p.role === 'spy') && bluePlayers.some(p => p.role === 'spy');
         const hasEnoughPlayers = redPlayers.length >= 2 && bluePlayers.length >= 2;
         
         if (hasSpies && hasEnoughPlayers) {
             startGameBtn.style.display = 'block';
             startGameBtn.textContent = 'بدء اللعبة';
         } else {
             startGameBtn.style.display = 'block';
             startGameBtn.textContent = 'تحقق من الفرق (جاسوسان + 2 لاعبين على الأقل لكل فريق)';
         }
     } else {
         startGameBtn.style.display = 'none';
     }
 }

 // عرض/إخفاء القوائم المنسدلة
 function togglePlayerDropdown() {
    document.getElementById('playerDropdown').classList.toggle('show');
 }
 function toggleResetDropdown() {
    document.getElementById('resetDropdown').classList.toggle('show');
 }
 function togglePlayersDropdown() {
    document.getElementById('playersDropdown').classList.toggle('show');
 }

 // دالة نسخ رابط الروم الجديدة
 function copyRoomLink() {
     if (!roomId) {
         alert('لم يتم إنشاء غرفة بعد.');
         return;
     }
     const roomUrl = window.location.origin + window.location.pathname + '?room=' + roomId;
     navigator.clipboard.writeText(roomUrl).then(() => {
         alert('تم نسخ رابط الغرفة بنجاح!');
         console.log('Room link copied:', roomUrl);
     }).catch(err => {
         console.error('Failed to copy room link:', err);
         alert('فشل نسخ الرابط. يرجى النسخ يدوياً: ' + roomUrl);
     });
 }

 // بدء اللعب (من المنشئ)
 function startGamePlay() {
    if (currentPlayer.role !== 'creator' || gameState.state !== 'setup') return;
    
    // التحقق النهائي من الفرق قبل البدء
    const players = Object.values(gameState.players || {});
    const redPlayers = players.filter(p => p.team === 'red');
    const bluePlayers = players.filter(p => p.team === 'blue');
    const hasSpies = redPlayers.some(p => p.role === 'spy') && bluePlayers.some(p => p.role === 'spy');
    const hasEnoughPlayers = redPlayers.length >= 2 && bluePlayers.length >= 2;
    
    if (!hasSpies || !hasEnoughPlayers) {
        alert('لا يمكن بدء اللعبة: يجب أن يكون هناك جاسوس واحد على الأقل ولاعبان لكل فريق.');
        return;
    }

    // تعيين حالة اللعب
    database.ref(`rooms/${roomId}/state`).set('playing').then(() => {
        logEvent(gameState.turn, `بدأت اللعبة! الدور الآن للفريق ${gameState.turn === 'red' ? 'الأحمر' : 'الأزرق'}`);
    });
 }

 // إعادة تشغيل اللعبة
 function resetGame(mode) {
    if (currentPlayer.role !== 'creator') return;

    if (mode === 'keep_cards') {
        // إعادة تعيين الحالة باستثناء البطاقات
        const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
        const initialScore = firstTurn === 'red' ? { red: 9, blue: 8 } : { red: 8, blue: 9 };

        database.ref(`rooms/${roomId}`).update({
            state: 'playing',
            turn: firstTurn,
            score: initialScore,
            hint: { word: '', number: 0, team: '', guesses: 0 },
            log: [],
            lastActivity: Date.now(),
            winner: null,
            currentTurnAttempts: 0
        }).then(() => {
            logEvent(firstTurn, 'تمت إعادة تشغيل اللعبة بنفس البطاقات. الدور للفريق ' + (firstTurn === 'red' ? 'الأحمر' : 'الأزرق'));
        });
    } else if (mode === 'new_cards') {
        // إنشاء بطاقات جديدة
        const shuffledWords = shuffleArray(gameWords);
        const newCards = generateCards(shuffledWords);
        const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
        const initialScore = firstTurn === 'red' ? { red: 9, blue: 8 } : { red: 8, blue: 9 };
        
        database.ref(`rooms/${roomId}`).update({
            cards: newCards,
            state: 'playing',
            turn: firstTurn,
            score: initialScore,
            hint: { word: '', number: 0, team: '', guesses: 0 },
            log: [],
            lastActivity: Date.now(),
            winner: null,
            currentTurnAttempts: 0
        }).then(() => {
            logEvent(firstTurn, 'تمت إعادة تشغيل اللعبة ببطاقات جديدة. الدور للفريق ' + (firstTurn === 'red' ? 'الأحمر' : 'الأزرق'));
        });
    }
    
    // إخفاء القائمة المنسدلة
    document.getElementById('resetDropdown').classList.remove('show');
 }

 // تحديث شبكة البطاقات
 function updateCardsGrid() {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = ''; // تنظيف الشبكة
  
  if (!gameState || !gameState.cards) return;

  const isSpy = currentPlayer.role === 'spy';
  const myTeam = currentPlayer.team;
  const isMyTurn = gameState.turn === myTeam;
  const inPlayingState = gameState.state === 'playing';

  gameState.cards.forEach(card => {
   const cardEl = document.createElement('div');
   cardEl.className = 'card';
   cardEl.dataset.id = card.id;

   // إذا كان جاسوساً، اعرض اللون الحقيقي
   if (isSpy) {
    cardEl.classList.add('spy-view', card.color);
   }

   // إذا تم الكشف عنها، طبق تراكب الكشف
   if (card.revealed) {
    cardEl.classList.add('revealed');
    cardEl.style.background = card.color === 'black' ? '#343a40' : (card.color === 'red' ? '#dc3545' : (card.color === 'blue' ? '#007bff' : '#f5deb3'));
    cardEl.style.color = card.color === 'neutral' ? '#000000' : 'white';
   }

   // إذا لم يتم الكشف عنها بعد، أضف مستمع النقر للتصويت
   if (!card.revealed && inPlayingState && !isSpy && isMyTurn) {
    cardEl.classList.add('can-select');
    cardEl.onclick = () => voteForCard(card.id);
   }

   // عرض كلمة البطاقة
   const wordEl = document.createElement('div');
   wordEl.textContent = card.word;
   wordEl.style.flex = '1';
   wordEl.style.display = 'flex';
   wordEl.style.alignItems = 'center';
   wordEl.style.justifyContent = 'center';
   wordEl.style.width = '100%';
   wordEl.style.padding = '2px';
   cardEl.appendChild(wordEl);
   
   // عرض المصوتين
   if (card.voters && Object.keys(card.voters).length > 0) {
        const votersEl = document.createElement('div');
        votersEl.className = 'voters';
        const votersList = Object.keys(card.voters).map(voterId => {
             const voter = gameState.players[voterId];
             if (voter) {
                 return `<span class="voter ${voter.team}">${voter.name.substring(0, 1)}</span>`;
             }
             return '';
        }).join('');
        votersEl.innerHTML = `المصوتون: ${votersList}`;
        cardEl.appendChild(votersEl);
   }
   
   grid.appendChild(cardEl);
  });
 }
 
 // التصويت على البطاقة
 function voteForCard(cardId) {
     if (!database || !roomId || !currentPlayer.team) return;

     const cardRef = database.ref(`rooms/${roomId}/cards/${cardId}/voters/${currentPlayer.id}`);
     
     // إذا كان اللاعب قد صوت مسبقاً، سحب التصويت
     if (gameState.cards[cardId].voters && gameState.cards[cardId].voters[currentPlayer.id]) {
         cardRef.remove();
         console.log(`Vote removed from card ${cardId}`);
     } else {
         // التصويت
         cardRef.set(currentPlayer.team).then(() => {
             console.log(`Voted for card ${cardId}`);
             // التحقق من الإجماع
             checkConsensus(cardId);
         });
     }
 }
 
 // التحقق من الإجماع وكشف البطاقة
 function checkConsensus(cardId) {
     const card = gameState.cards[cardId];
     if (!card) return;
     
     const currentTurn = gameState.turn;
     const playersInTeam = Object.values(gameState.players || {}).filter(p => p.team === currentTurn && p.role !== 'spy' && p.online);
     const requiredVotes = playersInTeam.length; // يتطلب إجماعاً من جميع اللاعبين العاديين المتصلين في الفريق
     
     const cardVoters = Object.keys(card.voters || {}).length;
     
     if (cardVoters >= requiredVotes && cardVoters > 0) {
         // كشف البطاقة
         revealCard(cardId, currentTurn);
     }
 }
 
 // كشف البطاقة
 function revealCard(cardId, team) {
     if (gameState.state !== 'playing' || gameState.turn !== team || gameState.cards[cardId].revealed) return;
     
     const card = gameState.cards[cardId];
     const cardColor = card.color;
     const cardWord = card.word;
     let nextTurn = team;
     let gameEnded = false;

     database.ref(`rooms/${roomId}/cards/${cardId}/revealed`).set(true).then(() => {
        
        // مسح المصوتين بعد الكشف
        database.ref(`rooms/${roomId}/cards/${cardId}/voters`).remove();

        // تحديث النتيجة
        if (cardColor === 'red') {
            database.ref(`rooms/${roomId}/score/red`).transaction(score => (score || 0) - 1);
            if (team === 'blue') nextTurn = 'red'; // كشف فريق الخصم، ينتقل الدور
        } else if (cardColor === 'blue') {
            database.ref(`rooms/${roomId}/score/blue`).transaction(score => (score || 0) - 1);
            if (team === 'red') nextTurn = 'blue'; // كشف فريق الخصم، ينتقل الدور
        } else if (cardColor === 'black') {
            // القاتل - تنتهي اللعبة
            gameEnded = true;
            database.ref(`rooms/${roomId}/winner`).set(team === 'red' ? 'blue' : 'red');
            nextTurn = team; // لا يهم
        } else {
            // محايد - ينتقل الدور
            nextTurn = team === 'red' ? 'blue' : 'red';
        }

        // إرسال سجل الحدث
        logEvent(team, `${team === 'red' ? 'الأحمر' : 'الأزرق'} كشف بطاقة: ${cardWord} (${cardColor === 'red' ? 'أحمر' : (cardColor === 'blue' ? 'أزرق' : (cardColor === 'black' ? 'قاتل' : 'محايد'))})`);
        
        // التحقق من محاولات الدور
        database.ref(`rooms/${roomId}/currentTurnAttempts`).transaction(attempts => (attempts || 0) + 1).then(({ snapshot }) => {
            const currentAttempts = snapshot.val();
            const maxGuesses = gameState.hint.number; // العدد المطلوب كحد أقصى
            
            // تحقق من نهاية اللعبة باللون القاتل
            if (cardColor === 'black') {
                database.ref(`rooms/${roomId}/state`).set('ended');
            } else if (cardColor === team) {
                // كشف فريقك بنجاح
                nextTurn = team; // يبقى الدور
                
                // إذا تم الكشف عن جميع بطاقات الفريق
                const remainingTeamCards = gameState.cards.filter(c => c.color === team && !c.revealed).length;
                if (remainingTeamCards === 0) {
                    gameEnded = true;
                    database.ref(`rooms/${roomId}/winner`).set(team);
                    database.ref(`rooms/${roomId}/state`).set('ended');
                    nextTurn = team; // لا يهم
                }
                
                // تجاوز العدد المسموح به
                if (currentAttempts > maxGuesses) {
                    nextTurn = team === 'red' ? 'blue' : 'red'; // ينتقل الدور
                    logEvent(team, `تجاوز ${team === 'red' ? 'الأحمر' : 'الأزرق'} عدد المحاولات (${currentAttempts - 1}/${maxGuesses}). ينتقل الدور.`);
                }
            } else {
                // كشف فريق الخصم أو محايد
                nextTurn = team === 'red' ? 'blue' : 'red'; // ينتقل الدور
                
                // في حالة كشف المحايد أو فريق الخصم، تتم إعادة تعيين المحاولات
                database.ref(`rooms/${roomId}/currentTurnAttempts`).set(0);
                
                if (!gameEnded) {
                    // إذا لم تنته اللعبة، قم بإنهاء الدور وتحديث التلميح
                    endTurnLogic(nextTurn, false); // false لعدم إرسال حدث جديد لإنهاء الدور
                }
            }
            
            // إذا لم تنته اللعبة بعد القاتل أو اكتمال الألوان، قم بتحديث الدور
            if (!gameEnded) {
                database.ref(`rooms/${roomId}/turn`).set(nextTurn);
            }
        });
     });
 }
 
 // تحديث النقاط
 function updateScores() {
    document.getElementById('redScore').textContent = gameState.score.red;
    document.getElementById('blueScore').textContent = gameState.score.blue;
 }

 // إرسال التلميح
 function sendHint() {
    if (gameState.state !== 'playing' || currentPlayer.role !== 'spy' || gameState.turn !== currentPlayer.team) {
        alert('لا يمكنك إرسال تلميح الآن.');
        return;
    }
    
    const hintInput = document.getElementById('hintInput').value.trim();
    const numberSelect = document.getElementById('numberSelect').value;
    
    if (!hintInput) {
        alert('يرجى إدخال التلميح.');
        return;
    }
    
    if (hintInput.split(/\s+/).length > 1) {
        alert('التلميح يجب أن يكون كلمة واحدة فقط.');
        return;
    }

    const newHint = {
        word: hintInput,
        number: parseInt(numberSelect) + 1, // العدد + محاولة إضافية
        team: currentPlayer.team,
        guesses: parseInt(numberSelect),
        timestamp: Date.now()
    };
    
    // تحديث التلميح وحالة الدور
    database.ref(`rooms/${roomId}`).update({
        hint: newHint,
        currentTurnAttempts: 0 // إعادة تعيين محاولات الدور
    }).then(() => {
        document.getElementById('hintInput').value = ''; // مسح الإدخال
        logEvent(currentPlayer.team, `الجاسوس ${currentPlayer.name} أعطى تلميح: "${hintInput}" لـ ${numberSelect} كلمة`);
    });
 }

 // تحديث منطقة التلميح
 function updateHintArea() {
    const hintArea = document.getElementById('hintArea');
    const endTurnArea = document.getElementById('endTurnArea');
    const hintDisplayArea = document.getElementById('hintDisplayArea');
    const displayHintText = document.getElementById('displayHintText');
    const displayHintNumber = document.getElementById('displayHintNumber');
    
    const isSpy = currentPlayer.role === 'spy';
    const isMyTeam = gameState.turn === currentPlayer.team;
    const isPlaying = gameState.state === 'playing';
    
    // إظهار وإخفاء مناطق الإدخال/العرض
    if (isPlaying) {
        if (isSpy && isMyTeam && !gameState.hint.word) {
            // جاسوس دوره هو إعطاء تلميح
            hintArea.style.display = 'block';
            endTurnArea.style.display = 'none';
            hintDisplayArea.style.display = 'none';
        } else if (gameState.hint.word) {
            // تلميح موجود - عرض التلميح
            hintDisplayArea.style.display = 'block';
            hintArea.style.display = 'none';

            displayHintText.textContent = gameState.hint.word;
            // عرض عدد التخمينات المتبقية
            const remainingGuesses = gameState.hint.number - gameState.currentTurnAttempts;
            displayHintNumber.textContent = remainingGuesses;

            // إذا كان دور فريقي وليس أنا الجاسوس
            if (!isSpy && isMyTeam) {
                endTurnArea.style.display = 'block';
            } else {
                endTurnArea.style.display = 'none';
            }
        } else {
            // لا يوجد تلميح - انتظار الجاسوس
            hintArea.style.display = 'none';
            endTurnArea.style.display = 'none';
            hintDisplayArea.style.display = 'none';
        }
    } else {
        // حالة الإعداد أو الانتهاء
        hintArea.style.display = 'none';
        endTurnArea.style.display = 'none';
        hintDisplayArea.style.display = 'none';
    }
    
    // إظهار زر إعادة التشغيل للمنشئ فقط
    const resetDropdownContent = document.getElementById('resetDropdownContent');
    if (currentPlayer.role === 'creator') {
        resetDropdownContent.innerHTML = `
            <div class="dropdown-section">
                <div class="dropdown-section-title">خيارات الإعادة</div>
                <button class="dropdown-button success" onclick="resetGame('new_cards')">إعادة تعيين وبطاقات جديدة</button>
                <button class="dropdown-button warning" onclick="resetGame('keep_cards')">إعادة تعيين بنفس البطاقات</button>
                <button class="dropdown-button danger" onclick="confirmDeleteRoom()">حذف الغرفة نهائياً</button>
            </div>
        `;
    } else {
        resetDropdownContent.innerHTML = '<div class="dropdown-info">فقط منشئ الغرفة يمكنه إعادة تشغيل اللعبة.</div>';
    }

    // تحديث محتوى قائمة خيارات اللاعب
    const playerDropdownContent = document.getElementById('playerDropdownContent');
    playerDropdownContent.innerHTML = `
        <div class="dropdown-section">
            <div class="dropdown-section-title">الفريق الحالي: ${currentPlayer.team === 'red' ? 'أحمر' : (currentPlayer.team === 'blue' ? 'أزرق' : 'لا يوجد')}</div>
            <button class="dropdown-button danger" onclick="setPlayerTeam('${currentPlayer.id}', 'red')">الانضمام للفريق الأحمر</button>
            <button class="dropdown-button" onclick="setPlayerTeam('${currentPlayer.id}', 'blue')">الانضمام للفريق الأزرق</button>
        </div>
        <div class="dropdown-section">
            <div class="dropdown-section-title">دورك الحالي: ${currentPlayer.role === 'spy' ? 'الجاسوس' : (currentPlayer.role === 'creator' ? 'المنشئ' : 'اللاعب')}</div>
            ${currentPlayer.role === 'creator' ? '<div class="dropdown-info">أنت منشئ الغرفة، لا يمكن تغيير دورك إلا بالاستقالة.</div>' : ''}
        </div>
        ${currentPlayer.role === 'creator' ? `<div class="dropdown-section"><button class="dropdown-button danger" onclick="confirmResignCreator()">التخلي عن دور المنشئ</button></div>` : ''}
    `;
 }

 // إنهاء الدور
 function endTurn() {
     if (gameState.state !== 'playing' || currentPlayer.role === 'spy' || gameState.turn !== currentPlayer.team) {
        alert('لا يمكنك إنهاء الدور الآن.');
        return;
    }
    
    const nextTurn = gameState.turn === 'red' ? 'blue' : 'red';
    endTurnLogic(nextTurn, true);
 }
 
 // منطق إنهاء الدور
 function endTurnLogic(nextTurn, logNewEvent) {
     database.ref(`rooms/${roomId}`).update({
        turn: nextTurn,
        hint: { word: '', number: 0, team: '', guesses: 0 },
        currentTurnAttempts: 0
    }).then(() => {
        if (logNewEvent) {
             logEvent(gameState.turn, `أنهى ${gameState.turn === 'red' ? 'الأحمر' : 'الأزرق'} دوره. الدور الآن لـ ${nextTurn === 'red' ? 'الأحمر' : 'الأزرق'}`);
        }
    });
 }

 // إضافة حدث إلى السجل
 function logEvent(team, message) {
     const newLogEntry = {
        message: message,
        team: team,
        timestamp: Date.now()
    };
    
    const logRef = database.ref(`rooms/${roomId}/log`);
    logRef.limitToLast(50).once('value', snapshot => {
        let logs = snapshot.val() || [];
        if (!Array.isArray(logs)) {
            logs = Object.values(logs); // تحويل الكائن إلى مصفوفة إذا لزم الأمر
        }
        logs.push(newLogEntry);
        
        // الحفاظ على 50 إدخال كحد أقصى
        if (logs.length > 50) {
            logs.shift();
        }
        
        logRef.set(logs);
    });
 }
 
 // تحديث سجل الأحداث
 function updateGameLog() {
     const logDiv = document.getElementById('gameLog');
     logDiv.innerHTML = '';
     const logData = gameState.log || [];
     
     logData.forEach(entry => {
        const logEntryEl = document.createElement('div');
        logEntryEl.className = `log-entry ${entry.team}`;
        const time = new Date(entry.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        logEntryEl.innerHTML = `<strong>[${time}]</strong> ${entry.message}`;
        logDiv.appendChild(logEntryEl);
     });
     
     // التمرير إلى الأسفل تلقائياً
     logDiv.scrollTop = logDiv.scrollHeight;
 }

 // التحقق من نهاية اللعبة
 function checkGameEnd() {
    if (gameState.state === 'playing') {
        const redRemaining = gameState.cards.filter(c => c.color === 'red' && !c.revealed).length;
        const blueRemaining = gameState.cards.filter(c => c.color === 'blue' && !c.revealed).length;
        
        // التحقق من نهاية اللعبة بالنقاط
        if (redRemaining === 0) {
            database.ref(`rooms/${roomId}/winner`).set('red');
            database.ref(`rooms/${roomId}/state`).set('ended');
            return;
        }
        if (blueRemaining === 0) {
            database.ref(`rooms/${roomId}/winner`).set('blue');
            database.ref(`rooms/${roomId}/state`).set('ended');
            return;
        }
    }
    
    // عرض رسالة النهاية
    if (gameState.state === 'ended' && gameState.winner) {
        const winnerTeam = gameState.winner === 'red' ? 'الأحمر' : 'الأزرق';
        alert(`انتهت اللعبة! الفائز هو الفريق ${winnerTeam}!`);
        // تحديث رسالة حالة اللعبة
        document.getElementById('currentHint').classList.remove('hidden');
        document.getElementById('currentHint').textContent = `انتهت اللعبة! الفائز هو الفريق ${winnerTeam}!`;
    } else {
        document.getElementById('currentHint').classList.add('hidden');
    }

    // إظهار زر إعادة التشغيل
    if (gameState.state === 'ended' && currentPlayer.role === 'creator') {
        document.getElementById('startGameBtn').style.display = 'block';
        document.getElementById('startGameBtn').textContent = 'بدء جولة جديدة';
    }
 }

 // نافذة تأكيد الطرد
 let playerToKick = null;

 function showKickDialog(playerId, playerName) {
     if (currentPlayer.role !== 'creator' || playerId === currentPlayer.id) return;

     playerToKick = playerId;
     document.getElementById('kickDialogMessage').textContent = `هل أنت متأكد من طرد اللاعب ${playerName} من الغرفة؟`;
     document.getElementById('kickDialog').classList.add('show');
 }

 function cancelKick() {
     playerToKick = null;
     document.getElementById('kickDialog').classList.remove('show');
 }

 function confirmKick() {
     if (playerToKick) {
         database.ref(`rooms/${roomId}/players/${playerToKick}`).remove().then(() => {
             logEvent('system', `تم طرد اللاعب ${gameState.players[playerToKick].name} بواسطة ${currentPlayer.name}`);
             playerToKick = null;
             cancelKick();
         });
     }
 }
 
 // تأكيد حذف الغرفة
 function confirmDeleteRoom() {
     if (currentPlayer.role !== 'creator') return;
     if (confirm('هل أنت متأكد من حذف الغرفة نهائياً؟ لا يمكن التراجع عن هذا الإجراء.')) {
         database.ref(`rooms/${roomId}`).remove().then(() => {
             alert('تم حذف الغرفة بنجاح');
             window.location.href = window.location.origin + window.location.pathname;
         });
     }
 }

 // التخلي عن دور المنشئ
 function confirmResignCreator() {
    if (currentPlayer.role !== 'creator') return;
    const players = Object.values(gameState.players || {}).filter(p => p.id !== currentPlayer.id && p.online);
    
    if (players.length === 0) {
        alert('لا يمكن التخلي عن دور المنشئ الآن لأنه لا يوجد لاعبون آخرون متصلون في الغرفة.');
        return;
    }
    
    if (confirm('هل أنت متأكد من التخلي عن دور المنشئ؟ سيتم تعيين منشئ عشوائي آخر.')) {
        // تعيين منشئ جديد عشوائي
        const newCreator = players[Math.floor(Math.random() * players.length)];
        
        database.ref(`rooms/${roomId}/players/${currentPlayer.id}/role`).set('player').then(() => {
            database.ref(`rooms/${roomId}/creatorId`).set(newCreator.id).then(() => {
                database.ref(`rooms/${roomId}/players/${newCreator.id}/role`).set('creator').then(() => {
                    logEvent('system', `${currentPlayer.name} تخلى عن دور المنشئ. ${newCreator.name} هو المنشئ الجديد.`);
                    // تحديث الحالة المحلية ودور اللاعب
                    currentPlayer.role = 'player';
                    savePlayerState();
                    // إخفاء القائمة المنسدلة
                    document.getElementById('playerDropdown').classList.remove('show');
                });
            });
        });
    }
 }
 
 // معالجة حالة الاتصال
 window.addEventListener('online', function() {
  console.log('Connection restored');
  updatePlayerOnlineStatus(true);
 });

 window.addEventListener('offline', function() {
  console.log('Connection lost');
 });

 // معالجة تغيير حالة المتصفح (دخول/خروج من التبويب)
 document.addEventListener('visibilitychange', function() {
  if (database && roomId && currentPlayer) {
   const isVisible = !document.hidden;
   updatePlayerOnlineStatus(isVisible);
  }
 });

 console.log('🎮 مرابط - تم تحميل الكود بنجاح مع جميع التحسينات');
 </script>
 <script>
 (function() {
  function c() {
   var b = a.contentDocument || a.contentWindow.document;
   if (b) {
    var d = b.createElement('script');
    d.innerHTML = "window.__CF$cv$params={r:'9903ff4bb2ecd60a',t:'MTc2MDc0ODE2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
    b.getElementsByTagName('head')[0].appendChild(d)
   }
  }
  if (document.body) {
   var a = document.createElement('iframe');
   a.height = 1;
   a.width = 1;
   a.style.position = 'absolute';
   a.style.top = 0;
   a.style.left = 0;
   a.style.border = 'none';
   a.style.visibility = 'hidden';
   document.body.appendChild(a);
   if ('loading' !== document.readyState) c();
   else if (window.addEventListener) window.addEventListener('load', c);
   else window.attachEvent('onload', c);
  }
 })();
 </script>
 </body>
</html>
