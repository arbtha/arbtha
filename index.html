<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>مرابط</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }
        
        html, body {
            height: 100%;
        }
        
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* شاشة البداية */
        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: url('mainbg.jpg') center/cover no-repeat;
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* خلفيات مخصصة لأجهزة الكمبيوتر وسطح المكتب */
        @media (min-width: 1024px) {
            .start-screen {
                background: url('mainbgpc.jpg') center/cover no-repeat;
            }
        }
        
        .start-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            z-index: 1;
        }
        
        .start-screen > * {
            position: relative;
            z-index: 2;
        }
        
        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .name-input {
            width: 100%;
            max-width: 250px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
            background: rgba(255,255,255,0.9);
        }
        
        .name-input:focus {
            border-color: #667eea;
            background: white;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #218838, #1ea080);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        /* شاشة اللعبة */
        .game-screen {
            display: none;
            height: 100%;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .game-screen.red-turn {
            background-image: url('redteamturn.jpg');
        }
        
        .game-screen.blue-turn {
            background-image: url('blueteamturn.jpg');
        }
        
        /* خلفيات الفرق المخصصة لأجهزة الكمبيوتر وسطح المكتب */
        @media (min-width: 1024px) {
            .game-screen.red-turn {
                background-image: url('redteamturnpc.jpg');
            }
            
            .game-screen.blue-turn {
                background-image: url('blueteamturnpc.jpg');
            }
        }
        
        /* شريط الأدوات العلوي */
        .toolbar {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        
        .toolbar-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .toolbar-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .toolbar-btn:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }
        
        .toolbar-btn.secondary {
            background: #ffc107;
            color: #333;
            border-color: #ffc107;
        }
        
        .toolbar-btn.secondary:hover {
            background: #e0a800;
            border-color: #e0a800;
        }
        
        .toolbar-btn.info {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }
        
        .toolbar-btn.info:hover {
            background: #138496;
            border-color: #138496;
        }
        
        .player-name-btn {
            background: #f8f9fa;
            border: 2px solid #28a745;
            color: #333;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .player-name-btn:hover {
            background: #e8f5e8;
            transform: translateY(-1px);
        }
        
        /* منطقة اللعب الرئيسية */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 0;
            overflow: hidden;
        }
        
        /* حاوي البطاقات */
        .cards-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            min-height: 0;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            box-sizing: border-box;
        }
        
        /* شبكة البطاقات */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 5px;
            width: 100%;
            height: 100%;
            padding: 5px;
            box-sizing: border-box;
        }
        
        .card {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
            border: none; 
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: clamp(0.4rem, 1.2vw, 0.8rem);
            font-weight: bold;
            text-align: center;
            padding: 4px;
            box-sizing: border-box;
            color: #000000;
            text-shadow: none; 
            overflow: hidden;
            min-height: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            aspect-ratio: 3/2; 
        }
        
        /* تحسينات لسطح المكتب */
        @media (min-width: 1024px) {
            .container {
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                height: 100vh;
                padding: 8px;
                overflow: hidden;
            }
            
            .toolbar {
                padding: 8px;
                margin-bottom: 8px;
                font-size: 0.8rem;
            }
            
            .cards-container {
                flex: 1;
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                padding: 5px;
                margin-bottom: 8px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .cards-grid {
                height: 100%;
                width: 100%;
                padding: 5px;
                overflow: hidden;
                box-sizing: border-box;
            }
            
            .card {
                font-size: clamp(0.5rem, 1vw, 0.8rem);
                padding: 5px;
                border-radius: 10px;
                box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            }
            
            .bottom-area {
                height: 130px;
                flex-shrink: 0;
            }
            
            .team-panel, .log-panel {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .hint-display-area {
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .hint-area {
                padding: 6px;
            }
            
            .end-turn-area {
                padding: 6px;
                margin-bottom: 6px;
            }
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .card.revealed {
            color: white;
        }
        
        .card.red {
            background: #dc3545;
        }
        
        .card.blue {
            background: #007bff;
        }
        
        .card.black {
            background: #343a40;
        }
        
        .card.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view {
            color: white;
            font-weight: bold;
        }
        
        .card.spy-view.red {
            background: url('REDSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.blue {
            background: url('BLUESPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.black {
            background: url('BLACKSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.neutral {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
        }
        
        .revealed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            z-index: 1;
        }
        
        .hand-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }
        
        .card.can-select .hand-btn {
            display: block;
        }
        
        .voters {
            font-size: 0.6rem;
            margin-top: 2px;
            align-self: stretch;
            text-align: center;
        }
        
        .voter {
            display: inline-block;
            margin: 2px;
            padding: 2px 5px;
            border-radius: 5px;
            color: white;
        }
        
        .voter.red {
            background: #dc3545;
        }
        
        .voter.blue {
            background: #007bff;
        }
        
        /* منطقة الفرق والسجل */
        .bottom-area {
            display: flex;
            gap: 5px;
            height: 180px;
            flex-shrink: 0;
        }
        
        .team-panel {
            flex: 1;
            border-radius: 15px;
            padding: 15px;
            overflow-y: auto;
            position: relative;
            color: white;
        }
        
        .team-panel.red {
            background: #dc3545;
        }
        
        .team-panel.blue {
            background: #007bff;
        }
        
        .team-score {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        .team-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .player-item {
            background: rgba(255,255,255,0.15);
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: fit-content;
            margin-right: 5px;
            margin-bottom: 5px;
            color: white;
            backdrop-filter: blur(5px);
        }
        
        .player-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        .log-panel {
            flex: 1;
            background: rgba(240,240,240,0.95);
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto;
            position: relative;
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .log-entry {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 4px solid #ddd;
        }
        
        .log-entry.red {
            border-left-color: #dc3545;
        }
        
        .log-entry.blue {
            border-left-color: #007bff;
        }
        
        /* منطقة التلميح */
        .hint-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: none;
        }
        
        .hint-area.active {
            display: block;
        }
        
        .hint-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .hint-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .number-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background: white;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .number-select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .send-hint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .end-turn-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 6px;
            font-size: 0.9rem;
        }

        .end-turn-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            text-align: center;
        }
        

        
        /* منطقة عرض التلميح في السجل */
        .hint-display-in-log {
            padding: 10px;
        }
        
        .hint-display-in-log .hint-display-container {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border: 2px solid #007bff;
            margin-bottom: 10px;
        }
        
        .hint-display-in-log .end-turn-area {
            margin-bottom: 0;
        }
        
        /* منطقة عرض التلميح الجديدة */
        .hint-display-area {
            padding: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: center;
        }
        
        .hint-display-container {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 12px 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            border: 2px solid #007bff;
        }
        
        .hint-box, .number-box {
            text-align: center;
        }
        
        .hint-label, .number-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 4px;
            font-weight: bold;
        }
        
        .hint-text, .number-text {
            font-size: 1.1rem;
            font-weight: bold;
            color: #007bff;
        }
        
        /* حالة اللعبة */
        .game-status {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .current-hint {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        /* القوائم المنسدلة */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: white;
            min-width: 280px;
            max-width: 90vw;
            width: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 10px;
            border: 2px solid #ddd;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            .dropdown-content {
                min-width: 260px;
                max-width: 95vw;
                max-height: 60vh;
                font-size: 0.9rem;
            }
            
            .dropdown-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .dropdown-info {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .dropdown-link {
                font-size: 0.7rem;
                word-break: break-all;
            }
            
            .hint-display-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .hint-box, .number-box {
                min-width: 100px;
            }
        }
        
        .dropdown-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #333;
            text-align: center;
        }
        
        .dropdown-section {
            margin-bottom: 15px;
        }
        
        .dropdown-section-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }
        
        .dropdown-item.red {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .dropdown-item.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .dropdown-item.no-team {
            background: #fff3e0;
            border-color: #ffcc02;
        }
        
        .dropdown-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 3px;
            transition: background 0.2s;
        }
        
        .dropdown-button:hover {
            background: #0056b3;
        }
        
        .dropdown-button.danger {
            background: #dc3545;
        }
        
        .dropdown-button.danger:hover {
            background: #c82333;
        }
        
        .dropdown-button.success {
            background: #28a745;
        }
        
        .dropdown-button.success:hover {
            background: #218838;
        }
        
        .dropdown-button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .dropdown-button.warning:hover {
            background: #e0a800;
        }
        
        .dropdown-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .dropdown-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            word-break: break-all;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .player-role {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            margin-right: 5px;
        }
        
        .player-role.spy {
            background: #ffc107;
            color: #333;
        }
        
        .player-role.creator {
            background: #17a2b8;
        }
        
        /* نافذة تأكيد الطرد */
        .kick-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .kick-dialog.show {
            display: flex;
        }
        
        .kick-dialog-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* نافذة سجل الأحداث المنبثقة */
        .log-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .log-modal.show {
            display: flex;
        }
        
        .log-modal-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .log-modal-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        
        .log-modal-close {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .log-modal-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .log-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .log-modal .log-entry {
            background: white;
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 10px;
            font-size: 0.9rem;
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .log-modal .log-entry:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .log-modal .log-entry.red {
            border-left-color: #dc3545;
            background: linear-gradient(90deg, #fff5f5 0%, white 20%);
        }
        
        .log-modal .log-entry.blue {
            border-left-color: #007bff;
            background: linear-gradient(90deg, #f0f8ff 0%, white 20%);
        }
        
        .log-modal .log-entry-time {
            font-size: 0.7rem;
            color: #666;
            float: right;
            margin-top: 2px;
        }
        
        .log-modal-empty {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
        
        .kick-dialog-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }
        
        .kick-dialog-message {
            font-size: 1rem;
            margin-bottom: 25px;
            color: #666;
            line-height: 1.5;
        }
        
        .kick-dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .kick-dialog-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .kick-dialog-btn.confirm {
            background: #dc3545;
            color: white;
        }
        
        .kick-dialog-btn.confirm:hover {
            background: #c82333;
        }
        
        .kick-dialog-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .kick-dialog-btn.cancel:hover {
            background: #5a6268;
        }

        /* تصميم متجاوب */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .cards-container {
                flex: 1;
                padding: 8px;
                margin-bottom: 6px;
            }
            
            .cards-grid {
                gap: 5px;
                height: 100%;
                width: 100%;
                overflow: hidden;
                padding: 25px;
                box-sizing: border-box;
            }
            
            .card {
                font-size: clamp(0.35rem, 2vw, 0.6rem);
                padding: 3px;
                border-radius: 6px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .bottom-area {
                height: 150px;
                flex-shrink: 0;
            }
            
            .toolbar {
                font-size: 0.7rem;
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .dropdown-content {
                min-width: 280px;
                max-width: 90vw;
                left: 0;
                right: auto;
            }
            
            .container {
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                padding: 5px;
                height: 100vh;
                overflow: hidden;
            }
            
            .team-panel, .log-panel {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .hint-display-area {
                padding: 5px;
                margin-bottom: 5px;
            }
            
            .hint-area {
                padding: 5px;
            }
            
            .end-turn-area {
                padding: 5px;
                margin-bottom: 5px;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* تأثيرات اختيار الفريق */
        .team-choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .team-choice:active {
            transform: translateY(-1px);
        }

        .cards-container {
    display: flex;
    justify-content: center;
    align-items: center;
    height: auto; /* بدل من 100% */
    padding: 10px;
}

.cards-grid {
    grid-template-columns: repeat(5, auto); /* يجعل الأعمدة بحجم الكروت فقط */
    grid-auto-rows: 1fr;
    gap: 8px; /* يمكنك تقليله أو زيادته حسب رغبتك */
    width: fit-content;
    height: fit-content;
    margin: 0 auto;
}

.card {
    width: 90px;   /* أو أي مقاس مناسب حسب الشاشة */
    height: 70px;
    aspect-ratio: unset; /* لتعطيل التمدد الإجباري */
}

.cards-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
  height: auto;
  margin-top: 5px;
  margin-bottom: 5px;
}

.cards-grid {
  display: grid;
  grid-template-columns: repeat(5, minmax(60px, 1fr));
  grid-auto-rows: minmax(55px, auto);
  gap: 6px;
  width: fit-content;
  margin: auto;
  justify-content: center;
}

.card {
  width: 68px;
  height: 55px;
  aspect-ratio: unset;
  border-radius: 10px;
  font-size: 0.8rem;
}

/* للموبايل */
@media (max-width: 600px) {
  .cards-grid {
    grid-template-columns: repeat(5, minmax(45px, 1fr));
    gap: 4px;
  }
  .card {
    width: 58px;
    height: 48px;
    font-size: 0.7rem;
  }
}


        /* ضبط منطقة الكروت */
.cards-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 0;
  margin: 0;
}

/* شبكة الكروت */
.cards-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 6px;
  width: 95vw;
  max-width: 500px;
  aspect-ratio: 3 / 2; /* للحفاظ على التناسق العام للشبكة */
  justify-items: center;
  align-items: center;
  margin: 0 auto;
}

/* الكروت بنسبة 3:2 */
.card {
  aspect-ratio: 3 / 2; /* يضبط النسبة المطلوبة */
  width: 100%;
  max-width: 100px; /* يمكنك تعديلها حسب حجم الشاشة */
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: clamp(0.5rem, 2vw, 0.9rem);
  padding: 4px;
  border-radius: 10px;
  box-sizing: border-box;
}

/* للموبايل */
@media (max-width: 600px) {
  .cards-grid {
    gap: 5px;
    width: 90vw;
    max-width: 360px;
  }

  .card {
    aspect-ratio: 3 / 2;
    max-width: 70px;
    font-size: 0.7rem;
  }
}



    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><!-- شاشة البداية -->
   <div class="start-screen" id="startScreen"><input type="text" class="name-input" id="playerName" placeholder="أدخل اسمك" maxlength="20"> <button class="start-btn" id="startGameButton" onclick="startGame()">إنشاء غرفة</button>
   </div><!-- شاشة اللعبة -->
   <div class="game-screen" id="gameScreen"><!-- شريط الأدوات -->
    <div class="toolbar">
     <div class="dropdown">
      <div class="player-name-btn" id="playerNameBtn" onclick="togglePlayerDropdown()"><span id="currentPlayerName"></span>
      </div>
      <div class="dropdown-content" id="playerDropdown">
       <div class="dropdown-header">
        خيارات اللاعب
       </div>
       <div id="playerDropdownContent"></div>
      </div>
     </div>
     <div class="dropdown"><button class="toolbar-btn" onclick="toggleResetDropdown()">إعادة تشغيل</button>
      <div class="dropdown-content" id="resetDropdown">
       <div class="dropdown-header">
        إعادة تشغيل اللعبة
       </div>
       <div id="resetDropdownContent"></div>
      </div>
     </div><button class="toolbar-btn info" onclick="showLogModal()" id="logToggleBtn" style="display: none;">سجل الأحداث</button> <button class="toolbar-btn success" onclick="startGamePlay()" id="startGameBtn" style="display: none;">بدء اللعبة</button>
     <div class="dropdown">
      <div class="toolbar-item" id="playersCount" onclick="togglePlayersDropdown()">
       👥 <span id="playerCountNum">0</span>
      </div>
      <div class="dropdown-content" id="playersDropdown">
       <div class="dropdown-header">
        إدارة اللاعبين
       </div>
       <div id="playersDropdownContent"></div>
      </div>
     </div>
    </div><!-- حاوي البطاقات -->
    <div class="cards-container">
     <div class="cards-grid" id="cardsGrid"></div>
    </div><!-- منطقة عرض التلميح الجديدة -->
    <div class="hint-display-area" id="hintDisplayArea" style="display: none;">
     <div class="hint-display-container">
      <div class="hint-box">
       <div class="hint-label">
        التلميح:
       </div>
       <div class="hint-text" id="displayHintText">
        -
       </div>
      </div>
      <div class="number-box">
       <div class="number-label">
        العدد:
       </div>
       <div class="number-text" id="displayHintNumber">
        -
       </div>
      </div>
     </div>
    </div><!-- المنطقة السفلية -->
    <div class="bottom-area"><!-- الفريق الأحمر -->
     <div class="team-panel red">
      <div class="team-score" id="redScore">
       9
      </div>
      <div class="team-section">
       <div class="section-title">
        اللاعبين:
       </div>
       <div id="redPlayers"></div>
      </div>
      <div class="team-section">
       <div class="section-title">
        السباي:
       </div>
       <div id="redSpies"></div>
      </div>
     </div><!-- سجل الأحداث -->
     <div class="log-panel" id="logPanel"><!-- منطقة التلميح (تظهر مكان السجل) -->
      <div class="hint-area" id="hintArea" style="display: none;">
       <div class="log-title">
        كتابة التلميح
       </div><input type="text" class="hint-input" id="hintInput" placeholder="اكتب تلميحك هنا...">
       <div class="hint-controls"><span>عدد الكلمات:</span> <select id="numberSelect" class="number-select"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> </select> <button class="send-hint-btn" onclick="sendHint()">إرسال التلميح</button>
       </div>
      </div><!-- منطقة عرض التلميح وزر إنهاء الدور (تظهر مكان السجل) -->
      <div class="hint-display-in-log" id="hintDisplayInLog" style="display: none;">
       <div class="log-title">
        التلميح الحالي
       </div>
       <div class="hint-display-container">
        <div class="hint-box">
         <div class="hint-label">
          التلميح:
         </div>
         <div class="hint-text" id="displayHintTextInLog">
          -
         </div>
        </div>
        <div class="number-box">
         <div class="number-label">
          العدد:
         </div>
         <div class="number-text" id="displayHintNumberInLog">
          -
         </div>
        </div>
       </div>
       <div class="end-turn-area"><button class="end-turn-btn" onclick="endTurn()">إنهاء الدور</button>
       </div>
      </div><!-- السجل العادي -->
      <div class="log-content" id="logContent">
       <div class="log-title">
        سجل الأحداث
       </div>
       <div id="gameLog"></div>
      </div>
     </div><!-- الفريق الأزرق -->
     <div class="team-panel blue">
      <div class="team-score" id="blueScore">
       8
      </div>
      <div class="team-section">
       <div class="section-title">
        اللاعبين:
       </div>
       <div id="bluePlayers"></div>
      </div>
      <div class="team-section">
       <div class="section-title">
        السباي:
       </div>
       <div id="blueSpies"></div>
      </div>
     </div>
    </div>
   </div><!-- نافذة تأكيد الطرد -->
   <div class="kick-dialog" id="kickDialog">
    <div class="kick-dialog-content">
     <div class="kick-dialog-title">
      ⚠️ تأكيد الطرد
     </div>
     <div class="kick-dialog-message" id="kickDialogMessage"></div>
     <div class="kick-dialog-buttons"><button class="kick-dialog-btn confirm" onclick="confirmKick()">طرد</button> <button class="kick-dialog-btn cancel" onclick="cancelKick()">إلغاء</button>
     </div>
    </div>
   </div><!-- نافذة سجل الأحداث المنبثقة -->
   <div class="log-modal" id="logModal">
    <div class="log-modal-content">
     <div class="log-modal-header">
      <h3 class="log-modal-title">📋 سجل الأحداث</h3><button class="log-modal-close" onclick="closeLogModal()">×</button>
     </div>
     <div class="log-modal-body" id="logModalBody">
      <div class="log-modal-empty">
       لا توجد أحداث بعد...
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // إعداد Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
            authDomain: "game-303eb.firebaseapp.com",
            databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
            projectId: "game-303eb",
            storageBucket: "game-303eb.firebasestorage.app",
            messagingSenderId: "22261863844",
            appId: "1:22261863844:web:66f8541079b9025ec69d31",
            measurementId: "G-RKN2F3HVHS"
        };

        // متغيرات عامة
        let database;
        let isFirebaseReady = false;
        let connectionAttempts = 0;
        const maxConnectionAttempts = 3;
        let showingColors = false;
        let roomCleanupInterval;

        // إظهار حالة الاتصال للمستخدم
        function showConnectionStatus(message, isError = false) {
            // إظهار رسائل الخطأ فقط
            if (isError) {
                const startBtn = document.querySelector('.start-btn');
                if (startBtn) {
                    startBtn.textContent = message;
                    startBtn.style.background = '#dc3545';
                }
            }
        }

        // تهيئة Firebase مع تشخيص مفصل
        function initializeFirebase() {
            console.log('🔄 بدء تهيئة Firebase...');
            
            try {
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK غير محمل');
                }

                if (!firebase.apps.length) {
                    console.log('📱 تهيئة تطبيق Firebase...');
                    firebase.initializeApp(firebaseConfig);
                } else {
                    console.log('📱 Firebase مهيأ مسبقاً');
                }

                database = firebase.database();
                console.log('💾 تم الحصول على مرجع قاعدة البيانات');

                console.log('🔍 اختبار الاتصال...');
                
                const testRef = database.ref('test');
                const testData = { timestamp: Date.now(), test: true };
                
                testRef.set(testData).then(() => {
                    console.log('✅ اختبار الكتابة نجح');
                    
                    return testRef.once('value');
                }).then((snapshot) => {
                    console.log('✅ اختبار القراءة نجح:', snapshot.val());
                    
                    testRef.remove();
                    
                    isFirebaseReady = true;
                    console.log('🎉 Firebase جاهز للاستخدام!');
                    
                    setupConnectionMonitoring();
                    startRoomCleanup();
                    
                }).catch((error) => {
                    console.error('❌ فشل اختبار Firebase:', error);
                    handleConnectionError(error);
                });

            } catch (error) {
                console.error('❌ خطأ في تهيئة Firebase:', error);
                handleConnectionError(error);
            }
        }

        // إعداد مراقبة الاتصال
        function setupConnectionMonitoring() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('🟢 متصل بـ Firebase');
                    isFirebaseReady = true;
                    updatePlayerOnlineStatus(true);
                } else {
                    console.log('🔴 منقطع عن Firebase');
                    isFirebaseReady = false;
                }
            });
        }

        // تحديث حالة اللاعب عند تغيير الاتصال
        function updatePlayerOnlineStatus(isOnline) {
            if (database && roomId && currentPlayer) {
                database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(isOnline);
            }
        }

        // بدء تنظيف الغرف غير النشطة
        function startRoomCleanup() {
            if (roomCleanupInterval) {
                clearInterval(roomCleanupInterval);
            }
            
            roomCleanupInterval = setInterval(() => {
                cleanupInactiveRooms();
            }, 10 * 60 * 1000); // كل 10 دقائق
        }

        // تنظيف الغرف غير النشطة
        function cleanupInactiveRooms() {
            if (!database) return;
            
            const roomsRef = database.ref('rooms');
            roomsRef.once('value', (snapshot) => {
                if (!snapshot.exists()) return;
                
                const rooms = snapshot.val();
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;
                
                Object.keys(rooms).forEach(roomId => {
                    const room = rooms[roomId];
                    if (!room.players) {
                        // حذف الغرف بدون لاعبين
                        database.ref(`rooms/${roomId}`).remove();
                        return;
                    }
                    
                    const players = Object.values(room.players);
                    const hasOnlinePlayers = players.some(p => p.online);
                    
                    if (!hasOnlinePlayers) {
                        // التحقق من آخر نشاط
                        const lastActivity = room.lastActivity || 0;
                        if (now - lastActivity > oneHour) {
                            console.log(`🗑️ حذف الغرفة غير النشطة: ${roomId}`);
                            database.ref(`rooms/${roomId}`).remove();
                        }
                    } else {
                        // تحديث آخر نشاط للغرف النشطة
                        database.ref(`rooms/${roomId}/lastActivity`).set(now);
                    }
                });
            });
        }

        // معالجة أخطاء الاتصال
        function handleConnectionError(error) {
            console.error('تفاصيل الخطأ:', {
                code: error.code,
                message: error.message,
                stack: error.stack
            });

            let errorMessage = 'خطأ في الاتصال';
            
            if (error.code === 'PERMISSION_DENIED') {
                errorMessage = 'ليس لديك صلاحية';
                console.error('🚫 مشكلة في الصلاحيات - تحقق من قواعد Firebase');
            } else if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
                errorMessage = 'مشكلة في الشبكة';
                console.error('🌐 مشكلة في الشبكة');
            } else if (error.message.includes('Firebase SDK')) {
                errorMessage = 'مشكلة في التحميل';
                console.error('📦 مشكلة في تحميل Firebase SDK');
            }

            showConnectionStatus(errorMessage, true);
            isFirebaseReady = false;

            if (connectionAttempts < maxConnectionAttempts) {
                connectionAttempts++;
                console.log(`🔄 محاولة إعادة الاتصال ${connectionAttempts}/${maxConnectionAttempts}`);
                setTimeout(() => {
                    initializeFirebase();
                }, 3000 * connectionAttempts);
            } else {
                console.error('❌ فشل في جميع محاولات الاتصال');
                showConnectionStatus('فشل الاتصال نهائياً', true);
            }
        }

        // بدء تهيئة Firebase عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            console.log('📄 تم تحميل الصفحة، بدء تهيئة Firebase...');
            initializeFirebase();
        });

        // متغيرات اللعبة
        let currentPlayer = null;
        let roomId = null;
        let gameState = null;
        let cardsVisible = false;

        // كلمات اللعبة مع خلط متقدم
        const gameWords = [
            'شمس', 'قمر', 'نجم', 'بحر', 'جبل', 'شجر', 'زهر', 'طير', 'سمك', 'أسد',
            'فيل', 'حصان', 'كتاب', 'قلم', 'ورق', 'باب', 'نافذة', 'كرسي', 'طاولة', 'سرير',
            'ماء', 'نار', 'هواء', 'تراب', 'ذهب', 'فضة', 'حديد', 'خشب', 'حجر', 'زجاج',
            'سيارة', 'طائرة', 'قطار', 'سفينة', 'دراجة', 'حاسوب', 'هاتف', 'تلفاز', 'راديو', 'ساعة',
            'مدرسة', 'بيت', 'مستشفى', 'مطعم', 'حديقة', 'شارع', 'مدينة', 'قرية', 'صحراء', 'غابة',
            'عين', 'أذن', 'فم', 'يد', 'قدم', 'رأس', 'قلب', 'عقل', 'روح', 'جسم',
            'أب', 'أم', 'ابن', 'بنت', 'أخ', 'أخت', 'جد', 'جدة', 'عم', 'خال',
            'صديق', 'معلم', 'طبيب', 'مهندس', 'فنان', 'كاتب', 'شاعر', 'مغني', 'راقص', 'لاعب'
        ];

        // خلط متقدم للكلمات لضمان عدم التكرار
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // بدء اللعبة
        function startGame() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('يرجى إدخال اسمك');
                return;
            }

            console.log('🎮 محاولة بدء اللعبة...');
            console.log('📊 حالة Firebase:', { isFirebaseReady, database: !!database });

            const startBtn = document.querySelector('.start-btn');
            
            if (!isFirebaseReady || !database) {
                console.log('⏳ Firebase غير جاهز، محاولة إعادة الاتصال...');
                
                initializeFirebase();
                
                let attempts = 0;
                const maxAttempts = 15;
                const checkConnection = setInterval(() => {
                    attempts++;
                    console.log(`🔄 فحص الاتصال ${attempts}/${maxAttempts}`);
                    
                    if (isFirebaseReady && database) {
                        clearInterval(checkConnection);
                        console.log('✅ Firebase جاهز، بدء اللعبة...');
                        proceedWithGame(name);
                    } else if (attempts >= maxAttempts) {
                        clearInterval(checkConnection);
                        console.error('❌ انتهت مهلة الانتظار');
                        showConnectionStatus('فشل الاتصال', true);
                        
                        const errorDetails = `
                        حدثت مشكلة في الاتصال:
                        
                        🔍 تشخيص المشكلة:
                        - Firebase SDK: ${typeof firebase !== 'undefined' ? '✅ محمل' : '❌ غير محمل'}
                        - قاعدة البيانات: ${database ? '✅ متاحة' : '❌ غير متاحة'}
                        - حالة الاتصال: ${isFirebaseReady ? '✅ متصل' : '❌ غير متصل'}
                        
                        💡 الحلول المقترحة:
                        1. تحقق من اتصالك بالإنترنت
                        2. أعد تحميل الصفحة
                        3. جرب متصفح آخر
                        4. تأكد من أن Firebase مُعد بشكل صحيح
                        `;
                        
                        alert(errorDetails);
                    }
                }, 1000);
                
                return;
            }

            console.log('✅ Firebase جاهز، بدء اللعبة مباشرة...');
            proceedWithGame(name);
        }

        // متابعة بدء اللعبة بعد التأكد من الاتصال
        function proceedWithGame(name) {
            localStorage.setItem('playerName', name);
            
            currentPlayer = {
                id: generateId(),
                name: name,
                online: true,
                team: null,
                role: 'player'
            };

            const roomFromUrl = getRoomIdFromUrl();
            
            if (roomFromUrl) {
                // الخروج من الغرف القديمة عند دخول رابط جديد
                leaveOldRoomsBeforeJoining();
                roomId = roomFromUrl;
                console.log('Joining existing room from URL:', roomId);
                joinExistingRoomDirectly();
            } else {
                roomId = generateRoomId();
                console.log('Creating new room:', roomId);
                joinRoom();
            }
            
            savePlayerState();
            
            console.log('Starting game with room ID:', roomId);
            console.log('Player:', currentPlayer);
            console.log('Database ready:', !!database);
            console.log('Firebase ready:', isFirebaseReady);
        }

        // الخروج من الغرف القديمة قبل الانضمام لغرفة جديدة
        function leaveOldRoomsBeforeJoining() {
            const savedState = loadPlayerState();
            if (savedState && savedState.roomId && savedState.roomId !== roomId) {
                console.log('🚪 الخروج من الغرفة القديمة:', savedState.roomId);
                database.ref(`rooms/${savedState.roomId}/players/${savedState.player.id}`).remove();
                localStorage.removeItem('gameState');
            }
        }

        // إنشاء معرف فريد
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // إنشاء معرف الغرفة
        function generateRoomId() {
            return Math.random().toString(36).substr(2, 8);
        }

        // الحصول على معرف الغرفة من الرابط
        function getRoomIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('room');
        }

        // تحديث نص زر البداية حسب الحالة
        function updateStartButtonText() {
            const startButton = document.getElementById('startGameButton');
            const roomFromUrl = getRoomIdFromUrl();
            
            if (roomFromUrl) {
                startButton.textContent = 'الدخول للغرفة';
            } else {
                startButton.textContent = 'إنشاء غرفة';
            }
        }

        // الانضمام للغرفة
        function joinRoom() {
            console.log('Joining room:', roomId);
            
            if (!database) {
                console.error('Database not initialized');
                alert('قاعدة البيانات غير جاهزة، يرجى إعادة المحاولة');
                return;
            }
            
            const roomRef = database.ref(`rooms/${roomId}`);
            
            const timeoutId = setTimeout(() => {
                console.error('Room join timeout');
                alert('انتهت مهلة الاتصال. يرجى المحاولة مرة أخرى.');
            }, 15000);
            
            roomRef.once('value', (snapshot) => {
                clearTimeout(timeoutId);
                console.log('Room snapshot exists:', snapshot.exists());
                console.log('Room data:', snapshot.val());
                
                if (!snapshot.exists()) {
                    console.log('Creating new room');
                    createNewRoom();
                } else {
                    console.log('Joining existing room');
                    joinExistingRoom();
                }
            }).catch((error) => {
                clearTimeout(timeoutId);
                console.error('Error joining room:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    details: error.details
                });
                
                if (error.code === 'PERMISSION_DENIED') {
                    alert('ليس لديك صلاحية للوصول إلى قاعدة البيانات. يرجى التحقق من إعدادات Firebase.');
                } else if (error.code === 'NETWORK_ERROR') {
                    alert('خطأ في الشبكة. يرجى التحقق من الاتصال بالإنترنت.');
                } else {
                    alert('حدث خطأ في الاتصال بقاعدة البيانات: ' + error.message);
                }
            });
        }

        // إنشاء غرفة جديدة
        function createNewRoom() {
            console.log('Creating new room with ID:', roomId);
            
            try {
                const cards = generateCards();
                console.log('Cards generated successfully:', cards.length);
                
                const validCards = cards.every(card => 
                    card && 
                    typeof card.id === 'number' && 
                    typeof card.word === 'string' && 
                    typeof card.color === 'string' && 
                    typeof card.revealed === 'boolean' &&
                    card.votes !== undefined
                );
                
                if (!validCards) {
                    throw new Error('Invalid cards generated');
                }
                
                const newGameState = {
                    players: {},
                    cards: cards,
                    currentTeam: 'red',
                    phase: 'waiting',
                    hint: null,
                    remainingGuesses: 0,
                    log: {},
                    redScore: 9,
                    blueScore: 8,
                    winner: null,
                    creator: currentPlayer.id,
                    allowTeamChange: true,
                    allowSpyChange: true,
                    lastActivity: Date.now()
                };

                newGameState.players[currentPlayer.id] = {
                    id: currentPlayer.id,
                    name: currentPlayer.name,
                    online: true,
                    team: null,
                    role: 'player'
                };
                
                console.log('New game state prepared:', newGameState);

                database.ref(`rooms/${roomId}`).set(newGameState).then(() => {
                    console.log('Room created successfully');
                    setupGameListeners();
                    showGameScreen();
                    updateUrl();
                    savePlayerState();
                }).catch((error) => {
                    console.error('Error creating room:', error);
                    alert('حدث خطأ في إنشاء الغرفة: ' + error.message);
                });
                
            } catch (error) {
                console.error('Error in createNewRoom:', error);
                alert('حدث خطأ في إعداد اللعبة: ' + error.message);
            }
        }

        // الانضمام لغرفة موجودة مباشرة (من رابط الدعوة)
        function joinExistingRoomDirectly() {
            console.log('Joining existing room directly from invite link');
            
            database.ref(`rooms/${roomId}`).once('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('الغرفة غير موجودة أو انتهت صلاحيتها');
                    window.history.replaceState({}, '', window.location.pathname);
                    location.reload();
                    return;
                }
                
                database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).set(currentPlayer).then(() => {
                    console.log('Player added to existing room directly');
                    
                    setupGameListeners();
                    showGameScreen();
                    updateUrl();
                    savePlayerState();
                    
                }).catch((error) => {
                    console.error('Error joining existing room directly:', error);
                    alert('حدث خطأ في الانضمام للغرفة: ' + error.message);
                });
            }).catch((error) => {
                console.error('Error checking room existence:', error);
                alert('حدث خطأ في التحقق من الغرفة: ' + error.message);
            });
        }

        // الانضمام لغرفة موجودة (للاستخدام الداخلي)
        function joinExistingRoom() {
            console.log('Joining existing room');
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).set(currentPlayer).then(() => {
                console.log('Player added to existing room');
                
                setupGameListeners();
                showGameScreen();
                updateUrl();
                savePlayerState();
                
            }).catch((error) => {
                console.error('Error joining existing room:', error);
                alert('حدث خطأ في الانضمام للغرفة');
            });
        }

        // إنشاء البطاقات مع خلط متقدم والتوزيع الجديد
        function generateCards() {
            const cards = [];
            
            // خلط الكلمات بطريقة متقدمة
            const shuffledWords = shuffleArray(gameWords).slice(0, 25);
            
            // التوزيع الجديد: 9 أحمر، 8 أزرق، 1 أسود، 7 محايد
            const colors = [
                'red', 'red', 'red', 'red', 'red', 'red', 'red', 'red', 'red',
                'blue', 'blue', 'blue', 'blue', 'blue', 'blue', 'blue', 'blue',
                'black',
                'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral', 'neutral'
            ];
            
            const shuffledColors = shuffleArray(colors);

            // متغيرات لتتبع الصور المستخدمة
            let redImageIndex = 1;
            let blueImageIndex = 1;
            let mistakeImageIndex = 1;

            for (let i = 0; i < 25; i++) {
                const card = {
                    id: i,
                    word: shuffledWords[i],
                    color: shuffledColors[i],
                    revealed: false,
                    votes: {},
                    revealImage: null // الصورة التي ستظهر عند الكشف
                };

                // تحديد الصورة التي ستظهر عند الكشف
                switch (card.color) {
                    case 'red':
                        card.revealImage = `RED${redImageIndex}.jpg`;
                        redImageIndex++;
                        break;
                    case 'blue':
                        card.revealImage = `BLUE${blueImageIndex}.jpg`;
                        blueImageIndex++;
                        break;
                    case 'neutral':
                        card.revealImage = `MISTAKE${mistakeImageIndex}.jpg`;
                        mistakeImageIndex++;
                        break;
                    case 'black':
                        card.revealImage = 'BLACK1.jpg';
                        break;
                }

                cards.push(card);
            }

            console.log('Generated cards:', cards.length, 'cards');
            console.log('Card colors:', cards.map(c => c.color));
            console.log('Red cards:', cards.filter(c => c.color === 'red').length);
            console.log('Blue cards:', cards.filter(c => c.color === 'blue').length);
            console.log('Neutral cards:', cards.filter(c => c.color === 'neutral').length);
            console.log('Black cards:', cards.filter(c => c.color === 'black').length);
            
            return cards;
        }

        // إعداد مستمعي الأحداث
        function setupGameListeners() {
            database.ref(`rooms/${roomId}`).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    gameState = snapshot.val();
                    updateGameDisplay();
                }
            });

            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(true);
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).onDisconnect().set(false);
        }

        // عرض شاشة اللعبة
        function showGameScreen() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('currentPlayerName').textContent = currentPlayer.name;
        }

        // تحديث الرابط
        function updateUrl() {
            try {
                if (window.location.protocol !== 'file:') {
                    const newUrl = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                    window.history.replaceState({}, '', newUrl);
                } else {
                    console.log('Running locally, skipping URL update for security');
                }
            } catch (error) {
                console.log('Cannot update URL (security restriction):', error.message);
            }
        }

        // تحديث عرض اللعبة
        function updateGameDisplay() {
            if (!gameState) return;

            updatePlayersDisplay();
            updateCardsDisplay();
            updateGameStatus();
            updateLog();
            updateHintArea();
            updateGameBackground();
        }
        
        // تحديث خلفية اللعبة حسب الفريق
        function updateGameBackground() {
            const gameScreen = document.getElementById('gameScreen');
            
            // إزالة الكلاسات السابقة
            gameScreen.classList.remove('red-turn', 'blue-turn');
            
            // إضافة الكلاس المناسب حسب الفريق الحالي
            if (gameState && gameState.currentTeam) {
                gameScreen.classList.add(`${gameState.currentTeam}-turn`);
            }
        }



        // تحديث عرض اللاعبين
        function updatePlayersDisplay() {
            const players = Object.values(gameState.players);
            const redPlayers = players.filter(p => p.team === 'red' && p.role === 'player');
            const redSpies = players.filter(p => p.team === 'red' && p.role === 'spy');
            const bluePlayers = players.filter(p => p.team === 'blue' && p.role === 'player');
            const blueSpies = players.filter(p => p.team === 'blue' && p.role === 'spy');

            document.getElementById('playerCountNum').textContent = players.length;
            
            // تحديث النقاط
            document.getElementById('redScore').textContent = gameState.redScore || 9;
            document.getElementById('blueScore').textContent = gameState.blueScore || 8;
            
            updateTeamDisplay('redPlayers', redPlayers);
            updateTeamDisplay('redSpies', redSpies);
            updateTeamDisplay('bluePlayers', bluePlayers);
            updateTeamDisplay('blueSpies', blueSpies);
        }

        // تحديث عرض الفريق
        function updateTeamDisplay(elementId, players) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';

            players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = `player-item ${player.online ? '' : 'offline'}`;
                
                playerDiv.textContent = player.name;
                
                if (gameState.creator === currentPlayer.id && player.id !== currentPlayer.id) {
                    playerDiv.style.cursor = 'pointer';
                    playerDiv.onclick = () => showKickDialog(player);
                }
                container.appendChild(playerDiv);
            });

            const isSpyRole = elementId.includes('Spies');
            const canJoin = !currentPlayer.team && 
                           (gameState.allowTeamChange !== false) && 
                           (!isSpyRole || gameState.allowSpyChange !== false) &&
                           players.length < 4;
            
            if (canJoin) {
                const joinBtn = document.createElement('div');
                joinBtn.className = 'player-item';
                joinBtn.style.cursor = 'pointer';
                joinBtn.style.background = '#e3f2fd';
                joinBtn.style.border = '2px dashed #007bff';
                joinBtn.style.color = '#000000'; 
                joinBtn.textContent = 'انضم كـ ' + (elementId.includes('Spies') ? 'سباي' : 'لاعب');
                joinBtn.onclick = () => joinTeam(elementId);
                container.appendChild(joinBtn);
            }
        }

        // الانضمام للفريق
        function joinTeam(elementId) {
            const team = elementId.includes('red') ? 'red' : 'blue';
            const role = elementId.includes('Spies') ? 'spy' : 'player';

            currentPlayer.team = team;
            currentPlayer.role = role;

            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).update({
                team: team,
                role: role
            }).then(() => {
                savePlayerState();
            });
        }

        // تحديث عرض البطاقات مع النظام الجديد للصور
        function updateCardsDisplay() {
            const grid = document.getElementById('cardsGrid');
            const container = grid.parentElement;
            
            if (!gameState || !gameState.cards || !Array.isArray(gameState.cards)) {
                console.log('Cards data not available yet');
                container.style.display = 'none';
                return;
            }
            
            if (gameState.phase !== 'waiting') {
                cardsVisible = true;
            }
            
            if (gameState.phase === 'waiting' && currentPlayer && currentPlayer.role !== 'spy') {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            grid.innerHTML = '';

            gameState.cards.forEach(card => {
                if (!card || typeof card.id === 'undefined' || !card.word) {
                    console.warn('Invalid card data:', card);
                    return;
                }
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card';
                cardDiv.id = `card-${card.id}`;

                // تطبيق خلفية السباي إذا كان اللاعب سباي
                if (currentPlayer.role === 'spy' && !card.revealed) {
                    cardDiv.classList.add('spy-view', card.color);
                }

                // إضافة صورة الكشف إذا كانت البطاقة مكشوفة
                if (card.revealed && card.revealImage) {
                    cardDiv.style.backgroundImage = `url('${card.revealImage}')`;
                    cardDiv.style.backgroundSize = 'cover';
                    cardDiv.style.backgroundPosition = 'center';
                    cardDiv.style.backgroundRepeat = 'no-repeat';
                }

                if (gameState.phase === 'guessing' && currentPlayer.team === gameState.currentTeam && currentPlayer.role === 'player' && !card.revealed) {
                    cardDiv.classList.add('can-select');
                }

                let cardContent = '';
                
                // التصويتات في الأعلى
                if (card.votes && Object.keys(card.votes).length > 0 && !card.revealed) {
                    cardContent += '<div class="voters" style="z-index: 2; position: relative;">';
                    Object.values(card.votes).forEach(vote => {
                        if (vote && vote.playerId && gameState.players && gameState.players[vote.playerId]) {
                            const voter = gameState.players[vote.playerId];
                            cardContent += `<span class="voter ${voter.team || ''}">${voter.name}</span>`;
                        }
                    });
                    cardContent += '</div>';
                } else {
                    cardContent += '<div class="voters" style="z-index: 2; position: relative;"></div>';
                }
                
                // الكلمة في الوسط
                if (card.revealed && currentPlayer.role === 'spy') {
                    cardContent += '<div style="font-size: 1.5rem; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); z-index: 2; position: relative;">✓</div>';
                } else {
                    cardContent += `<div style="color: ${card.revealed ? 'white' : '#000000'}; text-shadow: ${card.revealed ? '2px 2px 4px rgba(0,0,0,0.8)' : '1px 1px 2px rgba(255,255,255,0.8)'}; z-index: 2; position: relative;">${card.word}</div>`;
                }

                cardDiv.innerHTML = cardContent;

                // إضافة زر الاختيار
                if (cardDiv.classList.contains('can-select')) {
                    const handBtn = document.createElement('button');
                    handBtn.className = 'hand-btn';
                    handBtn.innerHTML = '✋';
                    handBtn.onclick = (e) => {
                        e.stopPropagation();
                        selectCard(card.id);
                    };
                    cardDiv.appendChild(handBtn);
                }

                // إضافة وظيفة النقر
                if (!card.revealed) {
                    cardDiv.onclick = () => voteForCard(card.id);
                } else {
                    cardDiv.style.cursor = 'default';
                }

                grid.appendChild(cardDiv);
            });
        }

        // الحصول على لون البطاقة
        function getCardColor(color) {
            switch (color) {
                case 'red': return '#dc3545';
                case 'blue': return '#007bff';
                case 'black': return '#343a40';
                case 'neutral': return '#f5deb3';
                default: return '#f5f5dc';
            }
        }

        // التصويت على البطاقة
        function voteForCard(cardId) {
            if (gameState.phase !== 'guessing' || currentPlayer.team !== gameState.currentTeam || currentPlayer.role !== 'player') {
                return;
            }

            const card = gameState.cards[cardId];
            if (card.revealed) return;

            const voteRef = database.ref(`rooms/${roomId}/cards/${cardId}/votes/${currentPlayer.id}`);
            
            if (card.votes && card.votes[currentPlayer.id]) {
                voteRef.remove();
            } else {
                voteRef.set({
                    playerId: currentPlayer.id,
                    timestamp: Date.now()
                });
            }
        }

        // تحديد البطاقة نهائياً
        function selectCard(cardId) {
            if (gameState.phase !== 'guessing' || currentPlayer.team !== gameState.currentTeam || currentPlayer.role !== 'player') {
                return;
            }

            const card = gameState.cards[cardId];
            if (card.revealed) return;

            database.ref(`rooms/${roomId}/cards/${cardId}`).update({
                revealed: true,
                votes: {}
            });

            addToLog(`${currentPlayer.name} اختار كلمة "${card.word}"`, gameState.currentTeam);

            processCardSelection(card);
        }

        // معالجة اختيار البطاقة
        function processCardSelection(card) {
            let endTurn = false;
            let gameEnded = false;

            switch (card.color) {
                case 'black':
                    const winner = gameState.currentTeam === 'red' ? 'blue' : 'red';
                    database.ref(`rooms/${roomId}/winner`).set(winner);
                    addToLog(`الفريق ${gameState.currentTeam === 'red' ? 'الأحمر' : 'الأزرق'} اختار البطاقة السوداء! فاز الفريق ${winner === 'red' ? 'الأحمر' : 'الأزرق'}!`, winner);
                    gameEnded = true;
                    break;

                case gameState.currentTeam:
                    const scoreKey = `${gameState.currentTeam}Score`;
                    const newScore = gameState[scoreKey] - 1;
                    database.ref(`rooms/${roomId}/${scoreKey}`).set(newScore);
                    
                    if (newScore === 0) {
                        database.ref(`rooms/${roomId}/winner`).set(gameState.currentTeam);
                        addToLog(`فاز الفريق ${gameState.currentTeam === 'red' ? 'الأحمر' : 'الأزرق'}!`, gameState.currentTeam);
                        gameEnded = true;
                    } else {
                        const remaining = gameState.remainingGuesses - 1;
                        database.ref(`rooms/${roomId}/remainingGuesses`).set(remaining);
                        if (remaining === 0) {
                            endTurn = true;
                        }
                    }
                    break;

                case 'neutral':
                    endTurn = true;
                    break;

                default:
                    const otherTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
                    const otherScoreKey = `${otherTeam}Score`;
                    const otherNewScore = gameState[otherScoreKey] - 1;
                    database.ref(`rooms/${roomId}/${otherScoreKey}`).set(otherNewScore);
                    
                    if (otherNewScore === 0) {
                        database.ref(`rooms/${roomId}/winner`).set(otherTeam);
                        addToLog(`فاز الفريق ${otherTeam === 'red' ? 'الأحمر' : 'الأزرق'}!`, otherTeam);
                        gameEnded = true;
                    } else {
                        endTurn = true;
                    }
                    break;
            }

            if (!gameEnded && endTurn) {
                switchTurn();
            }
        }

        // تبديل الدور
        function switchTurn() {
            const nextTeam = gameState.currentTeam === 'red' ? 'blue' : 'red';
            const nextTeamName = nextTeam === 'red' ? 'الأحمر' : 'الأزرق';
            
            database.ref(`rooms/${roomId}`).update({
                currentTeam: nextTeam,
                phase: 'hint',
                hint: null,
                remainingGuesses: 0
            });
            
            addToLog(`🔄 دور الفريق ${nextTeamName} - السباي يكتب التلميح`, nextTeam);
        }

        // تحديث حالة اللعبة
        function updateGameStatus() {
            const startBtn = document.getElementById('startGameBtn');
            
            if (gameState.winner) {
                startBtn.style.display = 'none';
            } else if (gameState.phase === 'waiting') {
                const players = Object.values(gameState.players);
                const redTeam = players.filter(p => p.team === 'red');
                const blueTeam = players.filter(p => p.team === 'blue');
                const hasRedSpy = redTeam.some(p => p.role === 'spy');
                const hasRedPlayers = redTeam.some(p => p.role === 'player');
                const hasBlueSpy = blueTeam.some(p => p.role === 'spy');
                const hasBluePlayer = blueTeam.some(p => p.role === 'player');
                
                if (gameState.creator === currentPlayer.id) {
                    startBtn.style.display = 'inline-block';
                } else {
                    startBtn.style.display = 'none';
                }
            } else {
                startBtn.style.display = 'none';
            }
        }

        // تحديث منطقة التلميح مع المربعات الجديدة
        function updateHintArea() {
            const hintArea = document.getElementById('hintArea');
            const hintDisplayArea = document.getElementById('hintDisplayArea');
            const hintDisplayInLog = document.getElementById('hintDisplayInLog');
            const logContent = document.getElementById('logContent');
            const logToggleBtn = document.getElementById('logToggleBtn');
            
            const displayHintText = document.getElementById('displayHintText');
            const displayHintNumber = document.getElementById('displayHintNumber');
            const displayHintTextInLog = document.getElementById('displayHintTextInLog');
            const displayHintNumberInLog = document.getElementById('displayHintNumberInLog');
            
            // إخفاء جميع العناصر أولاً
            hintArea.style.display = 'none';
            hintDisplayArea.style.display = 'none';
            hintDisplayInLog.style.display = 'none';
            logContent.style.display = 'block';
            logToggleBtn.style.display = 'none';
            
            // إظهار منطقة كتابة التلميح للسباي في دوره (مكان السجل)
            if (gameState.phase === 'hint' && currentPlayer.team === gameState.currentTeam && currentPlayer.role === 'spy') {
                hintArea.style.display = 'block';
                logContent.style.display = 'none';
                logToggleBtn.style.display = 'inline-block';
            } 
            // إظهار التلميح مكان السجل للفريق الحالي (لاعبين وسباي)
            else if (gameState.phase === 'guessing' && currentPlayer.team === gameState.currentTeam) {
                hintDisplayInLog.style.display = 'block';
                logContent.style.display = 'none';
                logToggleBtn.style.display = 'inline-block';
                
                displayHintTextInLog.textContent = gameState.hint.text;
                displayHintNumberInLog.textContent = gameState.hint.number;
                
                // إخفاء زر إنهاء الدور للسباي
                const endTurnArea = hintDisplayInLog.querySelector('.end-turn-area');
                if (endTurnArea) {
                    if (currentPlayer.role === 'spy') {
                        endTurnArea.style.display = 'none';
                    } else {
                        endTurnArea.style.display = 'block';
                    }
                }
            }
            // إظهار التلميح في المكان العادي فوق البطاقات للفرق الأخرى
            else if (gameState.phase === 'guessing' && gameState.hint) {
                hintDisplayArea.style.display = 'block';
                displayHintText.textContent = gameState.hint.text;
                displayHintNumber.textContent = gameState.hint.number;
            }
        }

        // إرسال التلميح مع القائمة المنسدلة
        function sendHint() {
            const hintText = document.getElementById('hintInput').value.trim();
            if (!hintText) {
                return;
            }

            const numberSelect = document.getElementById('numberSelect');
            const selectedNumber = parseInt(numberSelect.value);

            const hint = {
                text: hintText,
                number: selectedNumber,
                spy: currentPlayer.name
            };

            database.ref(`rooms/${roomId}`).update({
                hint: hint,
                phase: 'guessing',
                remainingGuesses: selectedNumber + 1
            });

            addToLog(`${currentPlayer.name} أعطى تلميح: "${hintText}" (${selectedNumber})`, gameState.currentTeam);
            
            document.getElementById('hintInput').value = '';
            numberSelect.value = '1';
        }

        // إنهاء الدور
        function endTurn() {
            if (currentPlayer.team === gameState.currentTeam && currentPlayer.role === 'player') {
                const currentTeamName = gameState.currentTeam === 'red' ? 'الأحمر' : 'الأزرق';
                addToLog(`الفريق ${currentTeamName} أنهى دوره`, gameState.currentTeam);
                switchTurn();
            }
        }

        // بدء اللعبة (للمنشئ فقط)
        function startGamePlay() {
            if (gameState.creator !== currentPlayer.id) {
                alert('فقط منشئ الروم يمكنه بدء اللعبة');
                return;
            }

            if (gameState.phase !== 'waiting') {
                alert('اللعبة بدأت بالفعل');
                return;
            }

            database.ref(`rooms/${roomId}`).update({
                phase: 'hint',
                currentTeam: 'red',
                hint: null,
                remainingGuesses: 0
            }).then(() => {
                cardsVisible = true;
                updateCardsDisplay();
                updateGameStatus();
                addToLog(`🎮 ${currentPlayer.name} بدأ اللعبة! الكلمات ظهرت للجميع`, null);
                addToLog(`🔴 دور الفريق الأحمر - السباي يكتب التلميح`, 'red');
            }).catch((error) => {
                console.error('Error starting game:', error);
                alert('حدث خطأ في بدء اللعبة');
            });
        }

        // إظهار نافذة سجل الأحداث المنبثقة
        function showLogModal() {
            const modal = document.getElementById('logModal');
            modal.classList.add('show');
            updateLogModal();
            closeAllDropdowns();
        }

        // إغلاق نافذة سجل الأحداث المنبثقة
        function closeLogModal() {
            const modal = document.getElementById('logModal');
            modal.classList.remove('show');
        }

        // تحديث محتوى نافذة سجل الأحداث المنبثقة
        function updateLogModal() {
            const modalBody = document.getElementById('logModalBody');
            
            modalBody.innerHTML = '';

            if (!gameState || !gameState.log || Object.keys(gameState.log).length === 0) {
                modalBody.innerHTML = '<div class="log-modal-empty">لا توجد أحداث بعد...</div>';
                return;
            }

            const sortedEntries = Object.values(gameState.log).sort((a, b) => b.timestamp - a.timestamp);
            
            sortedEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = `log-entry ${entry.team || ''}`;
                
                // إضافة الوقت
                const timeDiv = document.createElement('div');
                timeDiv.className = 'log-entry-time';
                const date = new Date(entry.timestamp);
                timeDiv.textContent = date.toLocaleTimeString('ar-SA', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                entryDiv.textContent = entry.message;
                entryDiv.appendChild(timeDiv);
                modalBody.appendChild(entryDiv);
            });
        }

        // تبديل عرض سجل الأحداث (للتوافق مع الكود القديم)
        function toggleLogPanel() {
            showLogModal();
        }

        // إضافة للسجل مع التمرير التلقائي
        function addToLog(message, teamOverride = null) {
            if (!database || !roomId) {
                console.log('Cannot add to log: database or roomId not ready');
                return;
            }
            
            const logEntry = {
                message: message,
                timestamp: Date.now(),
                team: teamOverride || (gameState && gameState.currentTeam) ? gameState.currentTeam : null
            };

            database.ref(`rooms/${roomId}/log`).push(logEntry).catch((error) => {
                console.error('Error adding to log:', error);
            });
        }

        // تحديث السجل مع التمرير التلقائي
        function updateLog() {
            const logDiv = document.getElementById('gameLog');
            
            logDiv.innerHTML = '';

            if (gameState.log) {
                const sortedEntries = Object.values(gameState.log).sort((a, b) => b.timestamp - a.timestamp);
                
                sortedEntries.slice(0, 10).forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = `log-entry ${entry.team || ''}`;
                    entryDiv.textContent = entry.message;
                    logDiv.appendChild(entryDiv);
                });
            }
        }

        // إعادة تشغيل اللعبة
        function resetGame() {
            if (!gameState || gameState.creator !== currentPlayer.id) {
                return;
            }

            try {
                console.log('🔄 بدء إعادة تشغيل اللعبة...');
                
                const newCards = generateCards();
                console.log('✅ تم إنشاء بطاقات جديدة');
                
                const resetData = {
                    cards: newCards,
                    currentTeam: 'red',
                    phase: 'waiting',
                    hint: null,
                    remainingGuesses: 0,
                    log: {},
                    redScore: 9,
                    blueScore: 8,
                    winner: null,
                    lastActivity: Date.now()
                };

                database.ref(`rooms/${roomId}`).update(resetData).then(() => {
                    console.log('✅ تم إعادة تشغيل اللعبة بنجاح');
                    addToLog(`🔄 ${currentPlayer.name} أعاد تشغيل اللعبة - بطاقات جديدة!`, null);
                    
                    showingColors = false;
                    cardsVisible = false;
                    updateCardsDisplay();
                    updateGameStatus();
                }).catch((error) => {
                    console.error('❌ خطأ في إعادة تشغيل اللعبة:', error);
                });
            } catch (error) {
                console.error('❌ خطأ في إنشاء البطاقات الجديدة:', error);
            }
        }

        // متغير لحفظ بيانات اللاعب المراد طرده
        let playerToKick = null;

        // إظهار نافذة تأكيد الطرد
        function showKickDialog(player) {
            if (gameState.creator !== currentPlayer.id) {
                return;
            }
            
            playerToKick = player;
            const dialog = document.getElementById('kickDialog');
            const message = document.getElementById('kickDialogMessage');
            
            const teamText = player.team ? 
                (player.team === 'red' ? 'الأحمر' : 'الأزرق') : 
                'بدون فريق';
            const roleText = player.role === 'spy' ? 'سباي' : 'لاعب';
            
            message.innerHTML = `
                هل أنت متأكد من طرد اللاعب:<br>
                <strong>${player.name}</strong><br>
                <small>(${roleText} - ${teamText})</small>
            `;
            
            dialog.classList.add('show');
            closeAllDropdowns();
        }

        // تأكيد الطرد
        function confirmKick() {
            if (!playerToKick || gameState.creator !== currentPlayer.id) {
                return;
            }

            database.ref(`rooms/${roomId}/players/${playerToKick.id}`).remove().then(() => {
                cancelKick();
            }).catch((error) => {
                console.error('Error kicking player:', error);
                cancelKick();
            });
        }

        // إلغاء الطرد
        function cancelKick() {
            const dialog = document.getElementById('kickDialog');
            dialog.classList.remove('show');
            playerToKick = null;
        }

        // طرد لاعب (للتوافق مع الكود القديم)
        function kickPlayer(playerId) {
            if (gameState.creator !== currentPlayer.id) {
                return;
            }
            
            const player = gameState.players[playerId];
            if (player) {
                showKickDialog(player);
            }
        }

        // ترك الفريق
        function leaveTeam() {
            if (!currentPlayer.team) {
                return;
            }

            const oldTeam = currentPlayer.team;
            const oldRole = currentPlayer.role;
            
            currentPlayer.team = null;
            currentPlayer.role = 'player';
            
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).update({
                team: null,
                role: 'player'
            }).then(() => {
                console.log('Successfully left team');
            }).catch((error) => {
                console.error('Error leaving team:', error);
                currentPlayer.team = oldTeam;
                currentPlayer.role = oldRole;
            });
        }

        // الخروج من الروم
        function leaveRoom() {
            try {
                if (database && roomId && currentPlayer) {
                    database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).remove().then(() => {
                        console.log('Player removed from room');
                    }).catch((error) => {
                        console.error('Error removing player:', error);
                    });
                }

                localStorage.removeItem('gameState');
                console.log('Saved game state cleared');

                currentPlayer = null;
                roomId = null;
                gameState = null;
                showingColors = false;

                window.history.replaceState({}, '', window.location.pathname);

                document.getElementById('gameScreen').style.display = 'none';
                document.getElementById('startScreen').style.display = 'flex';
                document.getElementById('playerName').value = '';

                // تحديث نص الزر بعد الخروج
                updateStartButtonText();

            } catch (error) {
                console.error('Error leaving room:', error);
            }
        }

        // إغلاق جميع القوائم المنسدلة
        function closeAllDropdowns() {
            document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // تحديد موقع القائمة المنسدلة لتبقى داخل الشاشة
        function positionDropdown(dropdown, triggerElement) {
            const rect = triggerElement.getBoundingClientRect();
            const dropdownRect = dropdown.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = rect.left;
            let top = rect.bottom + 5;
            
            if (left + dropdownRect.width > viewportWidth - 10) {
                left = viewportWidth - dropdownRect.width - 10;
            }
            if (left < 10) {
                left = 10;
            }
            
            if (top + dropdownRect.height > viewportHeight - 10) {
                top = rect.top - dropdownRect.height - 5;
                if (top < 10) {
                    top = Math.max(10, (viewportHeight - dropdownRect.height) / 2);
                }
            }
            
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
        }

        // إغلاق القوائم عند النقر خارجها
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                closeAllDropdowns();
            }
            
            if (event.target.classList.contains('kick-dialog')) {
                cancelKick();
            }
            
            if (event.target.classList.contains('log-modal')) {
                closeLogModal();
            }
        });

        // تبديل قائمة اللاعبين
        function togglePlayersDropdown() {
            const dropdown = document.getElementById('playersDropdown');
            const trigger = document.getElementById('playersCount');
            
            if (dropdown.classList.contains('show')) {
                closeAllDropdowns();
                return;
            }
            
            closeAllDropdowns();
            dropdown.classList.add('show');
            updatePlayersDropdown();
            setTimeout(() => {
                positionDropdown(dropdown, trigger);
            }, 10);
        }

        // تحديث محتوى قائمة اللاعبين
        function updatePlayersDropdown() {
            if (!gameState || !gameState.players) {
                return;
            }

            const container = document.getElementById('playersDropdownContent');
            const players = Object.values(gameState.players);
            const isCreator = gameState.creator === currentPlayer.id;

            let content = '';

            // قسم مشاركة الروم في البداية
            content += `<div class="dropdown-section">`;
            content += `<div class="dropdown-section-title">🔗 مشاركة الروم</div>`;
            
            if (window.location.protocol === 'file:') {
                content += `<div class="dropdown-info">`;
                content += `رقم الروم: <strong>${roomId}</strong><br>`;
                content += `شارك هذا الرقم مع الأصدقاء للانضمام`;
                content += `</div>`;
                content += `<button class="dropdown-button success" onclick="copyRoomId(); closeAllDropdowns();">نسخ رقم الروم</button>`;
            } else {
                const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
                content += `<div class="dropdown-link">${link}</div>`;
                content += `<button class="dropdown-button success" onclick="copyRoomLinkFromDropdown(); closeAllDropdowns();">نسخ رابط الروم</button>`;
            }
            content += `</div>`;

            content += `<div class="dropdown-info">`;
            content += `🏠 رقم الروم: <strong>${roomId}</strong><br>`;
            content += `👥 عدد اللاعبين: <strong>${players.length}</strong><br>`;
            content += `🎮 حالة اللعبة: <strong>${getGamePhaseText()}</strong>`;
            content += `</div>`;

            const redTeam = players.filter(p => p.team === 'red');
            const blueTeam = players.filter(p => p.team === 'blue');
            const noTeam = players.filter(p => !p.team);

            if (redTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">🔴 الفريق الأحمر (${redTeam.length})</div>`;
                redTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            if (blueTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">🔵 الفريق الأزرق (${blueTeam.length})</div>`;
                blueTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            if (noTeam.length > 0) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">⚪ بدون فريق (${noTeam.length})</div>`;
                noTeam.forEach(player => {
                    content += createPlayerItem(player, isCreator);
                });
                content += `</div>`;
            }

            if (isCreator) {
                content += `<div class="dropdown-info">`;
                content += `👑 <strong>صلاحياتك كمنشئ:</strong><br>`;
                content += `• طرد اللاعبين<br>`;
                content += `• إعادة تشغيل اللعبة<br>`;
                content += `• التحكم في تغيير الفرق<br>`;
                content += `• التحكم في الانتقال للسباي`;
                content += `</div>`;
            } else {
                const creatorName = gameState.players[gameState.creator]?.name || 'غير معروف';
                content += `<div class="dropdown-info">`;
                content += `👑 منشئ الروم: <strong>${creatorName}</strong>`;
                content += `</div>`;
            }

            container.innerHTML = content;
        }

        // إنشاء عنصر لاعب
        function createPlayerItem(player, isCreator) {
            const teamClass = player.team || 'no-team';
            const statusClass = player.online ? 'online' : 'offline';
            const isCurrentPlayer = player.id === currentPlayer.id;
            
            let roleText = '';
            let roleClass = '';
            
            if (player.id === gameState.creator) {
                roleText = 'منشئ';
                roleClass = 'creator';
            } else if (player.role === 'spy') {
                roleText = 'سباي';
                roleClass = 'spy';
            } else {
                roleText = 'لاعب';
                roleClass = '';
            }

            let item = `<div class="dropdown-item ${teamClass}">`;
            item += `<div>`;
            item += `<span class="player-role ${roleClass}">${roleText}</span>`;
            item += `${player.name}`;
            item += `<span class="status-indicator ${statusClass}"></span>`;
            item += `</div>`;
            
            if (isCreator && !isCurrentPlayer) {
                item += `<button class="dropdown-button danger" onclick="showKickDialog(${JSON.stringify(player).replace(/"/g, '&quot;')})">طرد</button>`;
            }
            
            item += `</div>`;
            
            return item;
        }

        // تبديل قائمة إعادة التشغيل
        function toggleResetDropdown() {
            const dropdown = document.getElementById('resetDropdown');
            const trigger = event.target;
            
            if (dropdown.classList.contains('show')) {
                closeAllDropdowns();
                return;
            }
            
            closeAllDropdowns();
            dropdown.classList.add('show');
            updateResetDropdown();
            setTimeout(() => {
                positionDropdown(dropdown, trigger);
            }, 10);
        }

        // تحديث محتوى قائمة إعادة التشغيل
        function updateResetDropdown() {
            const container = document.getElementById('resetDropdownContent');
            const isCreator = gameState && gameState.creator === currentPlayer.id;

            let content = '';

            if (!isCreator) {
                content += `<div class="dropdown-info">`;
                content += `🚫 فقط منشئ الروم يمكنه إعادة تشغيل اللعبة`;
                content += `</div>`;
            } else {
                content += `<div class="dropdown-info">`;
                content += `🔄 <strong>إعادة تشغيل اللعبة</strong><br><br>`;
                content += `✅ <strong>سيتم الاحتفاظ بـ:</strong><br>`;
                content += `• جميع اللاعبين وفرقهم<br>`;
                content += `• إعدادات الروم<br><br>`;
                content += `🔄 <strong>سيتم إعادة تعيين:</strong><br>`;
                content += `• البطاقات (كلمات جديدة)<br>`;
                content += `• النقاط والسجل<br>`;
                content += `• حالة اللعبة`;
                content += `</div>`;
                
                content += `<button class="dropdown-button warning" onclick="resetGame(); closeAllDropdowns();">تأكيد إعادة التشغيل</button>`;
            }

            container.innerHTML = content;
        }

        // تبديل قائمة اللاعب
        function togglePlayerDropdown() {
            const dropdown = document.getElementById('playerDropdown');
            const trigger = document.getElementById('playerNameBtn');
            
            if (dropdown.classList.contains('show')) {
                closeAllDropdowns();
                return;
            }
            
            closeAllDropdowns();
            dropdown.classList.add('show');
            updatePlayerDropdown();
            setTimeout(() => {
                positionDropdown(dropdown, trigger);
            }, 10);
        }

        // تحديث محتوى قائمة اللاعب
        function updatePlayerDropdown() {
            const container = document.getElementById('playerDropdownContent');
            const isCreator = gameState && gameState.creator === currentPlayer.id;

            let content = '';

            content += `<div class="dropdown-section">`;
            content += `<div class="dropdown-section-title">تغيير الاسم</div>`;
            content += `<input type="text" id="newPlayerName" value="${currentPlayer.name}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 0.9rem;" maxlength="20">`;
            content += `<button class="dropdown-button" onclick="changePlayerNameDirect(); closeAllDropdowns();">تغيير الاسم</button>`;
            content += `</div>`;

            if (gameState && gameState.allowTeamChange !== false && currentPlayer.team) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">الفريق</div>`;
                content += `<button class="dropdown-button warning" onclick="leaveTeam(); closeAllDropdowns();">ترك الفريق</button>`;
                content += `</div>`;
            }

            if (isCreator) {
                content += `<div class="dropdown-section">`;
                content += `<div class="dropdown-section-title">إعدادات المنشئ</div>`;
                const allowTeamText = gameState.allowTeamChange !== false ? 'منع تغيير الفرق' : 'السماح بتغيير الفرق';
                const allowSpyText = gameState.allowSpyChange !== false ? 'منع الانتقال للسباي' : 'السماح بالانتقال للسباي';
                content += `<button class="dropdown-button" onclick="toggleTeamChangeSettings(); closeAllDropdowns();">${allowTeamText}</button>`;
                content += `<button class="dropdown-button" onclick="toggleSpyChangeSettings(); closeAllDropdowns();">${allowSpyText}</button>`;
                content += `</div>`;
            }

            content += `<div class="dropdown-section">`;
            content += `<button class="dropdown-button danger" onclick="leaveRoom(); closeAllDropdowns();">الخروج من الروم</button>`;
            content += `</div>`;

            container.innerHTML = content;
        }



        // نسخ الرابط من القائمة المنسدلة
        function copyRoomLinkFromDropdown() {
            const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(() => {
                    console.log('Link copied successfully');
                }).catch(() => {
                    fallbackCopyMethod(link);
                });
            } else {
                fallbackCopyMethod(link);
            }
        }

        // نسخ رقم الروم فقط (للتشغيل المحلي)
        function copyRoomId() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(roomId).then(() => {
                    console.log('Room ID copied successfully');
                    alert('تم نسخ رقم الروم!');
                }).catch(() => {
                    fallbackCopyMethod(roomId);
                });
            } else {
                fallbackCopyMethod(roomId);
            }
        }

        // تغيير الاسم مباشرة من مربع النص
        function changePlayerNameDirect() {
            const newNameInput = document.getElementById('newPlayerName');
            if (!newNameInput) return;
            
            const newName = newNameInput.value.trim();
            if (!newName || newName === currentPlayer.name) {
                alert('يرجى إدخال اسم جديد مختلف');
                return;
            }
            
            if (newName.length > 20) {
                alert('الاسم طويل جداً (الحد الأقصى 20 حرف)');
                return;
            }
            
            const oldName = currentPlayer.name;
            currentPlayer.name = newName;
            
            localStorage.setItem('playerName', currentPlayer.name);
            
            database.ref(`rooms/${roomId}/players/${currentPlayer.id}/name`).set(currentPlayer.name).then(() => {
                document.getElementById('currentPlayerName').textContent = currentPlayer.name;
            }).catch((error) => {
                console.error('Error changing name:', error);
                alert('حدث خطأ في تغيير الاسم');
                currentPlayer.name = oldName;
                localStorage.setItem('playerName', oldName);
                document.getElementById('currentPlayerName').textContent = oldName;
            });
        }

        // تبديل إعدادات تغيير الفرق
        function toggleTeamChangeSettings() {
            const newSetting = !(gameState.allowTeamChange !== false);
            
            database.ref(`rooms/${roomId}/allowTeamChange`).set(newSetting).then(() => {
                console.log('Team change settings updated');
            }).catch((error) => {
                console.error('Error changing team settings:', error);
            });
        }

        // تبديل إعدادات تغيير السباي
        function toggleSpyChangeSettings() {
            const newSetting = !(gameState.allowSpyChange !== false);
            
            database.ref(`rooms/${roomId}/allowSpyChange`).set(newSetting).then(() => {
                console.log('Spy change settings updated');
            }).catch((error) => {
                console.error('Error changing spy settings:', error);
            });
        }

        // الحصول على نص مرحلة اللعبة
        function getGamePhaseText() {
            if (!gameState) return 'غير معروف';
            
            switch (gameState.phase) {
                case 'waiting': return 'في الانتظار';
                case 'hint': return 'كتابة التلميح';
                case 'guessing': return 'التخمين';
                default: return gameState.winner ? 'انتهت' : 'غير معروف';
            }
        }

        // طريقة بديلة لنسخ النص
        function fallbackCopyMethod(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                console.log('Text copied using fallback method');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                prompt('انسخ هذا الرابط:', text);
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // حفظ حالة اللاعب
        function savePlayerState() {
            if (currentPlayer && roomId) {
                const gameState = {
                    player: currentPlayer,
                    roomId: roomId,
                    timestamp: Date.now()
                };
                localStorage.setItem('gameState', JSON.stringify(gameState));
                console.log('Game state saved:', gameState);
            }
        }

        // استرجاع حالة اللاعب
        function loadPlayerState() {
            try {
                const savedState = localStorage.getItem('gameState');
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    console.log('Found saved game state:', gameState);
                    
                    const hoursSinceLastSave = (Date.now() - gameState.timestamp) / (1000 * 60 * 60);
                    if (hoursSinceLastSave < 24) {
                        return gameState;
                    } else {
                        console.log('Saved state is too old, ignoring');
                        localStorage.removeItem('gameState');
                    }
                }
            } catch (error) {
                console.error('Error loading saved state:', error);
                localStorage.removeItem('gameState');
            }
            return null;
        }

        // التحقق من الحالة المحفوظة عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            const savedName = localStorage.getItem('playerName');
            if (savedName) {
                document.getElementById('playerName').value = savedName;
            }

            // تحديث نص الزر عند تحميل الصفحة
            updateStartButtonText();

            // إذا كان هناك رابط جديد، احذف الحالة القديمة مباشرة
            const roomFromUrl = getRoomIdFromUrl();
            if (roomFromUrl) {
                localStorage.removeItem('gameState');
                return;
            }

            const savedState = loadPlayerState();
            if (savedState && savedState.roomId && savedState.player) {
                console.log('Attempting to restore saved game state');
                
                currentPlayer = savedState.player;
                roomId = savedState.roomId;
                
                document.getElementById('playerName').value = currentPlayer.name;
                
                if (isFirebaseReady && database) {
                    rejoinSavedRoom();
                } else {
                    const checkFirebase = setInterval(() => {
                        if (isFirebaseReady && database) {
                            clearInterval(checkFirebase);
                            rejoinSavedRoom();
                        }
                    }, 500);
                }
            }
        });

        // إعادة الانضمام للروم المحفوظ
        function rejoinSavedRoom() {
            console.log('Attempting to rejoin saved room:', roomId);
            
            database.ref(`rooms/${roomId}`).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    console.log('Saved room exists, rejoining...');
                    
                    currentPlayer.online = true;
                    
                    database.ref(`rooms/${roomId}/players/${currentPlayer.id}`).set(currentPlayer).then(() => {
                        console.log('Successfully rejoined saved room');
                        
                        setupGameListeners();
                        showGameScreen();
                        updateUrl();
                        
                    }).catch((error) => {
                        console.error('Error rejoining saved room:', error);
                        handleRejoinError();
                    });
                } else {
                    console.log('Saved room no longer exists');
                    handleRejoinError();
                }
            }).catch((error) => {
                console.error('Error checking saved room:', error);
                handleRejoinError();
            });
        }

        // معالجة خطأ إعادة الانضمام
        function handleRejoinError() {
            alert('لا يمكن العودة للجلسة المحفوظة. الروم قد يكون انتهى أو حدث خطأ.');
            
            localStorage.removeItem('gameState');
            
            currentPlayer = null;
            roomId = null;
            gameState = null;
            
            // تحديث نص الزر بعد فشل إعادة الانضمام
            updateStartButtonText();
            
            console.log('Staying on start screen due to rejoin error');
        }

        // تنظيف الموارد عند إغلاق الصفحة
        window.addEventListener('beforeunload', function() {
            if (database && roomId && currentPlayer) {
                database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(false);
            }
        });

        // معالجة تغيير حالة الاتصال
        window.addEventListener('online', function() {
            console.log('Connection restored');
            updatePlayerOnlineStatus(true);
        });

        window.addEventListener('offline', function() {
            console.log('Connection lost');
        });

        // معالجة تغيير حالة المتصفح (دخول/خروج من التبويب)
        document.addEventListener('visibilitychange', function() {
            if (database && roomId && currentPlayer) {
                const isVisible = !document.hidden;
                updatePlayerOnlineStatus(isVisible);
            }
        });

        console.log('🎮 مرابط - تم تحميل الكود بنجاح مع جميع التحسينات');
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'991f36a8425f8308',t:'MTc2MTAzMzU0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
