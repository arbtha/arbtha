<!doctype html>
<html lang="ar" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ù…Ø±Ø§Ø¨Ø·</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }
        
        html, body {
            height: 100%;
        }
        
        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .start-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: url('mainbg.jpg') center/cover no-repeat;
            border-radius: 20px;
            padding: 40px 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            position: relative;
        }
        
        /* Ø®Ù„ÙÙŠØ§Øª Ù…Ø®ØµØµØ© Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
        @media (min-width: 1024px) {
            .start-screen {
                background: url('mainbgpc.jpg') center/cover no-repeat;
            }
        }
        
        .start-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            z-index: 1;
        }
        
        .start-screen > * {
            position: relative;
            z-index: 2;
        }
        
        .game-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }
        
        .name-input {
            width: 100%;
            max-width: 250px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            outline: none;
            transition: border-color 0.3s;
            background: rgba(255,255,255,0.9);
        }
        
        .name-input:focus {
            border-color: #667eea;
            background: white;
        }
        
        .start-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 32px;
            font-size: 1.1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(45deg, #218838, #1ea080);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .game-screen {
            display: none;
            height: 100%;
            flex-direction: column;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease;
            padding: 10px;
            box-sizing: border-box;
            /* Ø¥Ø¶Ø§ÙØ© Ø®Ø§ØµÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ù† Ù„ØªØ³Ù‡ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± */
            display: flex;
        }
        
        .game-screen.red-turn {
            background-image: url('redteamturn.jpg');
        }
        
        .game-screen.blue-turn {
            background-image: url('blueteamturn.jpg');
        }
        
        /* Ø®Ù„ÙÙŠØ§Øª Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± ÙˆØ³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
        @media (min-width: 1024px) {
            .game-screen.red-turn {
                background-image: url('redteamturnpc.jpg');
            }
            
            .game-screen.blue-turn {
                background-image: url('blueteamturnpc.jpg');
            }
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .toolbar {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0; /* ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
        }
        
        .toolbar-item {
            display: flex;
            align-items: center;
            gap: 3px;
            background: #f8f9fa;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            white-space: nowrap;
        }
        
        .toolbar-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .toolbar-btn {
            background: #28a745;
            color: white;
            border: 2px solid #28a745;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .toolbar-btn:hover {
            background: #218838;
            border-color: #218838;
            transform: translateY(-1px);
        }
        
        .toolbar-btn.secondary {
            background: #ffc107;
            color: #333;
            border-color: #ffc107;
        }
        
        .toolbar-btn.secondary:hover {
            background: #e0a800;
            border-color: #e0a800;
        }
        
        .toolbar-btn.info {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }
        
        .toolbar-btn.info:hover {
            background: #138496;
            border-color: #138496;
        }
        
        .player-name-btn {
            background: #f8f9fa;
            border: 2px solid #28a745;
            color: #333;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .player-name-btn:hover {
            background: #e8f5e8;
            transform: translateY(-1px);
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© .game-area Ù„Ø£Ù† .game-screen Ù‡Ùˆ Ø§Ù„Ø­Ø§ÙˆÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø¢Ù† */
        
        /* Ø­Ø§ÙˆÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .cards-container {
            flex: 1; /* ÙŠØ³Ù…Ø­ Ù„Ù„Ø­Ø§ÙˆÙŠØ© Ø¨Ø§Ù„Ù†Ù…Ùˆ Ù„Ù…Ù„Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 0;
        }
        
        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            height: 100%;
            width: 100%;
            padding: 0;
            overflow: hidden;
            aspect-ratio: 5/3.33; /* Ù†Ø³Ø¨Ø© ØªØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ØµÙˆØ± 600Ã—400 */
        }
        
        .card {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
            border: 2px solid #ddd;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: clamp(0.4rem, 1.5vw, 0.8rem);
            font-weight: bold;
            text-align: center;
            padding: 2px;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            color: #000000;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
            aspect-ratio: 3/2; /* Ù†Ø³Ø¨Ø© 600:400 = 3:2 Ù„ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© */
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ */
        @media (min-width: 1024px) {
            .container {
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                height: 100vh;
                padding: 8px;
                overflow: hidden;
            }
            
            .toolbar {
                padding: 8px;
                margin-bottom: 8px;
                font-size: 0.85rem;
            }
            
            .cards-container {
                flex: 1;
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                padding: 10px;
                margin-bottom: 10px;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            
            .cards-grid {
                height: 100%;
                width: 100%;
                padding: 0;
                gap: 4px;
                overflow: hidden;
            }
            
            .card {
                font-size: clamp(0.5rem, 1.2vw, 0.9rem);
                padding: 2px;
            }
            
            /* ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ ÙÙ‚Ø· */
            .teams-bottom-area {
                height: 140px;
                flex-shrink: 0;
            }
            
            .team-panel, .log-panel {
                padding: 8px;
                font-size: 0.85rem;
            }
            
            .hint-display-area {
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .hint-area {
                padding: 6px;
            }
            
            .end-turn-area {
                padding: 6px;
                margin-bottom: 6px;
            }
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .card.revealed {
            color: white;
        }
        
        .card.red {
            background: #dc3545;
        }
        
        .card.blue {
            background: #007bff;
        }
        
        .card.black {
            background: #343a40;
        }
        
        .card.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view.neutral {
            background: #f5deb3;
            color: #000000;
        }
        
        .card.spy-view {
            color: white;
            font-weight: bold;
        }
        
        .card.spy-view.red {
            background: url('REDSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.blue {
            background: url('BLUESPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.black {
            background: url('BLACKSPYBG.jpg') center/cover no-repeat;
        }
        
        .card.spy-view.neutral {
            background: url('BAGEALLBG.jpg') center/cover no-repeat;
        }
        
        .card.revealed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            z-index: 10;
        }
        
        .revealed-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 6px;
            z-index: 10;
        }
        
        .hand-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ffc107;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            display: none;
        }
        
        .card.can-select .hand-btn {
            display: block;
        }
        
        .voters {
            font-size: 0.6rem;
            margin-top: 2px;
            align-self: stretch;
            text-align: center;
        }
        
        .voter {
            display: inline-block;
            margin: 2px;
            padding: 2px 5px;
            border-radius: 5px;
            color: white;
        }
        
        .voter.red {
            background: #dc3545;
        }
        
        .voter.blue {
            background: #007bff;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ù‚ */
        /* ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ .bottom-area Ø¨Ù€ .teams-bottom-area Ù„ÙŠØ¶Ù… Ø§Ù„ÙØ±Ù‚ ÙÙ‚Ø· */
        .teams-bottom-area {
            display: flex;
            gap: 5px;
            height: 180px; /* Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙÙŠ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
            flex-shrink: 0;
        }
        
        @media (min-width: 1024px) {
            .teams-bottom-area {
                height: 140px;
            }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ù„ÙˆØ§Ø­ */
        .team-panel {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 10px;
            overflow-y: auto;
        }
        
        .team-panel.red {
            border-top: 4px solid #dc3545;
        }
        
        .team-panel.blue {
            border-top: 4px solid #007bff;
        }
        
        .team-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .team-section {
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #666;
        }
        
        .player-item {
            background: #f8f9fa;
            padding: 5px 8px;
            margin: 3px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.15);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            width: fit-content;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .player-item.offline {
            opacity: 0.5;
        }
        
        .kick-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 2px 6px;
            font-size: 0.7rem;
            cursor: pointer;
        }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« - ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡ Ù„ÙŠØµØ¨Ø­ ÙÙŠ ØµÙ Ø®Ø§Øµ */
        .log-panel {
            flex-shrink: 0;
            background: rgba(240,240,240,0.95);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 8px; /* Ø¥Ø¶Ø§ÙØ© Ù‡Ø§Ù…Ø´ Ù„ÙØµÙ„Ù‡Ø§ Ø¹Ù† Ø§Ù„ÙØ±Ù‚ */
        }

        .log-panel #gameLog {
            max-height: 80px; /* ØªØ­Ø¯ÙŠØ¯ Ø§Ø±ØªÙØ§Ø¹ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø³Ø¬Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
             .log-panel #gameLog {
                max-height: 100px; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
            }
        }
        
        .log-title {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1rem;
        }
        
        .log-entry {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 4px solid #ddd;
        }
        
        .log-entry.red {
            border-left-color: #dc3545;
        }
        
        .log-entry.blue {
            border-left-color: #007bff;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­ */
        .hint-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            display: none;
            flex-shrink: 0;
        }
        
        .hint-area.active {
            display: block;
        }
        
        .hint-input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .hint-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .number-select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            background: white;
            cursor: pointer;
            margin: 0 10px;
        }
        
        .number-select:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .send-hint-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .end-turn-btn {
            background: #ffc107;
            color: #333;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 6px;
            font-size: 0.9rem;
        }

        .end-turn-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .hint-display-area {
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        .hint-display-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }
        
        .hint-box, .number-box {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #ddd;
            min-width: 80px;
        }
        
        .hint-label, .number-label {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .hint-text, .number-text {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
        }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .game-status {
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }
        
        .current-hint {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: fixed;
            background-color: white;
            min-width: 280px;
            max-width: 90vw;
            width: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 10px;
            border: 2px solid #ddd;
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .dropdown-content.show {
            display: block;
        }
        
        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .dropdown-content {
                min-width: 260px;
                max-width: 95vw;
                max-height: 60vh;
                font-size: 0.9rem;
            }
            
            .dropdown-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .dropdown-info {
                font-size: 0.75rem;
                line-height: 1.3;
            }
            
            .dropdown-link {
                font-size: 0.7rem;
                word-break: break-all;
            }
            
            .hint-display-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .hint-box, .number-box {
                min-width: 100px;
            }

            /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ */
            .teams-bottom-area {
                height: 160px;
                flex-shrink: 0;
            }
        }
        
        .dropdown-header {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            color: #333;
            text-align: center;
        }
        
        .dropdown-section {
            margin-bottom: 15px;
        }
        
        .dropdown-section-title {
            font-weight: bold;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        
        .dropdown-item {
            padding: 8px 12px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
        }
        
        .dropdown-item.red {
            background: #ffebee;
            border-color: #ffcdd2;
        }
        
        .dropdown-item.blue {
            background: #e3f2fd;
            border-color: #bbdefb;
        }
        
        .dropdown-item.no-team {
            background: #fff3e0;
            border-color: #ffcc02;
        }
        
        .dropdown-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 3px;
            transition: background 0.2s;
        }
        
        .dropdown-button:hover {
            background: #0056b3;
        }
        
        .dropdown-button.danger {
            background: #dc3545;
        }
        
        .dropdown-button.danger:hover {
            background: #c82333;
        }
        
        .dropdown-button.success {
            background: #28a745;
        }
        
        .dropdown-button.success:hover {
            background: #218838;
        }
        
        .dropdown-button.warning {
            background: #ffc107;
            color: #333;
        }
        
        .dropdown-button.warning:hover {
            background: #e0a800;
        }
        
        .dropdown-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        
        .dropdown-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.8rem;
            word-break: break-all;
            border: 1px solid #ddd;
            font-family: monospace;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
        }
        
        .status-indicator.online {
            background: #28a745;
        }
        
        .status-indicator.offline {
            background: #dc3545;
        }
        
        .player-role {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #6c757d;
            color: white;
            margin-right: 5px;
        }
        
        .player-role.spy {
            background: #ffc107;
            color: #333;
        }
        
        .player-role.creator {
            background: #17a2b8;
        }
        
        /* Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ø±Ø¯ */
        .kick-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .kick-dialog.show {
            display: flex;
        }
        
        .kick-dialog-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .kick-dialog-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #dc3545;
        }
        
        .kick-dialog-message {
            font-size: 1rem;
            margin-bottom: 25px;
            color: #666;
            line-height: 1.5;
        }
        
        .kick-dialog-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .kick-dialog-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .kick-dialog-btn.confirm {
            background: #dc3545;
            color: white;
        }
        
        .kick-dialog-btn.confirm:hover {
            background: #c82333;
        }
        
        .kick-dialog-btn.cancel {
            background: #6c757d;
            color: white;
        }
        
        .kick-dialog-btn.cancel:hover {
            background: #5a6268;
        }

        /* ØªØµÙ…ÙŠÙ… Ù…ØªØ¬Ø§ÙˆØ¨ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2rem;
            }
            
            .cards-container {
                flex: 1;
                padding: 6px;
                margin-bottom: 6px;
            }
            
            .cards-grid {
                gap: 2px;
                height: 100%;
                width: 100%;
                overflow: hidden;
            }
            
            .card {
                font-size: clamp(0.3rem, 2.5vw, 0.6rem);
                padding: 1px;
            }
            
            .toolbar {
                font-size: 0.75rem;
                padding: 6px;
            }
            
            .dropdown-content {
                min-width: 280px;
                max-width: 90vw;
                left: 0;
                right: auto;
            }
            
            .container {
                padding: 0;
                height: 100vh;
                overflow: hidden;
            }
            
            .game-screen {
                padding: 4px;
                height: 100vh;
                overflow: hidden;
            }
            
            .team-panel, .log-panel {
                padding: 6px;
                font-size: 0.8rem;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±ÙŠÙ‚ */
        .team-choice:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .team-choice:active {
            transform: translateY(-1px);
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container"><div class="start-screen" id="startScreen"><input type="text" class="name-input" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="20"> <button class="start-btn" id="startGameButton" onclick="startGame()">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
   </div><div class="game-screen" id="gameScreen"><div class="toolbar">
     <div class="dropdown">
      <div class="player-name-btn" id="playerNameBtn" onclick="togglePlayerDropdown()"><span id="currentPlayerName"></span>
      </div>
      <div class="dropdown-content" id="playerDropdown">
       <div class="dropdown-header">
        Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
       </div>
       <div id="playerDropdownContent"></div>
      </div>
     </div>
     <div class="dropdown"><button class="toolbar-btn" onclick="toggleResetDropdown()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„</button>
      <div class="dropdown-content" id="resetDropdown">
       <div class="dropdown-header">
        Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©
       </div>
       <div id="resetDropdownContent"></div>
      </div>
     </div>
     <button class="toolbar-btn info" onclick="copyRoomLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
     
     <button class="toolbar-btn success" onclick="startGamePlay()" id="startGameBtn" style="display: none;">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
     <div class="dropdown">
      <div class="toolbar-item" id="playersCount" onclick="togglePlayersDropdown()">
       ğŸ‘¥ <span id="playerCountNum">0</span>
      </div>
      <div class="dropdown-content" id="playersDropdown">
       <div class="dropdown-header">
        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
       </div>
       <div id="playersDropdownContent"></div>
      </div>
     </div>
    </div>
    
    <div class="current-hint hidden" id="currentHint"></div>
    
    <div class="hint-display-area" id="hintDisplayArea" style="display: none;">
     <div class="hint-display-container">
      <div class="hint-box">
       <div class="hint-label">
        Ø§Ù„ØªÙ„Ù…ÙŠØ­:
       </div>
       <div class="hint-text" id="displayHintText">
        -
       </div>
      </div>
      <div class="number-box">
       <div class="number-label">
        Ø§Ù„Ø¹Ø¯Ø¯:
       </div>
       <div class="number-text" id="displayHintNumber">
        -
       </div>
      </div>
     </div>
    </div>
    
    <div class="hint-area" id="hintArea"><input type="text" class="hint-input" id="hintInput" placeholder="Ø§ÙƒØªØ¨ ØªÙ„Ù…ÙŠØ­Ùƒ Ù‡Ù†Ø§...">
     <div class="hint-controls"><span>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª:</span> <select id="numberSelect" class="number-select"> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> </select> <button class="send-hint-btn" onclick="sendHint()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­</button>
     </div>
    </div>
    
    <div class="end-turn-area" id="endTurnArea" style="display: none;"><button class="end-turn-btn" onclick="endTurn()">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±</button>
    </div>

    <div class="cards-container">
     <div class="cards-grid" id="cardsGrid"></div>
    </div>
    
    <div class="log-panel" id="logPanel" style="flex-shrink: 0; margin-bottom: 8px;">
        <div class="log-title"> Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« </div>
        <div id="gameLog"></div>
    </div>

    <div class="teams-bottom-area" style="display: flex; gap: 5px; height: 160px; flex-shrink: 0;">
        <div class="team-panel red" style="flex: 1;">
         <div class="team-title" style="color: #dc3545;"> Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± <span id="redScore">9</span>
         </div>
         <div class="team-section">
          <div class="section-title"> Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: </div>
          <div id="redPlayers"></div>
         </div>
         <div class="team-section">
          <div class="section-title"> Ø§Ù„Ø³Ø¨Ø§ÙŠ: </div>
          <div id="redSpies"></div>
         </div>
        </div>
        <div class="team-panel blue" style="flex: 1;">
         <div class="team-title" style="color: #007bff;"> Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚ <span id="blueScore">8</span>
         </div>
         <div class="team-section">
          <div class="section-title"> Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†: </div>
          <div id="bluePlayers"></div>
         </div>
         <div class="team-section">
          <div class="section-title"> Ø§Ù„Ø³Ø¨Ø§ÙŠ: </div>
          <div id="blueSpies"></div>
         </div>
        </div>
    </div>
    
   </div><div class="kick-dialog" id="kickDialog">
    <div class="kick-dialog-content">
     <div class="kick-dialog-title">
      âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ø±Ø¯
     </div>
     <div class="kick-dialog-message" id="kickDialogMessage"></div>
     <div class="kick-dialog-buttons"><button class="kick-dialog-btn confirm" onclick="confirmKick()">Ø·Ø±Ø¯</button> <button class="kick-dialog-btn cancel" onclick="cancelKick()">Ø¥Ù„ØºØ§Ø¡</button>
     </div>
    </div>
   </div>
  </div>
  <script>
 // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
 const firebaseConfig = {
  apiKey: "AIzaSyBLyoIoXp2aJCnhFqIFufMVBz0fzCS-FYY",
  authDomain: "game-303eb.firebaseapp.com",
  databaseURL: "https://game-303eb-default-rtdb.firebaseio.com",
  projectId: "game-303eb",
  storageBucket: "game-303eb.firebasestorage.app",
  messagingSenderId: "22261863844",
  appId: "1:22261863844:web:66f8541079b9025ec69d31",
  measurementId: "G-RKN2F3HVHS"
 };

 // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
 let database;
 let isFirebaseReady = false;
 let connectionAttempts = 0;
 const maxConnectionAttempts = 3;
 let showingColors = false;
 let roomCleanupInterval;

 // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
 function showConnectionStatus(message, isError = false) {
  // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ ÙÙ‚Ø·
  if (isError) {
   const startBtn = document.querySelector('.start-btn');
   if (startBtn) {
    startBtn.textContent = message;
    startBtn.style.background = '#dc3545';
   }
  }
 }

 // ØªÙ‡ÙŠØ¦Ø© Firebase Ù…Ø¹ ØªØ´Ø®ÙŠØµ Ù…ÙØµÙ„
 function initializeFirebase() {
  console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase...');
  try {
   if (typeof firebase === 'undefined') {
    throw new Error('Firebase SDK ØºÙŠØ± Ù…Ø­Ù…Ù„');
   }
   if (!firebase.apps.length) {
    console.log('ğŸ“± ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Firebase...');
    firebase.initializeApp(firebaseConfig);
   } else {
    console.log('ğŸ“± Firebase Ù…Ù‡ÙŠØ£ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
   }
   database = firebase.database();
   console.log('ğŸ’¾ ØªÙ… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø±Ø¬Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
   console.log('ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...');
   const testRef = database.ref('test');
   const testData = {
    timestamp: Date.now(),
    test: true
   };
   testRef.set(testData).then(() => {
    console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù†Ø¬Ø­');
    return testRef.once('value');
   }).then((snapshot) => {
    console.log('âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù†Ø¬Ø­:', snapshot.val());
    testRef.remove();
    isFirebaseReady = true;
    console.log('ğŸ‰ Firebase Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!');
    setupConnectionMonitoring();
    startRoomCleanup();
   }).catch((error) => {
    console.error('âŒ ÙØ´Ù„ Ø§Ø®ØªØ¨Ø§Ø± Firebase:', error);
    handleConnectionError(error);
   });
  } catch (error) {
   console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
   handleConnectionError(error);
  }
 }

 // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
 function setupConnectionMonitoring() {
  const connectedRef = database.ref('.info/connected');
  connectedRef.on('value', (snapshot) => {
   if (snapshot.val() === true) {
    console.log('ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ù€ Firebase');
    isFirebaseReady = true;
    updatePlayerOnlineStatus(true);
   } else {
    console.log('ğŸ”´ Ù…Ù†Ù‚Ø·Ø¹ Ø¹Ù† Firebase');
    isFirebaseReady = false;
   }
  });
 }

 // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØµØ§Ù„
 function updatePlayerOnlineStatus(isOnline) {
  if (database && roomId && currentPlayer) {
   database.ref(`rooms/${roomId}/players/${currentPlayer.id}/online`).set(isOnline);
  }
 }

 // Ø¨Ø¯Ø¡ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø©
 function startRoomCleanup() {
  if (roomCleanupInterval) {
   clearInterval(roomCleanupInterval);
  }
  roomCleanupInterval = setInterval(() => {
   cleanupInactiveRooms();
  }, 10 * 60 * 1000); // ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚
 }

 // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±Ù ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø©
 function cleanupInactiveRooms() {
  if (!database) return;
  const roomsRef = database.ref('rooms');
  roomsRef.once('value', (snapshot) => {
   if (!snapshot.exists()) return;
   const rooms = snapshot.val();
   const now = Date.now();
   const oneHour = 60 * 60 * 1000;
   Object.keys(rooms).forEach(roomId => {
    const room = rooms[roomId];
    if (!room.players) {
     // Ø­Ø°Ù Ø§Ù„ØºØ±Ù Ø¨Ø¯ÙˆÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ†
     database.ref(`rooms/${roomId}`).remove();
     return;
    }
    const players = Object.values(room.players);
    const hasOnlinePlayers = players.some(p => p.online);
    if (!hasOnlinePlayers) {
     // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¢Ø®Ø± Ù†Ø´Ø§Ø·
     const lastActivity = room.lastActivity || 0;
     if (now - lastActivity > oneHour) {
      console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ø§Ù„Ù†Ø´Ø·Ø©: ${roomId}`);
      database.ref(`rooms/${roomId}`).remove();
     }
    } else {
     // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ù†Ø´Ø§Ø· Ù„Ù„ØºØ±Ù Ø§Ù„Ù†Ø´Ø·Ø©
     database.ref(`rooms/${roomId}/lastActivity`).set(now);
    }
   });
  });
 }

 // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
 function handleConnectionError(error) {
  console.error('ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£:', {
   code: error.code,
   message: error.message,
   stack: error.stack
  });
  let errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
  if (error.code === 'PERMISSION_DENIED') {
   errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©';
   console.error('ğŸš« Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª - ØªØ­Ù‚Ù‚ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Firebase');
  } else if (error.code === 'NETWORK_ERROR' || error.message.includes('network')) {
   errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©';
   console.error('ğŸŒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©');
  } else if (error.message.includes('Firebase SDK')) {
   errorMessage = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
   console.error('ğŸ“¦ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Firebase SDK');
  }
  showConnectionStatus(errorMessage, true);
  isFirebaseReady = false;
  if (connectionAttempts < maxConnectionAttempts) {
   connectionAttempts++;
   console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${connectionAttempts}/${maxConnectionAttempts}`);
   setTimeout(() => {
    initializeFirebase();
   }, 3000 * connectionAttempts);
  } else {
   console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„');
   showConnectionStatus('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹', true);
  }
 }

 // Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
 document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸ“„ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Firebase...');
  initializeFirebase();
 });

 // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
 let currentPlayer = null;
 let roomId = null;
 let gameState = null;
 let cardsVisible = false;

 // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¹ Ø®Ù„Ø· Ù…ØªÙ‚Ø¯Ù…
 const gameWords = [
  'Ø´Ù…Ø³', 'Ù‚Ù…Ø±', 'Ù†Ø¬Ù…', 'Ø¨Ø­Ø±', 'Ø¬Ø¨Ù„', 'Ø´Ø¬Ø±', 'Ø²Ù‡Ø±', 'Ø·ÙŠØ±', 'Ø³Ù…Ùƒ', 'Ø£Ø³Ø¯', 'ÙÙŠÙ„', 'Ø­ØµØ§Ù†', 'ÙƒØªØ§Ø¨', 'Ù‚Ù„Ù…', 'ÙˆØ±Ù‚', 'Ø¨Ø§Ø¨', 'Ù†Ø§ÙØ°Ø©', 'ÙƒØ±Ø³ÙŠ', 'Ø·Ø§ÙˆÙ„Ø©', 'Ø³Ø±ÙŠØ±', 'Ù…Ø§Ø¡', 'Ù†Ø§Ø±', 'Ù‡ÙˆØ§Ø¡', 'ØªØ±Ø§Ø¨', 'Ø°Ù‡Ø¨', 'ÙØ¶Ø©', 'Ø­Ø¯ÙŠØ¯', 'Ø®Ø´Ø¨', 'Ø­Ø¬Ø±', 'Ø²Ø¬Ø§Ø¬', 'Ø³ÙŠØ§Ø±Ø©', 'Ø·Ø§Ø¦Ø±Ø©', 'Ù‚Ø·Ø§Ø±', 'Ø³ÙÙŠÙ†Ø©', 'Ø¯Ø±Ø§Ø¬Ø©', 'Ø­Ø§Ø³ÙˆØ¨', 'Ù‡Ø§ØªÙ', 'ØªÙ„ÙØ§Ø²', 'Ø±Ø§Ø¯ÙŠÙˆ', 'Ø³Ø§Ø¹Ø©', 'Ù…Ø¯Ø±Ø³Ø©', 'Ø¨ÙŠØª', 'Ù…Ø³ØªØ´ÙÙ‰', 'Ù…Ø·Ø¹Ù…', 'Ø­Ø¯ÙŠÙ‚Ø©', 'Ø´Ø§Ø±Ø¹', 'Ù…Ø¯ÙŠÙ†Ø©', 'Ù‚Ø±ÙŠØ©', 'ØµØ­Ø±Ø§Ø¡', 'ØºØ§Ø¨Ø©', 'Ø¹ÙŠÙ†', 'Ø£Ø°Ù†', 'ÙÙ…', 'ÙŠØ¯', 'Ù‚Ø¯Ù…', 'Ø±Ø£Ø³', 'Ù‚Ù„Ø¨', 'Ø¹Ù‚Ù„', 'Ø±ÙˆØ­', 'Ø¬Ø³Ù…', 'Ø£Ø¨', 'Ø£Ù…', 'Ø§Ø¨Ù†', 'Ø¨Ù†Øª', 'Ø£Ø®', 'Ø£Ø®Øª', 'Ø¬Ø¯', 'Ø¬Ø¯Ø©', 'Ø¹Ù…', 'Ø®Ø§Ù„', 'ØµØ¯ÙŠÙ‚', 'Ù…Ø¹Ù„Ù…', 'Ø·Ø¨ÙŠØ¨', 'Ù…Ù‡Ù†Ø¯Ø³', 'ÙÙ†Ø§Ù†', 'ÙƒØ§ØªØ¨', 'Ø´Ø§Ø¹Ø±', 'Ù…ØºÙ†ÙŠ', 'Ø±Ø§Ù‚Øµ', 'Ù„Ø§Ø¹Ø¨'
 ];

 // Ø®Ù„Ø· Ù…ØªÙ‚Ø¯Ù… Ù„Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
 function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
   const j = Math.floor(Math.random() * (i + 1));
   [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
 }

 // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
 function startGame() {
  const name = document.getElementById('playerName').value.trim();
  if (!name) {
   alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
   return;
  }
  console.log('ğŸ® Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
  console.log('ğŸ“Š Ø­Ø§Ù„Ø© Firebase:', {
   isFirebaseReady,
   database: !!database
  });
  const startBtn = document.querySelector('.start-btn');
  if (!isFirebaseReady || !database) {
   console.log('â³ Firebase ØºÙŠØ± Ø¬Ø§Ù‡Ø²ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„...');
   initializeFirebase();
   let attempts = 0;
   const maxAttempts = 15;
   const checkConnection = setInterval(() => {
    attempts++;
    console.log(`ğŸ”„ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ${attempts}/${maxAttempts}`);
    if (isFirebaseReady && database) {
     clearInterval(checkConnection);
     console.log('âœ… Firebase Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...');
     proceedWithGame(name);
    } else if (attempts >= maxAttempts) {
     clearInterval(checkConnection);
     console.error('âŒ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
     showConnectionStatus('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', true);
     const errorDetails = ` Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ğŸ” ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: - Firebase SDK: ${typeof firebase !== 'undefined' ? 'âœ… Ù…Ø­Ù…Ù„' : 'âŒ ØºÙŠØ± Ù…Ø­Ù…Ù„'} - Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${database ? 'âœ… Ù…ØªØ§Ø­Ø©' : 'âŒ ØºÙŠØ± Ù…ØªØ§Ø­Ø©'} - Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„: ${isFirebaseReady ? 'âœ… Ù…ØªØµÙ„' : 'âŒ ØºÙŠØ± Ù…ØªØµÙ„'} ğŸ’¡ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: 1. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª 2. Ø£Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© 3. Ø¬Ø±Ø¨ Ù…ØªØµÙØ­ Ø¢Ø®Ø± 4. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Firebase Ù…ÙØ¹Ø¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ `;
     alert(errorDetails);
    }
   }, 1000);
   return;
  }
  console.log('âœ… Firebase Ø¬Ø§Ù‡Ø²ØŒ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...');
  proceedWithGame(name);
 }

 // Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„
 function proceedWithGame(name) {
  localStorage.setItem('playerName', name);
  currentPlayer = {
   id: generateId(),
   name: name,
   online: true,
   team: null,
   role: 'player'
  };
  const roomFromUrl = getRoomIdFromUrl();
  if (roomFromUrl) {
   // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯
   leaveOldRoomsBeforeJoining();
   roomId = roomFromUrl;
   console.log('Joining existing room from URL:', roomId);
   joinExistingRoomDirectly();
  } else {
   roomId = generateRoomId();
   console.log('Creating new room:', roomId);
   joinRoom();
  }
  savePlayerState();
  console.log('Starting game with room ID:', roomId);
  console.log('Player:', currentPlayer);
  console.log('Database ready:', !!database);
  console.log('Firebase ready:', isFirebaseReady);
 }

 // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±Ù Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
 function leaveOldRoomsBeforeJoining() {
  const savedState = loadPlayerState();
  if (savedState && savedState.roomId && savedState.roomId !== roomId) {
   console.log('ğŸšª Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', savedState.roomId);
   database.ref(`rooms/${savedState.roomId}/players/${savedState.player.id}`).remove();
   localStorage.removeItem('gameState');
  }
 }

 // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
 function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
 }

 // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ©
 function generateRoomId() {
  return Math.random().toString(36).substr(2, 8);
 }

 // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
 function getRoomIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('room');
 }

 // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
 function updateStartButtonText() {
  const startButton = document.getElementById('startGameButton');
  const roomFromUrl = getRoomIdFromUrl();
  if (roomFromUrl) {
   startButton.textContent = 'Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØºØ±ÙØ©';
  } else {
   startButton.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©';
  }
 }

 // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©
 function joinRoom() {
  console.log('Joining room:', roomId);
  if (!database) {
   console.error('Database not initialized');
   alert('Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
   return;
  }
  const roomRef = database.ref(`rooms/${roomId}`);
  const timeoutId = setTimeout(() => {
   console.error('Room join timeout');
   alert('Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
  }, 15000);
  roomRef.once('value', (snapshot) => {
   clearTimeout(timeoutId);
   console.log('Room snapshot exists:', snapshot.exists());
   console.log('Room data:', snapshot.val());
   if (!snapshot.exists()) {
    console.log('Creating new room');
    createNewRoom();
   } else {
    console.log('Joining existing room');
    joinExistingRoom();
   }
  }).catch((error) => {
   clearTimeout(timeoutId);
   console.error('Error joining room:', error);
   console.error('Error details:', {
    code: error.code,
    message: error.message,
    details: error.details
   });
   if (error.code === 'PERMISSION_DENIED') {
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase.');
   } else if (error.code === 'NETWORK_ERROR') {
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
   } else {
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
   }
  });
 }

 // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
 function createNewRoom() {
  console.log('Creating new room with ID:', roomId);
  const shuffledWords = shuffleArray(gameWords);
  const cards = generateCards(shuffledWords);
  const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
  const initialState = {
   cards: cards,
   players: {},
   state: 'setup', // setup, playing, ended
   turn: firstTurn,
   score: {
    red: 8,
    blue: 8
   }, // 8 for blue, 9 for red or vice versa depending on who starts
   hint: {
    word: '',
    number: 0,
    team: '',
    guesses: 0
   },
   log: [],
   createdAt: Date.now(),
   lastActivity: Date.now(),
   winner: null,
   creatorId: currentPlayer.id,
   currentTurnAttempts: 0
  };
  if (firstTurn === 'red') {
   initialState.score.red = 9;
   initialState.score.blue = 8;
  } else {
   initialState.score.red = 8;
   initialState.score.blue = 9;
  }
  database.ref(`rooms/${roomId}`).set(initialState).then(() => {
   console.log('âœ… Room created successfully');
   addPlayerToRoom(true);
   setupRoomListeners();
   window.history.pushState({}, '', `?room=${roomId}`);
  }).catch(error => {
   console.error('âŒ Error creating room:', error);
   alert('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
  });
 }

 // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©
 function joinExistingRoom() {
  console.log('Joining existing room');
  database.ref(`rooms/${roomId}`).once('value').then(snapshot => {
   if (!snapshot.exists()) {
    alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
    window.location.href = window.location.origin + window.location.pathname;
    return;
   }
   const roomData = snapshot.val();
   if (roomData.state === 'playing') {
    // ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¹Ø¨Ø© Ø¬Ø§Ø±ÙŠØ© ÙˆÙ„ÙƒÙ† ÙƒÙ€ spectator Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
    addPlayerToRoom(false);
   } else {
    addPlayerToRoom(false);
   }
   setupRoomListeners();
  }).catch(error => {
   console.error('Error joining existing room:', error);
   alert('ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ' + error.message);
  });
 }

 // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
 function joinExistingRoomDirectly() {
  console.log('Attempting to join existing room directly');
  database.ref(`rooms/${roomId}`).once('value').then(snapshot => {
   if (!snapshot.exists()) {
    alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©.');
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„ØºØ±ÙØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    roomId = generateRoomId();
    window.history.pushState({}, '', window.location.pathname);
    createNewRoom();
    return;
   }
   addPlayerToRoom(false);
   setupRoomListeners();
  }).catch(error => {
   console.error('Error joining existing room directly:', error);
   alert('ÙØ´Ù„ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ' + error.message);
   window.history.pushState({}, '', window.location.pathname);
  });
 }

 // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù„ØºØ±ÙØ©
 function addPlayerToRoom(isCreator) {
  if (isCreator) {
   currentPlayer.role = 'creator';
  } else {
   // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
   const savedState = loadPlayerState();
   if (savedState && savedState.roomId === roomId && savedState.player.role) {
    currentPlayer.role = savedState.player.role;
    currentPlayer.team = savedState.player.team;
   }
  }

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const playerRef = database.ref(`rooms/${roomId}/players/${currentPlayer.id}`);
  playerRef.set(currentPlayer).then(() => {
   console.log('âœ… Player added to room');
   // Ø¹Ù†Ø¯ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© online Ø¥Ù„Ù‰ false
   playerRef.onDisconnect().update({
    online: false
   });
  }).catch(error => {
   console.error('âŒ Error adding player:', error);
  });
 }

 // Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„ØºØ±ÙØ©
 function removePlayerFromRoom(playerId) {
  if (!database || !roomId) return;
  database.ref(`rooms/${roomId}/players/${playerId}`).remove().then(() => {
   console.log(`âœ… Player ${playerId} removed`);
  }).catch(error => {
   console.error('âŒ Error removing player:', error);
  });
 }

 // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
 function generateCards(shuffledWords) {
  const numRed = 9;
  const numBlue = 8;
  const numBlack = 1;
  const numNeutral = 7;
  const totalCards = 25;

  const cards = [];
  let index = 0;

  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù„ÙˆØ§Ù†
  for (let i = 0; i < numRed; i++) cards.push({
   word: shuffledWords[index++],
   color: 'red',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numBlue; i++) cards.push({
   word: shuffledWords[index++],
   color: 'blue',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numBlack; i++) cards.push({
   word: shuffledWords[index++],
   color: 'black',
   revealed: false,
   voters: {}
  });
  for (let i = 0; i < numNeutral; i++) cards.push({
   word: shuffledWords[index++],
   color: 'neutral',
   revealed: false,
   voters: {}
  });

  // Ø®Ù„Ø· Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  shuffleArray(cards);

  // Ø¥Ø¶Ø§ÙØ© ÙÙ‡Ø±Ø³
  return cards.map((card, idx) => ({ ...card,
   id: idx
  }));
 }

 // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ØºØ±ÙØ©
 function setupRoomListeners() {
  console.log('Setting up room listeners for room:', roomId);
  const roomRef = database.ref(`rooms/${roomId}`);

  roomRef.on('value', (snapshot) => {
   const data = snapshot.val();
   if (data) {
    gameState = data;
    renderGame();
   } else {
    // Ø§Ù„ØºØ±ÙØ© Ù„Ù… ØªØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø©
    alert('Ø§Ù„ØºØ±ÙØ© Ù„Ù… ØªØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø©');
    window.location.href = window.location.origin + window.location.pathname;
   }
  }, (error) => {
   console.error('Error listening to room:', error);
  });
 }

 // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
 function savePlayerState() {
  const state = {
   roomId: roomId,
   player: currentPlayer
  };
  localStorage.setItem('gameState', JSON.stringify(state));
 }

 // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
 function loadPlayerState() {
  const state = localStorage.getItem('gameState');
  return state ? JSON.parse(state) : null;
 }

 // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø©
 function renderGame() {
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø§Ø´Ø©
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'flex';
  
  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const players = Object.values(gameState.players || {});
  const self = players.find(p => p.id === currentPlayer.id);
  if (self) {
   currentPlayer = self;
   savePlayerState(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
  } else {
   // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„ØºØ±ÙØ© (ØªÙ… Ø·Ø±Ø¯Ù‡ Ø£Ùˆ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©)
   if (gameState.players && !gameState.players[currentPlayer.id]) {
        alert('Ù„Ù‚Ø¯ ØªÙ… Ø·Ø±Ø¯Ùƒ Ù…Ù† Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ØºØ±ÙØ©.');
        window.location.href = window.location.origin + window.location.pathname;
        return;
   }
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª
  document.getElementById('currentPlayerName').textContent = currentPlayer.name;

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø¯Ø±Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)
  updatePlayersPanel();

  // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±
  updateToolbar();

  // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
  updateCardsGrid();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
  updateGameLog();

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
  updateScores();
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù…ÙŠØ­
  updateHintArea();
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
  checkGameEnd();
 }

 // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
 function updatePlayersPanel() {
    const players = Object.values(gameState.players || {});
    const redPlayersDiv = document.getElementById('redPlayers');
    const bluePlayersDiv = document.getElementById('bluePlayers');
    const noTeamPlayersDiv = document.getElementById('playersDropdownContent');
    const redSpiesDiv = document.getElementById('redSpies');
    const blueSpiesDiv = document.getElementById('blueSpies');
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    redPlayersDiv.innerHTML = '';
    bluePlayersDiv.innerHTML = '';
    noTeamPlayersDiv.innerHTML = '';
    redSpiesDiv.innerHTML = '';
    blueSpiesDiv.innerHTML = '';
    
    let allPlayersList = '';
    
    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    const redPlayers = players.filter(p => p.team === 'red' && p.role !== 'spy');
    const bluePlayers = players.filter(p => p.team === 'blue' && p.role !== 'spy');
    const redSpies = players.filter(p => p.team === 'red' && p.role === 'spy');
    const blueSpies = players.filter(p => p.team === 'blue' && p.role === 'spy');
    const noTeamPlayers = players.filter(p => !p.team);
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„ÙØ±Ù‚
    [...redPlayers, ...redSpies].forEach(p => {
        const item = createPlayerItem(p, redPlayersDiv);
        redPlayersDiv.appendChild(item);
    });
    
    [...bluePlayers, ...blueSpies].forEach(p => {
        const item = createPlayerItem(p, bluePlayersDiv);
        bluePlayersDiv.appendChild(item);
    });

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¨Ø§ÙŠ ÙÙŠ Ø£Ù‚Ø³Ø§Ù… Ù…Ø®ØµØµØ©
    redSpies.forEach(p => {
        const item = createPlayerItem(p, redSpiesDiv);
        redSpiesDiv.appendChild(item);
    });

    blueSpies.forEach(p => {
        const item = createPlayerItem(p, blueSpiesDiv);
        blueSpiesDiv.appendChild(item);
    });

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¯ÙˆÙ† ÙØ±ÙŠÙ‚ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    players.forEach(p => {
        allPlayersList += createDropdownPlayerItem(p);
    });
    noTeamPlayersDiv.innerHTML = allPlayersList;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    document.getElementById('playerCountNum').textContent = players.length;
 }

 // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù„Ø§Ø¹Ø¨
 function createPlayerItem(player, parentDiv) {
     const playerEl = document.createElement('div');
     playerEl.className = `player-item ${player.online ? 'online' : 'offline'} ${player.team || 'no-team'}`;
     
     let roleText = '';
     if (player.role === 'creator') {
         roleText = '<span class="player-role creator">Ø§Ù„Ù…Ù†Ø´Ø¦</span>';
     } else if (player.role === 'spy') {
         roleText = '<span class="player-role spy">Ø§Ù„Ø³Ø¨Ø§ÙŠ</span>';
     }
     
     let kickButton = '';
     if (currentPlayer.role === 'creator' && player.id !== currentPlayer.id) {
         kickButton = `<button class="kick-btn" onclick="showKickDialog('${player.id}', '${player.name}')">Ø·Ø±Ø¯</button>`;
     }
     
     playerEl.innerHTML = `
         <div style="display: flex; align-items: center;">
             ${player.name}
             ${roleText}
             <span class="status-indicator ${player.online ? 'online' : 'offline'}" title="${player.online ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}"></span>
         </div>
         ${kickButton}
     `;

     return playerEl;
 }

 // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
 function createDropdownPlayerItem(player) {
    const isSelf = player.id === currentPlayer.id;
    const isCreator = currentPlayer.role === 'creator';
    
    let teamButtons = '';
    if (isCreator && !isSelf) {
        teamButtons = `
            ${player.team !== 'red' ? `<button class="dropdown-button danger" onclick="setPlayerTeam('${player.id}', 'red')">ÙØ±ÙŠÙ‚ Ø£Ø­Ù…Ø±</button>` : ''}
            ${player.team !== 'blue' ? `<button class="dropdown-button" onclick="setPlayerTeam('${player.id}', 'blue')">ÙØ±ÙŠÙ‚ Ø£Ø²Ø±Ù‚</button>` : ''}
            ${player.role !== 'spy' ? `<button class="dropdown-button warning" onclick="setPlayerRole('${player.id}', 'spy')">ØªØ¹ÙŠÙŠÙ† ÙƒØ¬Ø§Ø³ÙˆØ³</button>` : ''}
            ${player.role === 'spy' ? `<button class="dropdown-button success" onclick="setPlayerRole('${player.id}', 'player')">ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ø§Ø¹Ø¨</button>` : ''}
            <button class="dropdown-button danger" onclick="showKickDialog('${player.id}', '${player.name}')">Ø·Ø±Ø¯</button>
        `;
    } else if (gameState.state === 'setup' && !player.team && !isSelf) {
        teamButtons = `
            <button class="dropdown-button danger" onclick="setPlayerTeam('${player.id}', 'red')">Ø§Ù†Ø¶Ù… Ø£Ø­Ù…Ø±</button>
            <button class="dropdown-button" onclick="setPlayerTeam('${player.id}', 'blue')">Ø§Ù†Ø¶Ù… Ø£Ø²Ø±Ù‚</button>
        `;
    }

    const roleText = player.role === 'spy' ? '<span class="player-role spy">Ø¬Ø§Ø³ÙˆØ³</span>' : (player.role === 'creator' ? '<span class="player-role creator">Ù…Ù†Ø´Ø¦</span>' : '<span class="player-role">Ù„Ø§Ø¹Ø¨</span>');
    const teamClass = player.team || 'no-team';

    return `
        <div class="dropdown-item ${teamClass}">
            <div style="display: flex; align-items: center; flex-direction: column; text-align: center;">
                <div style="font-weight: bold; margin-bottom: 5px;">
                    ${player.name} ${isSelf ? '(Ø£Ù†Øª)' : ''}
                    <span class="status-indicator ${player.online ? 'online' : 'offline'}" title="${player.online ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}"></span>
                </div>
                <div>
                    ${roleText} 
                    <span class="player-role" style="background: #333; color: white;">Ø§Ù„ÙØ±ÙŠÙ‚: ${player.team === 'red' ? 'Ø£Ø­Ù…Ø±' : (player.team === 'blue' ? 'Ø£Ø²Ø±Ù‚' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯')}</span>
                </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; justify-content: flex-end;">
                ${teamButtons}
            </div>
        </div>
    `;
 }

 // ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨
 function setPlayerRole(playerId, role) {
    if (currentPlayer.role !== 'creator') return;
    database.ref(`rooms/${roomId}/players/${playerId}/role`).set(role).then(() => {
        logEvent(currentPlayer.team, `${currentPlayer.name} Ø¹ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ ${gameState.players[playerId].name} ÙƒÙ€ ${role === 'spy' ? 'Ø¬Ø§Ø³ÙˆØ³' : 'Ù„Ø§Ø¹Ø¨ Ø¹Ø§Ø¯ÙŠ'}`);
    });
 }

 // ØªØ¹ÙŠÙŠÙ† ÙØ±ÙŠÙ‚ Ø§Ù„Ù„Ø§Ø¹Ø¨
 function setPlayerTeam(playerId, team) {
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ©ØŒ ÙŠÙ…ÙƒÙ†Ù‡ ØªØ¹ÙŠÙŠÙ† Ø£ÙŠ Ø´Ø®Øµ Ù„Ø£ÙŠ ÙØ±ÙŠÙ‚
    if (currentPlayer.role === 'creator') {
        database.ref(`rooms/${roomId}/players/${playerId}/team`).set(team).then(() => {
            logEvent(team, `${currentPlayer.name} Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${gameState.players[playerId].name} Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ ${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
        });
        database.ref(`rooms/${roomId}/players/${playerId}/role`).set('player'); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¯ÙˆØ± Ø¥Ù„Ù‰ Ù„Ø§Ø¹Ø¨ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±ÙŠÙ‚
        return;
    }
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†ÙØ³Ù‡ØŒ ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨
    if (playerId === currentPlayer.id && gameState.state === 'setup') {
        database.ref(`rooms/${roomId}/players/${playerId}/team`).set(team).then(() => {
            logEvent(team, `${currentPlayer.name} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„ÙØ±ÙŠÙ‚ ${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹ÙŠÙŠÙ† ÙƒØ¬Ø§Ø³ÙˆØ³ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù†Ù‚Øµ
            assignSpyRole(team);
        });
    }
 }

 // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¹ÙŠÙŠÙ† Ø¯ÙˆØ± Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
 function assignSpyRole(team) {
     const playersInTeam = Object.values(gameState.players || {}).filter(p => p.team === team && p.role !== 'spy');
     const spiesInTeam = Object.values(gameState.players || {}).filter(p => p.team === team && p.role === 'spy');
     const requiredSpies = Math.max(1, Math.floor((playersInTeam.length + spiesInTeam.length) / 3)); // Ù‚Ø§Ø¹Ø¯Ø© ØªÙ‚Ø±ÙŠØ¨ÙŠØ©
     
     // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ØŒ Ø¹ÙŠÙ† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙƒØ¬Ø§Ø³ÙˆØ³ Ø¨Ø´ÙƒÙ„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯
     if (spiesInTeam.length < requiredSpies) {
         if (playersInTeam.length > 0) {
             const playerToMakeSpy = playersInTeam[Math.floor(Math.random() * playersInTeam.length)];
             database.ref(`rooms/${roomId}/players/${playerToMakeSpy.id}/role`).set('spy').then(() => {
                 logEvent(team, `ØªÙ… ØªØ¹ÙŠÙŠÙ† ${playerToMakeSpy.name} ÙƒØ¬Ø§Ø³ÙˆØ³`);
             });
         }
     }
 }

 // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª
 function updateToolbar() {
     const startGameBtn = document.getElementById('startGameBtn');
     const players = Object.values(gameState.players || {});
     
     if (currentPlayer.role === 'creator' && gameState.state === 'setup') {
         // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¬Ø§Ø³ÙˆØ³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ ÙˆÙˆØ¬ÙˆØ¯ Ù…Ø§ ÙŠÙƒÙÙŠ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
         const redPlayers = players.filter(p => p.team === 'red');
         const bluePlayers = players.filter(p => p.team === 'blue');
         const hasSpies = redPlayers.some(p => p.role === 'spy') && bluePlayers.some(p => p.role === 'spy');
         const hasEnoughPlayers = redPlayers.length >= 2 && bluePlayers.length >= 2;
         
         if (hasSpies && hasEnoughPlayers) {
             startGameBtn.style.display = 'block';
             startGameBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©';
         } else {
             startGameBtn.style.display = 'block';
             startGameBtn.textContent = 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙØ±Ù‚ (Ø¬Ø§Ø³ÙˆØ³Ø§Ù† + 2 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚)';
         }
     } else {
         startGameBtn.style.display = 'none';
     }
 }

 // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
 function togglePlayerDropdown() {
    document.getElementById('playerDropdown').classList.toggle('show');
 }
 function toggleResetDropdown() {
    document.getElementById('resetDropdown').classList.toggle('show');
 }
 function togglePlayersDropdown() {
    document.getElementById('playersDropdown').classList.toggle('show');
 }

 // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø±ÙˆÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
 function copyRoomLink() {
     if (!roomId) {
         alert('Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø¹Ø¯.');
         return;
     }
     const roomUrl = window.location.origin + window.location.pathname + '?room=' + roomId;
     navigator.clipboard.writeText(roomUrl).then(() => {
         alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­!');
         console.log('Room link copied:', roomUrl);
     }).catch(err => {
         console.error('Failed to copy room link:', err);
         alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹: ' + roomUrl);
     });
 }

 // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨ (Ù…Ù† Ø§Ù„Ù…Ù†Ø´Ø¦)
 function startGamePlay() {
    if (currentPlayer.role !== 'creator' || gameState.state !== 'setup') return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„ÙØ±Ù‚ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    const players = Object.values(gameState.players || {});
    const redPlayers = players.filter(p => p.team === 'red');
    const bluePlayers = players.filter(p => p.team === 'blue');
    const hasSpies = redPlayers.some(p => p.role === 'spy') && bluePlayers.some(p => p.role === 'spy');
    const hasEnoughPlayers = redPlayers.length >= 2 && bluePlayers.length >= 2;
    
    if (!hasSpies || !hasEnoughPlayers) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¬Ø§Ø³ÙˆØ³ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆÙ„Ø§Ø¹Ø¨Ø§Ù† Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚.');
        return;
    }

    // ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨
    database.ref(`rooms/${roomId}/state`).set('playing').then(() => {
        logEvent(gameState.turn, `Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù† Ù„Ù„ÙØ±ÙŠÙ‚ ${gameState.turn === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
    });
 }

 // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©
 function resetGame(mode) {
    if (currentPlayer.role !== 'creator') return;

    if (mode === 'keep_cards') {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
        const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
        const initialScore = firstTurn === 'red' ? { red: 9, blue: 8 } : { red: 8, blue: 9 };

        database.ref(`rooms/${roomId}`).update({
            state: 'playing',
            turn: firstTurn,
            score: initialScore,
            hint: { word: '', number: 0, team: '', guesses: 0 },
            log: [],
            lastActivity: Date.now(),
            winner: null,
            currentTurnAttempts: 0
        }).then(() => {
            logEvent(firstTurn, 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª. Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚ ' + (firstTurn === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'));
        });
    } else if (mode === 'new_cards') {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        const shuffledWords = shuffleArray(gameWords);
        const newCards = generateCards(shuffledWords);
        const firstTurn = Math.random() < 0.5 ? 'red' : 'blue';
        const initialScore = firstTurn === 'red' ? { red: 9, blue: 8 } : { red: 8, blue: 9 };
        
        database.ref(`rooms/${roomId}`).update({
            cards: newCards,
            state: 'playing',
            turn: firstTurn,
            score: initialScore,
            hint: { word: '', number: 0, team: '', guesses: 0 },
            log: [],
            lastActivity: Date.now(),
            winner: null,
            currentTurnAttempts: 0
        }).then(() => {
            logEvent(firstTurn, 'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ø¯ÙˆØ± Ù„Ù„ÙØ±ÙŠÙ‚ ' + (firstTurn === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'));
        });
    }
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
    document.getElementById('resetDropdown').classList.remove('show');
 }

 // ØªØ­Ø¯ÙŠØ« Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
 function updateCardsGrid() {
  const grid = document.getElementById('cardsGrid');
  grid.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø¨ÙƒØ©
  
  if (!gameState || !gameState.cards) return;

  const isSpy = currentPlayer.role === 'spy';
  const myTeam = currentPlayer.team;
  const isMyTurn = gameState.turn === myTeam;
  const inPlayingState = gameState.state === 'playing';

  gameState.cards.forEach(card => {
   const cardEl = document.createElement('div');
   cardEl.className = 'card';
   cardEl.dataset.id = card.id;

   // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø§Ø³ÙˆØ³Ø§Ù‹ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
   if (isSpy) {
    cardEl.classList.add('spy-view', card.color);
   }

   // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù†Ù‡Ø§ØŒ Ø·Ø¨Ù‚ ØªØ±Ø§ÙƒØ¨ Ø§Ù„ÙƒØ´Ù
   if (card.revealed) {
    cardEl.classList.add('revealed');
    cardEl.style.background = card.color === 'black' ? '#343a40' : (card.color === 'red' ? '#dc3545' : (card.color === 'blue' ? '#007bff' : '#f5deb3'));
    cardEl.style.color = card.color === 'neutral' ? '#000000' : 'white';
   }

   // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù†Ù‡Ø§ Ø¨Ø¹Ø¯ØŒ Ø£Ø¶Ù Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù„Ù„ØªØµÙˆÙŠØª
   if (!card.revealed && inPlayingState && !isSpy && isMyTurn) {
    cardEl.classList.add('can-select');
    cardEl.onclick = () => voteForCard(card.id);
   }

   // Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
   const wordEl = document.createElement('div');
   wordEl.textContent = card.word;
   wordEl.style.flex = '1';
   wordEl.style.display = 'flex';
   wordEl.style.alignItems = 'center';
   wordEl.style.justifyContent = 'center';
   wordEl.style.width = '100%';
   wordEl.style.padding = '2px';
   cardEl.appendChild(wordEl);
   
   // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµÙˆØªÙŠÙ†
   if (card.voters && Object.keys(card.voters).length > 0) {
        const votersEl = document.createElement('div');
        votersEl.className = 'voters';
        const votersList = Object.keys(card.voters).map(voterId => {
             const voter = gameState.players[voterId];
             if (voter) {
                 return `<span class="voter ${voter.team}">${voter.name.substring(0, 1)}</span>`;
             }
             return '';
        }).join('');
        votersEl.innerHTML = `Ø§Ù„Ù…ØµÙˆØªÙˆÙ†: ${votersList}`;
        cardEl.appendChild(votersEl);
   }
   
   grid.appendChild(cardEl);
  });
 }
 
 // Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
 function voteForCard(cardId) {
     if (!database || !roomId || !currentPlayer.team) return;

     const cardRef = database.ref(`rooms/${roomId}/cards/${cardId}/voters/${currentPlayer.id}`);
     
     // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‚Ø¯ ØµÙˆØª Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ø³Ø­Ø¨ Ø§Ù„ØªØµÙˆÙŠØª
     if (gameState.cards[cardId].voters && gameState.cards[cardId].voters[currentPlayer.id]) {
         cardRef.remove();
         console.log(`Vote removed from card ${cardId}`);
     } else {
         // Ø§Ù„ØªØµÙˆÙŠØª
         cardRef.set(currentPlayer.team).then(() => {
             console.log(`Voted for card ${cardId}`);
             // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ø¹
             checkConsensus(cardId);
         });
     }
 }
 
 // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ø¹ ÙˆÙƒØ´Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
 function checkConsensus(cardId) {
     const card = gameState.cards[cardId];
     if (!card) return;
     
     const currentTurn = gameState.turn;
     const playersInTeam = Object.values(gameState.players || {}).filter(p => p.team === currentTurn && p.role !== 'spy' && p.online);
     const requiredVotes = playersInTeam.length; // ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ø¹Ø§Ù‹ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚
     
     const cardVoters = Object.keys(card.voters || {}).length;
     
     if (cardVoters >= requiredVotes && cardVoters > 0) {
         // ÙƒØ´Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
         revealCard(cardId, currentTurn);
     }
 }
 
 // ÙƒØ´Ù Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
 function revealCard(cardId, team) {
     if (gameState.state !== 'playing' || gameState.turn !== team || gameState.cards[cardId].revealed) return;
     
     const card = gameState.cards[cardId];
     const cardColor = card.color;
     const cardWord = card.word;
     let nextTurn = team;
     let gameEnded = false;

     database.ref(`rooms/${roomId}/cards/${cardId}/revealed`).set(true).then(() => {
        
        // Ù…Ø³Ø­ Ø§Ù„Ù…ØµÙˆØªÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ÙƒØ´Ù
        database.ref(`rooms/${roomId}/cards/${cardId}/voters`).remove();

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (cardColor === 'red') {
            database.ref(`rooms/${roomId}/score/red`).transaction(score => (score || 0) - 1);
            if (team === 'blue') nextTurn = 'red'; // ÙƒØ´Ù ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…ØŒ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±
        } else if (cardColor === 'blue') {
            database.ref(`rooms/${roomId}/score/blue`).transaction(score => (score || 0) - 1);
            if (team === 'red') nextTurn = 'blue'; // ÙƒØ´Ù ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…ØŒ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±
        } else if (cardColor === 'black') {
            // Ø§Ù„Ù‚Ø§ØªÙ„ - ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©
            gameEnded = true;
            database.ref(`rooms/${roomId}/winner`).set(team === 'red' ? 'blue' : 'red');
            nextTurn = team; // Ù„Ø§ ÙŠÙ‡Ù…
        } else {
            // Ù…Ø­Ø§ÙŠØ¯ - ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±
            nextTurn = team === 'red' ? 'blue' : 'red';
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¯Ø«
        logEvent(team, `${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} ÙƒØ´Ù Ø¨Ø·Ø§Ù‚Ø©: ${cardWord} (${cardColor === 'red' ? 'Ø£Ø­Ù…Ø±' : (cardColor === 'blue' ? 'Ø£Ø²Ø±Ù‚' : (cardColor === 'black' ? 'Ù‚Ø§ØªÙ„' : 'Ù…Ø­Ø§ÙŠØ¯'))})`);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯ÙˆØ±
        database.ref(`rooms/${roomId}/currentTurnAttempts`).transaction(attempts => (attempts || 0) + 1).then(({ snapshot }) => {
            const currentAttempts = snapshot.val();
            const maxGuesses = gameState.hint.number; // Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù‚Ø§ØªÙ„
            if (cardColor === 'black') {
                database.ref(`rooms/${roomId}/state`).set('ended');
            } else if (cardColor === team) {
                // ÙƒØ´Ù ÙØ±ÙŠÙ‚Ùƒ Ø¨Ù†Ø¬Ø§Ø­
                nextTurn = team; // ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¯ÙˆØ±
                
                // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
                const remainingTeamCards = gameState.cards.filter(c => c.color === team && !c.revealed).length;
                if (remainingTeamCards === 0) {
                    gameEnded = true;
                    database.ref(`rooms/${roomId}/winner`).set(team);
                    database.ref(`rooms/${roomId}/state`).set('ended');
                    nextTurn = team; // Ù„Ø§ ÙŠÙ‡Ù…
                }
                
                // ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡
                if (currentAttempts > maxGuesses) {
                    nextTurn = team === 'red' ? 'blue' : 'red'; // ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±
                    logEvent(team, `ØªØ¬Ø§ÙˆØ² ${team === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª (${currentAttempts - 1}/${maxGuesses}). ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±.`);
                }
            } else {
                // ÙƒØ´Ù ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ… Ø£Ùˆ Ù…Ø­Ø§ÙŠØ¯
                nextTurn = team === 'red' ? 'blue' : 'red'; // ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ø¯ÙˆØ±
                
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙƒØ´Ù Ø§Ù„Ù…Ø­Ø§ÙŠØ¯ Ø£Ùˆ ÙØ±ÙŠÙ‚ Ø§Ù„Ø®ØµÙ…ØŒ ØªØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                database.ref(`rooms/${roomId}/currentTurnAttempts`).set(0);
                
                if (!gameEnded) {
                    // Ø¥Ø°Ø§ Ù„Ù… ØªÙ†ØªÙ‡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù…ÙŠØ­
                    endTurnLogic(nextTurn, false); // false Ù„Ø¹Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
                }
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙ†ØªÙ‡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„ Ø£Ùˆ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†ØŒ Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±
            if (!gameEnded) {
                database.ref(`rooms/${roomId}/turn`).set(nextTurn);
            }
        });
     });
 }
 
 // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·
 function updateScores() {
    document.getElementById('redScore').textContent = gameState.score.red;
    document.getElementById('blueScore').textContent = gameState.score.blue;
 }

 // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­
 function sendHint() {
    if (gameState.state !== 'playing' || currentPlayer.role !== 'spy' || gameState.turn !== currentPlayer.team) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¢Ù†.');
        return;
    }
    
    const hintInput = document.getElementById('hintInput').value.trim();
    const numberSelect = document.getElementById('numberSelect').value;
    
    if (!hintInput) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ„Ù…ÙŠØ­.');
        return;
    }
    
    if (hintInput.split(/\s+/).length > 1) {
        alert('Ø§Ù„ØªÙ„Ù…ÙŠØ­ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙƒÙ„Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.');
        return;
    }

    const newHint = {
        word: hintInput,
        number: parseInt(numberSelect) + 1, // Ø§Ù„Ø¹Ø¯Ø¯ + Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ©
        team: currentPlayer.team,
        guesses: parseInt(numberSelect),
        timestamp: Date.now()
    };
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù…ÙŠØ­ ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ±
    database.ref(`rooms/${roomId}`).update({
        hint: newHint,
        currentTurnAttempts: 0 // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯ÙˆØ±
    }).then(() => {
        document.getElementById('hintInput').value = ''; // Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        logEvent(currentPlayer.team, `Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ ${currentPlayer.name} Ø£Ø¹Ø·Ù‰ ØªÙ„Ù…ÙŠØ­: "${hintInput}" Ù„Ù€ ${numberSelect} ÙƒÙ„Ù…Ø©`);
    });
 }

 // ØªØ­Ø¯ÙŠØ« Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªÙ„Ù…ÙŠØ­
 function updateHintArea() {
    const hintArea = document.getElementById('hintArea');
    const endTurnArea = document.getElementById('endTurnArea');
    const hintDisplayArea = document.getElementById('hintDisplayArea');
    const displayHintText = document.getElementById('displayHintText');
    const displayHintNumber = document.getElementById('displayHintNumber');
    
    const isSpy = currentPlayer.role === 'spy';
    const isMyTeam = gameState.turn === currentPlayer.team;
    const isPlaying = gameState.state === 'playing';
    
    // Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„/Ø§Ù„Ø¹Ø±Ø¶
    if (isPlaying) {
        if (isSpy && isMyTeam && !gameState.hint.word) {
            // Ø¬Ø§Ø³ÙˆØ³ Ø¯ÙˆØ±Ù‡ Ù‡Ùˆ Ø¥Ø¹Ø·Ø§Ø¡ ØªÙ„Ù…ÙŠØ­
            hintArea.style.display = 'block';
            endTurnArea.style.display = 'none';
            hintDisplayArea.style.display = 'none';
        } else if (gameState.hint.word) {
            // ØªÙ„Ù…ÙŠØ­ Ù…ÙˆØ¬ÙˆØ¯ - Ø¹Ø±Ø¶ Ø§Ù„ØªÙ„Ù…ÙŠØ­
            hintDisplayArea.style.display = 'block';
            hintArea.style.display = 'none';

            displayHintText.textContent = gameState.hint.word;
            // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ®Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
            const remainingGuesses = gameState.hint.number - gameState.currentTurnAttempts;
            displayHintNumber.textContent = remainingGuesses;

            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¯ÙˆØ± ÙØ±ÙŠÙ‚ÙŠ ÙˆÙ„ÙŠØ³ Ø£Ù†Ø§ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
            if (!isSpy && isMyTeam) {
                endTurnArea.style.display = 'block';
            } else {
                endTurnArea.style.display = 'none';
            }
        } else {
            // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ„Ù…ÙŠØ­ - Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬Ø§Ø³ÙˆØ³
            hintArea.style.display = 'none';
            endTurnArea.style.display = 'none';
            hintDisplayArea.style.display = 'none';
        }
    } else {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ùˆ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        hintArea.style.display = 'none';
        endTurnArea.style.display = 'none';
        hintDisplayArea.style.display = 'none';
    }
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ù„Ù…Ù†Ø´Ø¦ ÙÙ‚Ø·
    const resetDropdownContent = document.getElementById('resetDropdownContent');
    if (currentPlayer.role === 'creator') {
        resetDropdownContent.innerHTML = `
            <div class="dropdown-section">
                <div class="dropdown-section-title">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø©</div>
                <button class="dropdown-button success" onclick="resetGame('new_cards')">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¨Ø·Ø§Ù‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button class="dropdown-button warning" onclick="resetGame('keep_cards')">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</button>
                <button class="dropdown-button danger" onclick="confirmDeleteRoom()">Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
        `;
    } else {
        resetDropdownContent.innerHTML = '<div class="dropdown-info">ÙÙ‚Ø· Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ© ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©.</div>';
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
    const playerDropdownContent = document.getElementById('playerDropdownContent');
    playerDropdownContent.innerHTML = `
        <div class="dropdown-section">
            <div class="dropdown-section-title">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentPlayer.team === 'red' ? 'Ø£Ø­Ù…Ø±' : (currentPlayer.team === 'blue' ? 'Ø£Ø²Ø±Ù‚' : 'Ù„Ø§ ÙŠÙˆØ¬Ø¯')}</div>
            <button class="dropdown-button danger" onclick="setPlayerTeam('${currentPlayer.id}', 'red')">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±</button>
            <button class="dropdown-button" onclick="setPlayerTeam('${currentPlayer.id}', 'blue')">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚</button>
        </div>
        <div class="dropdown-section">
            <div class="dropdown-section-title">Ø¯ÙˆØ±Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentPlayer.role === 'spy' ? 'Ø§Ù„Ø¬Ø§Ø³ÙˆØ³' : (currentPlayer.role === 'creator' ? 'Ø§Ù„Ù…Ù†Ø´Ø¦' : 'Ø§Ù„Ù„Ø§Ø¹Ø¨')}</div>
            ${currentPlayer.role === 'creator' ? '<div class="dropdown-info">Ø£Ù†Øª Ù…Ù†Ø´Ø¦ Ø§Ù„ØºØ±ÙØ©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø¯ÙˆØ±Ùƒ Ø¥Ù„Ø§ Ø¨Ø§Ù„Ø§Ø³ØªÙ‚Ø§Ù„Ø©.</div>' : ''}
        </div>
        ${currentPlayer.role === 'creator' ? `<div class="dropdown-section"><button class="dropdown-button danger" onclick="confirmResignCreator()">Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø´Ø¦</button></div>` : ''}
    `;
 }

 // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
 function endTurn() {
     if (gameState.state !== 'playing' || currentPlayer.role === 'spy' || gameState.turn !== currentPlayer.team) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù†.');
        return;
    }
    
    const nextTurn = gameState.turn === 'red' ? 'blue' : 'red';
    endTurnLogic(nextTurn, true);
 }
 
 // Ù…Ù†Ø·Ù‚ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ±
 function endTurnLogic(nextTurn, logNewEvent) {
     database.ref(`rooms/${roomId}`).update({
        turn: nextTurn,
        hint: { word: '', number: 0, team: '', guesses: 0 },
        currentTurnAttempts: 0
    }).then(() => {
        if (logNewEvent) {
             logEvent(gameState.turn, `Ø£Ù†Ù‡Ù‰ ${gameState.turn === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'} Ø¯ÙˆØ±Ù‡. Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¢Ù† Ù„Ù€ ${nextTurn === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚'}`);
        }
    });
 }

 // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
 function logEvent(team, message) {
     const newLogEntry = {
        message: message,
        team: team,
        timestamp: Date.now()
    };
    
    const logRef = database.ref(`rooms/${roomId}/log`);
    logRef.limitToLast(50).once('value', snapshot => {
        let logs = snapshot.val() || [];
        if (!Array.isArray(logs)) {
            logs = Object.values(logs); // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        }
        logs.push(newLogEntry);
        
        // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ 50 Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
        if (logs.length > 50) {
            logs.shift();
        }
        
        logRef.set(logs);
    });
 }
 
 // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
 function updateGameLog() {
     const logDiv = document.getElementById('gameLog');
     logDiv.innerHTML = '';
     const logData = gameState.log || [];
     
     logData.forEach(entry => {
        const logEntryEl = document.createElement('div');
        logEntryEl.className = `log-entry ${entry.team}`;
        const time = new Date(entry.timestamp).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        logEntryEl.innerHTML = `<strong>[${time}]</strong> ${entry.message}`;
        logDiv.appendChild(logEntryEl);
     });
     
     // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
     logDiv.scrollTop = logDiv.scrollHeight;
 }

 // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©
 function checkGameEnd() {
    if (gameState.state === 'playing') {
        const redRemaining = gameState.cards.filter(c => c.color === 'red' && !c.revealed).length;
        const blueRemaining = gameState.cards.filter(c => c.color === 'blue' && !c.revealed).length;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„Ù†Ù‚Ø§Ø·
        if (redRemaining === 0) {
            database.ref(`rooms/${roomId}/winner`).set('red');
            database.ref(`rooms/${roomId}/state`).set('ended');
            return;
        }
        if (blueRemaining === 0) {
            database.ref(`rooms/${roomId}/winner`).set('blue');
            database.ref(`rooms/${roomId}/state`).set('ended');
            return;
        }
    }
    
    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    if (gameState.state === 'ended' && gameState.winner) {
        const winnerTeam = gameState.winner === 'red' ? 'Ø§Ù„Ø£Ø­Ù…Ø±' : 'Ø§Ù„Ø£Ø²Ø±Ù‚';
        alert(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ ${winnerTeam}!`);
        // ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
        document.getElementById('currentHint').classList.remove('hidden');
        document.getElementById('currentHint').textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ø§Ù„ÙØ§Ø¦Ø² Ù‡Ùˆ Ø§Ù„ÙØ±ÙŠÙ‚ ${winnerTeam}!`;
    } else {
        document.getElementById('currentHint').classList.add('hidden');
    }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
    if (gameState.state === 'ended' && currentPlayer.role === 'creator') {
        document.getElementById('startGameBtn').style.display = 'block';
        document.getElementById('startGameBtn').textContent = 'Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    }
 }

 // Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ø±Ø¯
 let playerToKick = null;

 function showKickDialog(playerId, playerName) {
     if (currentPlayer.role !== 'creator' || playerId === currentPlayer.id) return;

     playerToKick = playerId;
     document.getElementById('kickDialogMessage').textContent = `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${playerName} Ù…Ù† Ø§Ù„ØºØ±ÙØ©ØŸ`;
     document.getElementById('kickDialog').classList.add('show');
 }

 function cancelKick() {
     playerToKick = null;
     document.getElementById('kickDialog').classList.remove('show');
 }

 function confirmKick() {
     if (playerToKick) {
         database.ref(`rooms/${roomId}/players/${playerToKick}`).remove().then(() => {
             logEvent('system', `ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ ${gameState.players[playerToKick].name} Ø¨ÙˆØ§Ø³Ø·Ø© ${currentPlayer.name}`);
             playerToKick = null;
             cancelKick();
         });
     }
 }
 
 // ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©
 function confirmDeleteRoom() {
     if (currentPlayer.role !== 'creator') return;
     if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
         database.ref(`rooms/${roomId}`).remove().then(() => {
             alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
             window.location.href = window.location.origin + window.location.pathname;
         });
     }
 }

 // Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø´Ø¦
 function confirmResignCreator() {
    if (currentPlayer.role !== 'creator') return;
    const players = Object.values(gameState.players || {}).filter(p => p.id !== currentPlayer.id && p.online);
    
    if (players.length === 0) {
        alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¢Ù† Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ù…ØªØµÙ„ÙˆÙ† ÙÙŠ Ø§Ù„ØºØ±ÙØ©.');
        return;
    }
    
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ®Ù„ÙŠ Ø¹Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø´Ø¦ØŸ Ø³ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø´Ø¦ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¢Ø®Ø±.')) {
        // ØªØ¹ÙŠÙŠÙ† Ù…Ù†Ø´Ø¦ Ø¬Ø¯ÙŠØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        const newCreator = players[Math.floor(Math.random() * players.length)];
        
        database.ref(`rooms/${roomId}/players/${currentPlayer.id}/role`).set('player').then(() => {
            database.ref(`rooms/${roomId}/creatorId`).set(newCreator.id).then(() => {
                database.ref(`rooms/${roomId}/players/${newCreator.id}/role`).set('creator').then(() => {
                    logEvent('system', `${currentPlayer.name} ØªØ®Ù„Ù‰ Ø¹Ù† Ø¯ÙˆØ± Ø§Ù„Ù…Ù†Ø´Ø¦. ${newCreator.name} Ù‡Ùˆ Ø§Ù„Ù…Ù†Ø´Ø¦ Ø§Ù„Ø¬Ø¯ÙŠØ¯.`);
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ¯ÙˆØ± Ø§Ù„Ù„Ø§Ø¹Ø¨
                    currentPlayer.role = 'player';
                    savePlayerState();
                    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
                    document.getElementById('playerDropdown').classList.remove('show');
                });
            });
        });
    }
 }
 
 // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
 window.addEventListener('online', function() {
  console.log('Connection restored');
  updatePlayerOnlineStatus(true);
 });

 window.addEventListener('offline', function() {
  console.log('Connection lost');
 });

 // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØµÙØ­ (Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨)
 document.addEventListener('visibilitychange', function() {
  if (database && roomId && currentPlayer) {
   const isVisible = !document.hidden;
   updatePlayerOnlineStatus(isVisible);
  }
 });

 console.log('ğŸ® Ù…Ø±Ø§Ø¨Ø· - ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª');
 </script>
 <script>
 (function() {
  function c() {
   var b = a.contentDocument || a.contentWindow.document;
   if (b) {
    var d = b.createElement('script');
    d.innerHTML = "window.__CF$cv$params={r:'9903ff4bb2ecd60a',t:'MTc2MDc0ODE2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
    b.getElementsByTagName('head')[0].appendChild(d)
   }
  }
  if (document.body) {
   var a = document.createElement('iframe');
   a.height = 1;
   a.width = 1;
   a.style.position = 'absolute';
   a.style.top = 0;
   a.style.left = 0;
   a.style.border = 'none';
   a.style.visibility = 'hidden';
   document.body.appendChild(a);
   if ('loading' !== document.readyState) c();
   else if (window.addEventListener) window.addEventListener('load', c);
   else window.attachEvent('onload', c);
  }
 })();
 </script>
 </body>
</html>
